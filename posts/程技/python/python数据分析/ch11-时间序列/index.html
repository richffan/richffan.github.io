<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="第十一章 时间序列 - https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch11-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/">
    <meta name="author" content="richfan - https://richfan.site/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>第十一章 时间序列</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://richfan.site/style.min.d252ad53a5e6b2ae6b8c6c1661107189be3668e36c8dd61697bbe008595a7e04.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"isSingleColumnOfPostList": true,
		"hasFoldAllCodeBlocks": false,
		"svgColor": "",
		"en": false,
		"dark": true
	}
</div>
    <h1 class="title">
        
            第十一章 时间序列
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill="#6c757d" p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill="#6c757d"></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill="#6c757d"></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill="#6c757d" p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill="#6c757d" p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill="#6c757d" p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill="#6c757d" p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill="#6c757d"></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">















<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2023-09-25&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2023-09-25&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            13922 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            28 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/%E7%A8%8B%E6%8A%80">程技</a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/python">python</a>
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch06-%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%AD%98%E5%82%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch13-python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#111-日期和时间数据类型及工具">11.1 日期和时间数据类型及工具</a>
      <ul>
        <li><a href="#1111-字符串和datetime的相互转换">11.1.1 字符串和datetime的相互转换</a></li>
      </ul>
    </li>
    <li><a href="#112-时间序列基础">11.2 时间序列基础</a>
      <ul>
        <li><a href="#1121-索引选取子集构造">11.2.1 索引、选取、子集构造</a></li>
        <li><a href="#1122-带有重复索引的时间序列">11.2.2 带有重复索引的时间序列</a></li>
      </ul>
    </li>
    <li><a href="#113-日期的范围频率以及移动">11.3 日期的范围、频率以及移动</a>
      <ul>
        <li><a href="#1131-生成日期范围">11.3.1 生成日期范围</a></li>
        <li><a href="#1132-频率和日期偏移量">11.3.2 频率和日期偏移量</a></li>
        <li><a href="#1133-wom日期">11.3.3 WOM日期</a></li>
        <li><a href="#1134-移动超前和滞后数据">11.3.4 移动（超前和滞后）数据</a></li>
        <li><a href="#1135-通过偏移量对日期进行位移">11.3.5 通过偏移量对日期进行位移</a></li>
      </ul>
    </li>
    <li><a href="#114-时区处理">11.4 时区处理</a>
      <ul>
        <li><a href="#1141-时区本地化和转换">11.4.1 时区本地化和转换</a></li>
        <li><a href="#1142-操作时区意识型timestamp对象">11.4.2 操作时区意识型Timestamp对象</a></li>
        <li><a href="#1143-不同时区之间的运算">11.4.3 不同时区之间的运算</a></li>
      </ul>
    </li>
    <li><a href="#115-时期及其算术运算">11.5 时期及其算术运算</a>
      <ul>
        <li><a href="#1151-时期的频率转换">11.5.1 时期的频率转换</a></li>
        <li><a href="#1152-按季度计算的时期频率">11.5.2 按季度计算的时期频率</a></li>
        <li><a href="#1153-将timestamp转换为period及其反向过程">11.5.3 将Timestamp转换为Period（及其反向过程）</a></li>
        <li><a href="#1154-通过数组创建periodindex">11.5.4 通过数组创建PeriodIndex</a></li>
      </ul>
    </li>
    <li><a href="#116-重采样及频率转换">11.6 重采样及频率转换</a>
      <ul>
        <li><a href="#1161-降采样">11.6.1 降采样</a></li>
        <li><a href="#1162-通过时期进行重采样">11.6.2 通过时期进行重采样</a></li>
      </ul>
    </li>
    <li><a href="#117-移动窗口函数">11.7 移动窗口函数</a>
      <ul>
        <li><a href="#1171-指数加权函数">11.7.1 指数加权函数</a></li>
        <li><a href="#1172-二元移动窗口函数">11.7.2 二元移动窗口函数</a></li>
        <li><a href="#1173-用户定义的移动窗口函数">11.7.3 用户定义的移动窗口函数</a></li>
      </ul>
    </li>
    <li><a href="#118-总结">11.8 总结</a></li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <p>时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等。在多个时间点观察或测量到的任何事物都可以形成一段时间序列。很多时间序列是<code>固定频率</code>的，也就是说，数据点是根据某种规律定期出现的（比如每15秒、每5分钟、每月出现一次）。时间序列也可以是不定期的，没有固定的时间单位或单位之间的偏移量。时间序列数据的意义取决于具体的应用场景，主要有以下几种：</p>
<ul>
<li>时间戳（timestamp），特定的时刻。</li>
<li>固定时期（period），如2007年1月或2010年全年。</li>
<li>时间间隔（interval），由起始和结束时间戳表示。时期（period）可以被看做间隔（interval）的特例。</li>
<li>实验或过程时间，每个时间点都是相对于特定起始时间的一个度量。例如，从放入烤箱时起，每秒钟饼干的直径。</li>
</ul>
<p>本章主要讲解前3种时间序列。许多技术都可用于处理实验型时间序列，其索引可能是一个整数或浮点数（表示从实验开始算起已经过去的时间）。最简单也最常见的时间序列都是用时间戳进行索引的。</p>
<blockquote>
<p>提示：pandas也支持基于timedeltas的指数，它可以有效代表实验或经过的时间。这本书不涉及timedelta指数，但你可以学习pandas的文档（http://pandas.pydata.org/）。</p>
</blockquote>
<p>pandas提供了许多内置的时间序列处理工具和数据算法。因此，你可以高效处理非常大的时间序列，轻松地进行切片/切块、聚合、对定期/不定期的时间序列进行重采样等。有些工具特别适合金融和经济应用，你当然也可以用它们来分析服务器日志数据。</p>
<h2 id="111-日期和时间数据类型及工具">11.1 日期和时间数据类型及工具</h2>
<p>Python标准库包含用于日期（date）和时间（time）数据的数据类型，而且还有日历方面的功能。我们主要会用到datetime、time以及calendar模块。datetime.datetime（也可以简写为datetime）是用得最多的数据类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">10</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="color:#000;font-weight:bold">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">11</span>]: now <span style="color:#000;font-weight:bold">=</span> datetime<span style="color:#000;font-weight:bold">.</span>now()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">12</span>]: now
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">12</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2017</span>, <span style="color:#099">9</span>, <span style="color:#099">25</span>, <span style="color:#099">14</span>, <span style="color:#099">5</span>, <span style="color:#099">52</span>, <span style="color:#099">72973</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">13</span>]: now<span style="color:#000;font-weight:bold">.</span>year, now<span style="color:#000;font-weight:bold">.</span>month, now<span style="color:#000;font-weight:bold">.</span>day
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">13</span>]: (<span style="color:#099">2017</span>, <span style="color:#099">9</span>, <span style="color:#099">25</span>)
</span></span></code></pre></div><p>datetime以毫秒形式存储日期和时间。timedelta表示两个datetime对象之间的时间差：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">14</span>]: delta <span style="color:#000;font-weight:bold">=</span> datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">7</span>) <span style="color:#000;font-weight:bold">-</span> datetime(<span style="color:#099">2008</span>, <span style="color:#099">6</span>, <span style="color:#099">24</span>, <span style="color:#099">8</span>, <span style="color:#099">15</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">15</span>]: delta
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">15</span>]: datetime<span style="color:#000;font-weight:bold">.</span>timedelta(<span style="color:#099">926</span>, <span style="color:#099">56700</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">16</span>]: delta<span style="color:#000;font-weight:bold">.</span>days
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">16</span>]: <span style="color:#099">926</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">17</span>]: delta<span style="color:#000;font-weight:bold">.</span>seconds
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">17</span>]: <span style="color:#099">56700</span>
</span></span></code></pre></div><p>可以给datetime对象加上（或减去）一个或多个timedelta，这样会产生一个新对象：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">18</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="color:#000;font-weight:bold">import</span> timedelta
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">19</span>]: start <span style="color:#000;font-weight:bold">=</span> datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">7</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">20</span>]: start <span style="color:#000;font-weight:bold">+</span> timedelta(<span style="color:#099">12</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">20</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">19</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">21</span>]: start <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">2</span> <span style="color:#000;font-weight:bold">*</span> timedelta(<span style="color:#099">12</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">21</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2010</span>, <span style="color:#099">12</span>, <span style="color:#099">14</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span></code></pre></div><p>datetime模块中的数据类型参见表10-1。虽然本章主要讲的是pandas数据类型和高级时间序列处理，但你肯定会在Python的其他地方遇到有关datetime的数据类型。</p>
<p>表11-1 datetime模块中的数据类型</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201030161247046.png" alt=""></p>
<p>tzinfo  存储时区信息的基本类型</p>
<h3 id="1111-字符串和datetime的相互转换">11.1.1 字符串和datetime的相互转换</h3>
<p>利用str或strftime方法（传入一个格式化字符串），datetime对象和pandas的Timestamp对象（稍后就会介绍）可以被格式化为字符串：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">22</span>]: stamp <span style="color:#000;font-weight:bold">=</span> datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">23</span>]: <span style="color:#0086b3">str</span>(stamp)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">23</span>]: <span style="color:#d14">&#39;2011-01-03 00:00:00&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">24</span>]: stamp<span style="color:#000;font-weight:bold">.</span>strftime(<span style="color:#d14">&#39;%Y-%m-</span><span style="color:#d14">%d</span><span style="color:#d14">&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">24</span>]: <span style="color:#d14">&#39;2011-01-03&#39;</span>
</span></span></code></pre></div><p>表11-2列出了全部的格式化编码。</p>
<p>表11-2 datetime格式定义（兼容ISO C89）</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201030161432640.png" alt=""></p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201030161423963.png" alt=""></p>
<p>datetime.strptime可以用这些格式化编码将字符串转换为日期：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">25</span>]: value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;2011-01-03&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">26</span>]: datetime<span style="color:#000;font-weight:bold">.</span>strptime(value, <span style="color:#d14">&#39;%Y-%m-</span><span style="color:#d14">%d</span><span style="color:#d14">&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">26</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">3</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">27</span>]: datestrs <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;7/6/2011&#39;</span>, <span style="color:#d14">&#39;8/6/2011&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">28</span>]: [datetime<span style="color:#000;font-weight:bold">.</span>strptime(x, <span style="color:#d14">&#39;%m/</span><span style="color:#d14">%d</span><span style="color:#d14">/%Y&#39;</span>) <span style="color:#000;font-weight:bold">for</span> x <span style="color:#000;font-weight:bold">in</span> datestrs]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">28</span>]: 
</span></span><span style="display:flex;"><span>[datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">7</span>, <span style="color:#099">6</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>),
</span></span><span style="display:flex;"><span> datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">8</span>, <span style="color:#099">6</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)]
</span></span></code></pre></div><p>datetime.strptime是通过已知格式进行日期解析的最佳方式。但是每次都要编写格式定义是很麻烦的事情，尤其是对于一些常见的日期格式。这种情况下，你可以用dateutil这个第三方包中的parser.parse方法（pandas中已经自动安装好了）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">29</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">dateutil.parser</span> <span style="color:#000;font-weight:bold">import</span> parse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">30</span>]: parse(<span style="color:#d14">&#39;2011-01-03&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">30</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">3</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span></code></pre></div><p>dateutil可以解析几乎所有人类能够理解的日期表示形式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">31</span>]: parse(<span style="color:#d14">&#39;Jan 31, 1997 10:45 PM&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">31</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">1997</span>, <span style="color:#099">1</span>, <span style="color:#099">31</span>, <span style="color:#099">22</span>, <span style="color:#099">45</span>)
</span></span></code></pre></div><p>在国际通用的格式中，日出现在月的前面很普遍，传入dayfirst=True即可解决这个问题：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">32</span>]: parse(<span style="color:#d14">&#39;6/12/2011&#39;</span>, dayfirst<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">32</span>]: datetime<span style="color:#000;font-weight:bold">.</span>datetime(<span style="color:#099">2011</span>, <span style="color:#099">12</span>, <span style="color:#099">6</span>, <span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span></code></pre></div><p>pandas通常是用于处理成组日期的，不管这些日期是DataFrame的轴索引还是列。to_datetime方法可以解析多种不同的日期表示形式。对标准日期格式（如ISO8601）的解析非常快：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">33</span>]: datestrs <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;2011-07-06 12:00:00&#39;</span>, <span style="color:#d14">&#39;2011-08-06 00:00:00&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">34</span>]: pd<span style="color:#000;font-weight:bold">.</span>to_datetime(datestrs)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">34</span>]: DatetimeIndex([<span style="color:#d14">&#39;2011-07-06 12:00:00&#39;</span>, <span style="color:#d14">&#39;2011-08-06 00:00:00&#39;</span>], dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;dat</span>
</span></span><span style="display:flex;"><span>etime64[ns]<span style="color:#d14">&#39;, freq=None)</span>
</span></span></code></pre></div><p>它还可以处理缺失值（None、空字符串等）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">35</span>]: idx <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>to_datetime(datestrs <span style="color:#000;font-weight:bold">+</span> [<span style="color:#000;font-weight:bold">None</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">36</span>]: idx
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">36</span>]: DatetimeIndex([<span style="color:#d14">&#39;2011-07-06 12:00:00&#39;</span>, <span style="color:#d14">&#39;2011-08-06 00:00:00&#39;</span>, <span style="color:#d14">&#39;NaT&#39;</span>], dty
</span></span><span style="display:flex;"><span>pe<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">37</span>]: idx[<span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">37</span>]: NaT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">38</span>]: pd<span style="color:#000;font-weight:bold">.</span>isnull(idx)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">38</span>]: array([<span style="color:#000;font-weight:bold">False</span>, <span style="color:#000;font-weight:bold">False</span>,  <span style="color:#000;font-weight:bold">True</span>], dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">bool</span>)
</span></span></code></pre></div><p>NaT（Not a Time）是pandas中时间戳数据的null值。</p>
<blockquote>
<p>注意：dateutil.parser是一个实用但不完美的工具。比如说，它会把一些原本不是日期的字符串认作是日期（比如&quot;42&quot;会被解析为2042年的今天）。</p>
</blockquote>
<p>datetime对象还有一些特定于当前环境（位于不同国家或使用不同语言的系统）的格式化选项。例如，德语或法语系统所用的月份简写就与英语系统所用的不同。表11-3进行了总结。</p>
<p>表11-3 特定于当前环境的日期格式</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201030161919403.png" alt=""></p>
<h2 id="112-时间序列基础">11.2 时间序列基础</h2>
<p>pandas最基本的时间序列类型就是以时间戳（通常以Python字符串或datatime对象表示）为索引的Series：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">39</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="color:#000;font-weight:bold">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">40</span>]: dates <span style="color:#000;font-weight:bold">=</span> [datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">2</span>), datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">5</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:          datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">7</span>), datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">8</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:          datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">10</span>), datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">12</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">41</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">6</span>), index<span style="color:#000;font-weight:bold">=</span>dates)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">42</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">42</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.204708</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">0.478943</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.965781</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>    <span style="color:#099">1.393406</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>这些datetime对象实际上是被放在一个DatetimeIndex中的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">43</span>]: ts<span style="color:#000;font-weight:bold">.</span>index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">43</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2011-01-02&#39;</span>, <span style="color:#d14">&#39;2011-01-05&#39;</span>, <span style="color:#d14">&#39;2011-01-07&#39;</span>, <span style="color:#d14">&#39;2011-01-08&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2011-01-10&#39;</span>, <span style="color:#d14">&#39;2011-01-12&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">None</span>)
</span></span></code></pre></div><p>跟其他Series一样，不同索引的时间序列之间的算术运算会自动按日期对齐：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">44</span>]: ts <span style="color:#000;font-weight:bold">+</span> ts[::<span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">44</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.409415</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.038877</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">3.931561</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>         NaN
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>ts[::2] 是每隔两个取一个。</p>
<p>pandas用NumPy的datetime64数据类型以纳秒形式存储时间戳：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">45</span>]: ts<span style="color:#000;font-weight:bold">.</span>index<span style="color:#000;font-weight:bold">.</span>dtype
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">45</span>]: dtype(<span style="color:#d14">&#39;&lt;M8[ns]&#39;</span>)
</span></span></code></pre></div><p>DatetimeIndex中的各个标量值是pandas的Timestamp对象：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">46</span>]: stamp <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>index[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">47</span>]: stamp
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">47</span>]: Timestamp(<span style="color:#d14">&#39;2011-01-02 00:00:00&#39;</span>)
</span></span></code></pre></div><p>只要有需要，TimeStamp可以随时自动转换为datetime对象。此外，它还可以存储频率信息（如果有的话），且知道如何执行时区转换以及其他操作。稍后将对此进行详细讲解。</p>
<h3 id="1121-索引选取子集构造">11.2.1 索引、选取、子集构造</h3>
<p>当你根据标签索引选取数据时，时间序列和其它的pandas.Series很像：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">48</span>]: stamp <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>index[<span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">49</span>]: ts[stamp]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">49</span>]: <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.51943871505673811</span>
</span></span></code></pre></div><p>还有一种更为方便的用法：传入一个可以被解释为日期的字符串：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">50</span>]: ts[<span style="color:#d14">&#39;1/10/2011&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">50</span>]: <span style="color:#099">1.9657805725027142</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">51</span>]: ts[<span style="color:#d14">&#39;20110110&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">51</span>]: <span style="color:#099">1.9657805725027142</span>
</span></span></code></pre></div><p>对于较长的时间序列，只需传入“年”或“年月”即可轻松选取数据的切片：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">52</span>]: longer_ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">1000</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                       index<span style="color:#000;font-weight:bold">=</span>pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/1/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1000</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">53</span>]: longer_ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">53</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0.092908</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">0.281746</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.769023</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>    <span style="color:#099">1.246435</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">1.007189</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.296221</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>    <span style="color:#099">0.274992</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>    <span style="color:#099">0.228913</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>    <span style="color:#099">1.352917</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">0.886429</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">...</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">17</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.139298</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">18</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.159926</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">19</span>    <span style="color:#099">0.618965</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">20</span>    <span style="color:#099">1.373890</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">21</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.983505</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">22</span>    <span style="color:#099">0.930944</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.811676</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">24</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.830156</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">25</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.138730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">26</span>    <span style="color:#099">0.334088</span>
</span></span><span style="display:flex;"><span>Freq: D, Length: <span style="color:#099">1000</span>, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">54</span>]: longer_ts[<span style="color:#d14">&#39;2001&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">54</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">1.599534</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">0.474071</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.151326</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.542173</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.475496</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>    <span style="color:#099">0.106403</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.308228</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>    <span style="color:#099">2.173185</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>    <span style="color:#099">0.564561</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.190481</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">...</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">22</span>    <span style="color:#099">0.000369</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>    <span style="color:#099">0.900885</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">24</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.454869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">25</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.864547</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">26</span>    <span style="color:#099">1.129120</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">27</span>    <span style="color:#099">0.057874</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.433739</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.092698</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.397820</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">1.457823</span>
</span></span><span style="display:flex;"><span>Freq: D, Length: <span style="color:#099">365</span>, dtype: float64
</span></span></code></pre></div><p>这里，字符串“2001”被解释成年，并根据它选取时间区间。指定月也同样奏效：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">55</span>]: longer_ts[<span style="color:#d14">&#39;2001-05&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">55</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.622547</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">0.936289</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.750018</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.056715</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">2.300675</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>    <span style="color:#099">0.569497</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>    <span style="color:#099">1.489410</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>    <span style="color:#099">1.264250</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.761837</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.331617</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">...</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">22</span>    <span style="color:#099">0.503699</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.387874</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">24</span>    <span style="color:#099">0.204851</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">25</span>    <span style="color:#099">0.603705</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">26</span>    <span style="color:#099">0.545680</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">27</span>    <span style="color:#099">0.235477</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span>    <span style="color:#099">0.111835</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.251504</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">2.949343</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">0.634634</span>
</span></span><span style="display:flex;"><span>Freq: D, Length: <span style="color:#099">31</span>, dtype: float64
</span></span></code></pre></div><p>datetime对象也可以进行切片：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">56</span>]: ts[datetime(<span style="color:#099">2011</span>, <span style="color:#099">1</span>, <span style="color:#099">7</span>):]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">56</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.965781</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>    <span style="color:#099">1.393406</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>由于大部分时间序列数据都是按照时间先后排序的，因此你也可以用不存在于该时间序列中的时间戳对其进行切片（即范围查询）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">57</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">57</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.204708</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">0.478943</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.965781</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>    <span style="color:#099">1.393406</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">58</span>]: ts[<span style="color:#d14">&#39;1/6/2011&#39;</span>:<span style="color:#d14">&#39;1/11/2011&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">58</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.965781</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>跟之前一样，你可以传入字符串日期、datetime或Timestamp。注意，这样切片所产生的是原时间序列的视图，跟NumPy数组的切片运算是一样的。</p>
<p>这意味着，没有数据被复制，对切片进行修改会反映到原始数据上。</p>
<p>此外，还有一个等价的实例方法也可以截取两个日期之间TimeSeries：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">59</span>]: ts<span style="color:#000;font-weight:bold">.</span>truncate(after<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;1/9/2011&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">59</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.204708</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">0.478943</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>面这些操作对DataFrame也有效。例如，对DataFrame的行进行索引：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">60</span>]: dates <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/1/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">100</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;W-WED&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">61</span>]: long_df <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">100</span>, <span style="color:#099">4</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                        index<span style="color:#000;font-weight:bold">=</span>dates,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                        columns<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;Colorado&#39;</span>, <span style="color:#d14">&#39;Texas&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                                 <span style="color:#d14">&#39;New York&#39;</span>, <span style="color:#d14">&#39;Ohio&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">62</span>]: long_df<span style="color:#000;font-weight:bold">.</span>loc[<span style="color:#d14">&#39;5-2001&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">62</span>]: 
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.006045</span>  <span style="color:#099">0.490094</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.277186</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.707213</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.560107</span>  <span style="color:#099">2.735527</span>  <span style="color:#099">0.927335</span>  <span style="color:#099">1.513906</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">16</span>  <span style="color:#099">0.538600</span>  <span style="color:#099">1.273768</span>  <span style="color:#099">0.667876</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.969206</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>  <span style="color:#099">1.676091</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.817649</span>  <span style="color:#099">0.050188</span>  <span style="color:#099">1.951312</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>  <span style="color:#099">3.260383</span>  <span style="color:#099">0.963301</span>  <span style="color:#099">1.201206</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.852001</span>
</span></span></code></pre></div><h3 id="1122-带有重复索引的时间序列">11.2.2 带有重复索引的时间序列</h3>
<p>在某些应用场景中，可能会存在多个观测数据落在同一个时间点上的情况。下面就是一个例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">63</span>]: dates <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DatetimeIndex([<span style="color:#d14">&#39;1/1/2000&#39;</span>, <span style="color:#d14">&#39;1/2/2000&#39;</span>, <span style="color:#d14">&#39;1/2/2000&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                           <span style="color:#d14">&#39;1/2/2000&#39;</span>, <span style="color:#d14">&#39;1/3/2000&#39;</span>])
</span></span><span style="display:flex;"><span>In [<span style="color:#099">64</span>]: dup_ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>arange(<span style="color:#099">5</span>), index<span style="color:#000;font-weight:bold">=</span>dates)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">65</span>]: dup_ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">65</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><p>通过检查索引的is_unique属性，我们就可以知道它是不是唯一的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">66</span>]: dup_ts<span style="color:#000;font-weight:bold">.</span>index<span style="color:#000;font-weight:bold">.</span>is_unique
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">66</span>]: <span style="color:#000;font-weight:bold">False</span>
</span></span></code></pre></div><p>对这个时间序列进行索引，要么产生标量值，要么产生切片，具体要看所选的时间点是否重复：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">67</span>]: dup_ts[<span style="color:#d14">&#39;1/3/2000&#39;</span>]  <span style="color:#998;font-style:italic"># not duplicated</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">67</span>]: <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">68</span>]: dup_ts[<span style="color:#d14">&#39;1/2/2000&#39;</span>]  <span style="color:#998;font-style:italic"># duplicated</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">68</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><p>假设你想要对具有非唯一时间戳的数据进行聚合。一个办法是使用groupby，并传入level=0：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">69</span>]: grouped <span style="color:#000;font-weight:bold">=</span> dup_ts<span style="color:#000;font-weight:bold">.</span>groupby(level<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">70</span>]: grouped<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">70</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">71</span>]: grouped<span style="color:#000;font-weight:bold">.</span>count()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">71</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><h2 id="113-日期的范围频率以及移动">11.3 日期的范围、频率以及移动</h2>
<p>pandas中的原生时间序列一般被认为是不规则的，也就是说，它们没有固定的频率。对于大部分应用程序而言，这是无所谓的。但是，它常常需要以某种相对固定的频率进行分析，比如每日、每月、每15分钟等（这样自然会在时间序列中引入缺失值）。幸运的是，pandas有一整套标准时间序列频率以及用于重采样、频率推断、生成固定频率日期范围的工具。例如，我们可以将之前那个时间序列转换为一个具有固定频率（每日）的时间序列，只需调用resample即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">72</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">72</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.204708</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">0.478943</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.519439</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.555730</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.965781</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>    <span style="color:#099">1.393406</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">73</span>]: resampler <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>字符串“D”是每天的意思。</p>
<p>频率的转换（或重采样）是一个比较大的主题，稍后将专门用一节来进行讨论（11.6小节）。这里，我将告诉你如何使用基本的频率和它的倍数。</p>
<h3 id="1131-生成日期范围">11.3.1 生成日期范围</h3>
<p>虽然我之前用的时候没有明说，但你可能已经猜到pandas.date_range可用于根据指定的频率生成指定长度的DatetimeIndex：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">74</span>]: index <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2012-04-01&#39;</span>, <span style="color:#d14">&#39;2012-06-01&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">75</span>]: index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">75</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-04-01&#39;</span>, <span style="color:#d14">&#39;2012-04-02&#39;</span>, <span style="color:#d14">&#39;2012-04-03&#39;</span>, <span style="color:#d14">&#39;2012-04-04&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-05&#39;</span>, <span style="color:#d14">&#39;2012-04-06&#39;</span>, <span style="color:#d14">&#39;2012-04-07&#39;</span>, <span style="color:#d14">&#39;2012-04-08&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-09&#39;</span>, <span style="color:#d14">&#39;2012-04-10&#39;</span>, <span style="color:#d14">&#39;2012-04-11&#39;</span>, <span style="color:#d14">&#39;2012-04-12&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-13&#39;</span>, <span style="color:#d14">&#39;2012-04-14&#39;</span>, <span style="color:#d14">&#39;2012-04-15&#39;</span>, <span style="color:#d14">&#39;2012-04-16&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-17&#39;</span>, <span style="color:#d14">&#39;2012-04-18&#39;</span>, <span style="color:#d14">&#39;2012-04-19&#39;</span>, <span style="color:#d14">&#39;2012-04-20&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-21&#39;</span>, <span style="color:#d14">&#39;2012-04-22&#39;</span>, <span style="color:#d14">&#39;2012-04-23&#39;</span>, <span style="color:#d14">&#39;2012-04-24&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-25&#39;</span>, <span style="color:#d14">&#39;2012-04-26&#39;</span>, <span style="color:#d14">&#39;2012-04-27&#39;</span>, <span style="color:#d14">&#39;2012-04-28&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-29&#39;</span>, <span style="color:#d14">&#39;2012-04-30&#39;</span>, <span style="color:#d14">&#39;2012-05-01&#39;</span>, <span style="color:#d14">&#39;2012-05-02&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-03&#39;</span>, <span style="color:#d14">&#39;2012-05-04&#39;</span>, <span style="color:#d14">&#39;2012-05-05&#39;</span>, <span style="color:#d14">&#39;2012-05-06&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-07&#39;</span>, <span style="color:#d14">&#39;2012-05-08&#39;</span>, <span style="color:#d14">&#39;2012-05-09&#39;</span>, <span style="color:#d14">&#39;2012-05-10&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-11&#39;</span>, <span style="color:#d14">&#39;2012-05-12&#39;</span>, <span style="color:#d14">&#39;2012-05-13&#39;</span>, <span style="color:#d14">&#39;2012-05-14&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-15&#39;</span>, <span style="color:#d14">&#39;2012-05-16&#39;</span>, <span style="color:#d14">&#39;2012-05-17&#39;</span>, <span style="color:#d14">&#39;2012-05-18&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-19&#39;</span>, <span style="color:#d14">&#39;2012-05-20&#39;</span>, <span style="color:#d14">&#39;2012-05-21&#39;</span>, <span style="color:#d14">&#39;2012-05-22&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-23&#39;</span>, <span style="color:#d14">&#39;2012-05-24&#39;</span>, <span style="color:#d14">&#39;2012-05-25&#39;</span>, <span style="color:#d14">&#39;2012-05-26&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-27&#39;</span>, <span style="color:#d14">&#39;2012-05-28&#39;</span>, <span style="color:#d14">&#39;2012-05-29&#39;</span>, <span style="color:#d14">&#39;2012-05-30&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-31&#39;</span>, <span style="color:#d14">&#39;2012-06-01&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>默认情况下，date_range会产生按天计算的时间点。如果只传入起始或结束日期，那就还得传入一个表示一段时间的数字：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">76</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(start<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;2012-04-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">20</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">76</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-04-01&#39;</span>, <span style="color:#d14">&#39;2012-04-02&#39;</span>, <span style="color:#d14">&#39;2012-04-03&#39;</span>, <span style="color:#d14">&#39;2012-04-04&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-05&#39;</span>, <span style="color:#d14">&#39;2012-04-06&#39;</span>, <span style="color:#d14">&#39;2012-04-07&#39;</span>, <span style="color:#d14">&#39;2012-04-08&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-09&#39;</span>, <span style="color:#d14">&#39;2012-04-10&#39;</span>, <span style="color:#d14">&#39;2012-04-11&#39;</span>, <span style="color:#d14">&#39;2012-04-12&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-13&#39;</span>, <span style="color:#d14">&#39;2012-04-14&#39;</span>, <span style="color:#d14">&#39;2012-04-15&#39;</span>, <span style="color:#d14">&#39;2012-04-16&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-04-17&#39;</span>, <span style="color:#d14">&#39;2012-04-18&#39;</span>, <span style="color:#d14">&#39;2012-04-19&#39;</span>, <span style="color:#d14">&#39;2012-04-20&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">77</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(end<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;2012-06-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">20</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">77</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-05-13&#39;</span>, <span style="color:#d14">&#39;2012-05-14&#39;</span>, <span style="color:#d14">&#39;2012-05-15&#39;</span>, <span style="color:#d14">&#39;2012-05-16&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-17&#39;</span>, <span style="color:#d14">&#39;2012-05-18&#39;</span>, <span style="color:#d14">&#39;2012-05-19&#39;</span>, <span style="color:#d14">&#39;2012-05-20&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-21&#39;</span>, <span style="color:#d14">&#39;2012-05-22&#39;</span>, <span style="color:#d14">&#39;2012-05-23&#39;</span>, <span style="color:#d14">&#39;2012-05-24&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-25&#39;</span>, <span style="color:#d14">&#39;2012-05-26&#39;</span>, <span style="color:#d14">&#39;2012-05-27&#39;</span>,<span style="color:#d14">&#39;2012-05-28&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-29&#39;</span>, <span style="color:#d14">&#39;2012-05-30&#39;</span>, <span style="color:#d14">&#39;2012-05-31&#39;</span>, <span style="color:#d14">&#39;2012-06-01&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>起始和结束日期定义了日期索引的严格边界。例如，如果你想要生成一个由每月最后一个工作日组成的日期索引，可以传入&quot;BM&quot;频率（表示business end of month，表11-4是频率列表），这样就只会包含时间间隔内（或刚好在边界上的）符合频率要求的日期：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">78</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, <span style="color:#d14">&#39;2000-12-01&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;BM&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">78</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2000-01-31&#39;</span>, <span style="color:#d14">&#39;2000-02-29&#39;</span>, <span style="color:#d14">&#39;2000-03-31&#39;</span>, <span style="color:#d14">&#39;2000-04-28&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-05-31&#39;</span>, <span style="color:#d14">&#39;2000-06-30&#39;</span>, <span style="color:#d14">&#39;2000-07-31&#39;</span>, <span style="color:#d14">&#39;2000-08-31&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-09-29&#39;</span>, <span style="color:#d14">&#39;2000-10-31&#39;</span>, <span style="color:#d14">&#39;2000-11-30&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;BM&#39;</span>)
</span></span></code></pre></div><p>表11-4 基本的时间序列频率（不完整）</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031110410148.png" alt=""></p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031110418935.png" alt=""></p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031110426368.png" alt=""></p>
<p>date_range默认会保留起始和结束时间戳的时间信息（如果有的话）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">79</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2012-05-02 12:56:31&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">5</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">79</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-05-02 12:56:31&#39;</span>, <span style="color:#d14">&#39;2012-05-03 12:56:31&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-04 12:56:31&#39;</span>, <span style="color:#d14">&#39;2012-05-05 12:56:31&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-06 12:56:31&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>有时，虽然起始和结束日期带有时间信息，但你希望产生一组被规范化（normalize）到午夜的时间戳。<code>normalize</code>选项即可实现该功能：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">80</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2012-05-02 12:56:31&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">5</span>, normalize<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">80</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-05-02&#39;</span>, <span style="color:#d14">&#39;2012-05-03&#39;</span>, <span style="color:#d14">&#39;2012-05-04&#39;</span>, <span style="color:#d14">&#39;2012-05-05&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-05-06&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><h3 id="1132-频率和日期偏移量">11.3.2 频率和日期偏移量</h3>
<p>pandas中的频率是由一个基础频率（base frequency）和一个乘数组成的。基础频率通常以一个字符串别名表示，比如&quot;M&quot;表示每月，&ldquo;H&quot;表示每小时。对于每个基础频率，都有一个被称为日期偏移量（date offset）的对象与之对应。例如，按小时计算的频率可以用Hour类表示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">81</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">pandas.tseries.offsets</span> <span style="color:#000;font-weight:bold">import</span> Hour, Minute
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">82</span>]: hour <span style="color:#000;font-weight:bold">=</span> Hour()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">83</span>]: hour
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">83</span>]: <span style="color:#000;font-weight:bold">&lt;</span>Hour<span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>传入一个整数即可定义偏移量的倍数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">84</span>]: four_hours <span style="color:#000;font-weight:bold">=</span> Hour(<span style="color:#099">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">85</span>]: four_hours
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">85</span>]: <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#099">4</span> <span style="color:#000;font-weight:bold">*</span> Hours<span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>一般来说，无需明确创建这样的对象，只需使用诸如&quot;H&quot;或&quot;4H&quot;这样的字符串别名即可。在基础频率前面放上一个整数即可创建倍数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">86</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, <span style="color:#d14">&#39;2000-01-03 23:59&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;4h&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">86</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2000-01-01 00:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 04:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 08:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 12:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 16:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 20:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-02 00:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-02 04:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-02 08:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-02 12:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-02 16:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-02 20:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-03 00:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-03 04:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-03 08:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-03 12:00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-03 16:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-03 20:00:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;4H&#39;</span>)
</span></span></code></pre></div><p>大部分偏移量对象都可通过加法进行连接：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">87</span>]: Hour(<span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">+</span> Minute(<span style="color:#099">30</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">87</span>]: <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#099">150</span> <span style="color:#000;font-weight:bold">*</span> Minutes<span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>同理，你也可以传入频率字符串（如&quot;2h30min&rdquo;），这种字符串可以被高效地解析为等效的表达式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">88</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;1h30min&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">88</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2000-01-01 00:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 01:30:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 03:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 04:30:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 06:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 07:30:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 09:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 10:30:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2000-01-01 12:00:00&#39;</span>, <span style="color:#d14">&#39;2000-01-01 13:30:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;90T&#39;</span>)
</span></span></code></pre></div><p>有些频率所描述的时间点并不是均匀分隔的。例如，&ldquo;M&rdquo;（日历月末）和&quot;BM&quot;（每月最后一个工作日）就取决于每月的天数，对于后者，还要考虑月末是不是周末。由于没有更好的术语，我将这些称为锚点偏移量（anchored offset）。</p>
<p>表11-4列出了pandas中的频率代码和日期偏移量类。</p>
<blockquote>
<p>笔记：用户可以根据实际需求自定义一些频率类以便提供pandas所没有的日期逻辑，但具体的细节超出了本书的范围。</p>
</blockquote>
<p>表11-4 时间序列的基础频率</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031111231028.png" alt=""></p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031111236718.png" alt=""></p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031111244837.png" alt=""></p>
<h3 id="1133-wom日期">11.3.3 WOM日期</h3>
<p>WOM（Week Of Month）是一种非常实用的频率类，它以WOM开头。它使你能获得诸如“每月第3个星期五”之类的日期：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">89</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2012-01-01&#39;</span>, <span style="color:#d14">&#39;2012-09-01&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">90</span>]: <span style="color:#0086b3">list</span>(rng)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">90</span>]: 
</span></span><span style="display:flex;"><span>[Timestamp(<span style="color:#d14">&#39;2012-01-20 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-02-17 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-03-16 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-04-20 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-05-18 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-06-15 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-07-20 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>),
</span></span><span style="display:flex;"><span> Timestamp(<span style="color:#d14">&#39;2012-08-17 00:00:00&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;WOM-3FRI&#39;</span>)]
</span></span></code></pre></div><h3 id="1134-移动超前和滞后数据">11.3.4 移动（超前和滞后）数据</h3>
<p>移动（shifting）指的是沿着时间轴将数据前移或后移。Series和DataFrame都有一个shift方法用于执行单纯的前移或后移操作，保持索引不变：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">91</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">4</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                index<span style="color:#000;font-weight:bold">=</span>pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/1/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;M&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">92</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">92</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.066748</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.838639</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.117388</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.517795</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">93</span>]: ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">93</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.066748</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>    <span style="color:#099">0.838639</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">94</span>]: ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#000;font-weight:bold">-</span><span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">94</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.117388</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.517795</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>         NaN
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>当我们这样进行移动时，就会在时间序列的前面或后面产生缺失数据。</p>
<p>shift通常用于计算一个时间序列或多个时间序列（如DataFrame的列）中的百分比变化。可以这样表达：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ts <span style="color:#000;font-weight:bold">/</span> ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>
</span></span></code></pre></div><p>由于单纯的移位操作不会修改索引，所以部分数据会被丢弃。因此，如果频率已知，则可以将其传给shift以便实现对时间戳进行位移而不是对数据进行简单位移：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">95</span>]: ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#099">2</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">95</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.066748</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>    <span style="color:#099">0.838639</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.117388</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.517795</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>这里还可以使用其他频率，于是你就能非常灵活地对数据进行超前和滞后处理了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">96</span>]: ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#099">3</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">96</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.066748</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.838639</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.117388</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.517795</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">97</span>]: ts<span style="color:#000;font-weight:bold">.</span>shift(<span style="color:#099">1</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;90T&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">97</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">01</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.066748</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span> <span style="color:#099">01</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.838639</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">01</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.117388</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span> <span style="color:#099">01</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.517795</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><h3 id="1135-通过偏移量对日期进行位移">11.3.5 通过偏移量对日期进行位移</h3>
<p>pandas的日期偏移量还可以用在datetime或Timestamp对象上：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">98</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">pandas.tseries.offsets</span> <span style="color:#000;font-weight:bold">import</span> Day, MonthEnd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">99</span>]: now <span style="color:#000;font-weight:bold">=</span> datetime(<span style="color:#099">2011</span>, <span style="color:#099">11</span>, <span style="color:#099">17</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">100</span>]: now <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span> <span style="color:#000;font-weight:bold">*</span> Day()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">100</span>]: Timestamp(<span style="color:#d14">&#39;2011-11-20 00:00:00&#39;</span>)
</span></span></code></pre></div><p>如果加的是锚点偏移量（比如MonthEnd），第一次增量会将原日期向前滚动到符合频率规则的下一个日期：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">101</span>]: now <span style="color:#000;font-weight:bold">+</span> MonthEnd()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">101</span>]: Timestamp(<span style="color:#d14">&#39;2011-11-30 00:00:00&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">102</span>]: now <span style="color:#000;font-weight:bold">+</span> MonthEnd(<span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">102</span>]: Timestamp(<span style="color:#d14">&#39;2011-12-31 00:00:00&#39;</span>)
</span></span></code></pre></div><p>通过锚点偏移量的rollforward和rollback方法，可明确地将日期向前或向后“滚动”：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">103</span>]: offset <span style="color:#000;font-weight:bold">=</span> MonthEnd()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">104</span>]: offset<span style="color:#000;font-weight:bold">.</span>rollforward(now)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">104</span>]: Timestamp(<span style="color:#d14">&#39;2011-11-30 00:00:00&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">105</span>]: offset<span style="color:#000;font-weight:bold">.</span>rollback(now)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">105</span>]: Timestamp(<span style="color:#d14">&#39;2011-10-31 00:00:00&#39;</span>)
</span></span></code></pre></div><p>日期偏移量还有一个巧妙的用法，即结合groupby使用这两个“滚动”方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">106</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">20</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                index<span style="color:#000;font-weight:bold">=</span>pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/15/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">20</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;4d&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">107</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">107</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">15</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.116696</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">19</span>    <span style="color:#099">2.389645</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.932454</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">27</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.229331</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.140330</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>    <span style="color:#099">0.439920</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.823758</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.520930</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">16</span>    <span style="color:#099">0.350282</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">20</span>    <span style="color:#099">0.204395</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">24</span>    <span style="color:#099">0.133445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span>    <span style="color:#099">0.327905</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.072153</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>    <span style="color:#099">0.131678</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.297459</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">15</span>    <span style="color:#099">0.997747</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">19</span>    <span style="color:#099">0.870955</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">23</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.991253</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">27</span>    <span style="color:#099">0.151699</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">1.266151</span>
</span></span><span style="display:flex;"><span>Freq: <span style="color:#099">4</span>D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">108</span>]: ts<span style="color:#000;font-weight:bold">.</span>groupby(offset<span style="color:#000;font-weight:bold">.</span>rollforward)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">108</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.005833</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.015894</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">0.150209</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>当然，更简单、更快速地实现该功能的办法是使用resample（11.6小节将对此进行详细介绍）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">109</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;M&#39;</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">109</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.005833</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.015894</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">0.150209</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><h2 id="114-时区处理">11.4 时区处理</h2>
<p>时间序列处理工作中最让人不爽的就是对时区的处理。许多人都选择以协调世界时（UTC，它是格林尼治标准时间（Greenwich Mean Time）的接替者，目前已经是国际标准了）来处理时间序列。时区是以UTC偏移量的形式表示的。例如，夏令时期间，纽约比UTC慢4小时，而在全年其他时间则比UTC慢5小时。</p>
<p>在Python中，时区信息来自第三方库pytz，它使Python可以使用Olson数据库（汇编了世界时区信息）。这对历史数据非常重要，这是因为由于各地政府的各种突发奇想，夏令时转变日期（甚至UTC偏移量）已经发生过多次改变了。就拿美国来说，DST转变时间自1900年以来就改变过多次！</p>
<p>有关pytz库的更多信息，请查阅其文档。就本书而言，由于pandas包装了pytz的功能，因此你可以不用记忆其API，只要记得时区的名称即可。时区名可以在shell中看到，也可以通过文档查看：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">110</span>]: <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">pytz</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">111</span>]: pytz<span style="color:#000;font-weight:bold">.</span>common_timezones[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">5</span>:]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">111</span>]: [<span style="color:#d14">&#39;US/Eastern&#39;</span>, <span style="color:#d14">&#39;US/Hawaii&#39;</span>, <span style="color:#d14">&#39;US/Mountain&#39;</span>, <span style="color:#d14">&#39;US/Pacific&#39;</span>, <span style="color:#d14">&#39;UTC&#39;</span>]
</span></span></code></pre></div><p>要从pytz中获取时区对象，使用pytz.timezone即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">112</span>]: tz <span style="color:#000;font-weight:bold">=</span> pytz<span style="color:#000;font-weight:bold">.</span>timezone(<span style="color:#d14">&#39;America/New_York&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">113</span>]: tz
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">113</span>]: <span style="color:#000;font-weight:bold">&lt;</span>DstTzInfo <span style="color:#d14">&#39;America/New_York&#39;</span> LMT<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span> day, <span style="color:#099">19</span>:<span style="color:#099">04</span>:<span style="color:#099">00</span> STD<span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>pandas中的方法既可以接受时区名也可以接受这些对象。</p>
<h3 id="1141-时区本地化和转换">11.4.1 时区本地化和转换</h3>
<p>默认情况下，pandas中的时间序列是单纯（naive）的时区。看看下面这个时间序列：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">114</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;3/9/2012 9:30&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">6</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">115</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#0086b3">len</span>(rng)), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">116</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">116</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span></code></pre></div><p>其索引的tz字段为None：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">117</span>]: <span style="color:#0086b3">print</span>(ts<span style="color:#000;font-weight:bold">.</span>index<span style="color:#000;font-weight:bold">.</span>tz)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">None</span>
</span></span></code></pre></div><p>可以用时区集生成日期范围：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">118</span>]: pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;3/9/2012 9:30&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;UTC&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">118</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-03-09 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-10 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-11 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-12 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-13 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-14 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-15 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-16 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-17 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-18 09:30:00+00:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns, UTC]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>从单纯到本地化的转换是通过tz_localize方法处理的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">119</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">119</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">120</span>]: ts_utc <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>tz_localize(<span style="color:#d14">&#39;UTC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">121</span>]: ts_utc
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">121</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">122</span>]: ts_utc<span style="color:#000;font-weight:bold">.</span>index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">122</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-03-09 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-10 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-11 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-12 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-13 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-14 09:30:00+00:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns, UTC]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p>一旦时间序列被本地化到某个特定时区，就可以用tz_convert将其转换到别的时区了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">123</span>]: ts_utc<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;America/New_York&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">123</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">04</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">04</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">05</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">05</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">05</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">05</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span></code></pre></div><p>对于上面这种时间序列（它跨越了美国东部时区的夏令时转变期），我们可以将其本地化到EST，然后转换为UTC或柏林时间：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">124</span>]: ts_eastern <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>tz_localize(<span style="color:#d14">&#39;America/New_York&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">125</span>]: ts_eastern<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;UTC&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">125</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">13</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">13</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">13</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">13</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">126</span>]: ts_eastern<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;Europe/Berlin&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">126</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">15</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.202469</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#099">15</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>    <span style="color:#099">0.050718</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>    <span style="color:#099">0.639869</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>    <span style="color:#099">0.597594</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.797246</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">14</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">01</span>:<span style="color:#099">00</span>    <span style="color:#099">0.472879</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span></code></pre></div><p>tz_localize和tz_convert也是DatetimeIndex的实例方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">127</span>]: ts<span style="color:#000;font-weight:bold">.</span>index<span style="color:#000;font-weight:bold">.</span>tz_localize(<span style="color:#d14">&#39;Asia/Shanghai&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">127</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-03-09 09:30:00+08:00&#39;</span>, <span style="color:#d14">&#39;2012-03-10 09:30:00+08:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-11 09:30:00+08:00&#39;</span>, <span style="color:#d14">&#39;2012-03-12 09:30:00+08:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-13 09:30:00+08:00&#39;</span>, <span style="color:#d14">&#39;2012-03-14 09:30:00+08:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns, Asia/Shanghai]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><blockquote>
<p>注意：对单纯时间戳的本地化操作还会检查夏令时转变期附近容易混淆或不存在的时间。</p>
</blockquote>
<h3 id="1142-操作时区意识型timestamp对象">11.4.2 操作时区意识型Timestamp对象</h3>
<p>跟时间序列和日期范围差不多，独立的Timestamp对象也能被从单纯型（naive）本地化为时区意识型（time zone-aware），并从一个时区转换到另一个时区：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">128</span>]: stamp <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Timestamp(<span style="color:#d14">&#39;2011-03-12 04:00&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">129</span>]: stamp_utc <span style="color:#000;font-weight:bold">=</span> stamp<span style="color:#000;font-weight:bold">.</span>tz_localize(<span style="color:#d14">&#39;utc&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">130</span>]: stamp_utc<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;America/New_York&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">130</span>]: Timestamp(<span style="color:#d14">&#39;2011-03-11 23:00:00-0500&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;America/New_York&#39;</span>)
</span></span></code></pre></div><p>在创建Timestamp时，还可以传入一个时区信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">131</span>]: stamp_moscow <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Timestamp(<span style="color:#d14">&#39;2011-03-12 04:00&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Europe/Moscow&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">132</span>]: stamp_moscow
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">132</span>]: Timestamp(<span style="color:#d14">&#39;2011-03-12 04:00:00+0300&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Europe/Moscow&#39;</span>)
</span></span></code></pre></div><p>时区意识型Timestamp对象在内部保存了一个UTC时间戳值（自UNIX纪元（1970年1月1日）算起的纳秒数）。这个UTC值在时区转换过程中是不会发生变化的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">133</span>]: stamp_utc<span style="color:#000;font-weight:bold">.</span>value
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">133</span>]: <span style="color:#099">1299902400000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">134</span>]: stamp_utc<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;America/New_York&#39;</span>)<span style="color:#000;font-weight:bold">.</span>value
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">134</span>]: <span style="color:#099">1299902400000000000</span>
</span></span></code></pre></div><p>当使用pandas的DateOffset对象执行时间算术运算时，运算过程会自动关注是否存在夏令时转变期。这里，我们创建了在DST转变之前的时间戳。首先，来看夏令时转变前的30分钟：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">135</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">pandas.tseries.offsets</span> <span style="color:#000;font-weight:bold">import</span> Hour
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">136</span>]: stamp <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Timestamp(<span style="color:#d14">&#39;2012-03-12 01:30&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">137</span>]: stamp
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">137</span>]: Timestamp(<span style="color:#d14">&#39;2012-03-12 01:30:00-0400&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">138</span>]: stamp <span style="color:#000;font-weight:bold">+</span> Hour()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">138</span>]: Timestamp(<span style="color:#d14">&#39;2012-03-12 02:30:00-0400&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span></code></pre></div><p>然后，夏令时转变前90分钟：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">139</span>]: stamp <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Timestamp(<span style="color:#d14">&#39;2012-11-04 00:30&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">140</span>]: stamp
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">140</span>]: Timestamp(<span style="color:#d14">&#39;2012-11-04 00:30:00-0400&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">141</span>]: stamp <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span> <span style="color:#000;font-weight:bold">*</span> Hour()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">141</span>]: Timestamp(<span style="color:#d14">&#39;2012-11-04 01:30:00-0500&#39;</span>, tz<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;US/Eastern&#39;</span>)
</span></span></code></pre></div><h3 id="1143-不同时区之间的运算">11.4.3 不同时区之间的运算</h3>
<p>如果两个时间序列的时区不同，在将它们合并到一起时，最终结果就会是UTC。由于时间戳其实是以UTC存储的，所以这是一个很简单的运算，并不需要发生任何转换：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">142</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;3/7/2012 9:30&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;B&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">143</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#0086b3">len</span>(rng)), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">144</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">144</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.522356</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.546348</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.733537</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">1.302736</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.022199</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.364287</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">15</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.922839</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">16</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>    <span style="color:#099">0.312656</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">19</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.128497</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">20</span> <span style="color:#099">09</span>:<span style="color:#099">30</span>:<span style="color:#099">00</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.333488</span>
</span></span><span style="display:flex;"><span>Freq: B, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">145</span>]: ts1 <span style="color:#000;font-weight:bold">=</span> ts[:<span style="color:#099">7</span>]<span style="color:#000;font-weight:bold">.</span>tz_localize(<span style="color:#d14">&#39;Europe/London&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">146</span>]: ts2 <span style="color:#000;font-weight:bold">=</span> ts1[<span style="color:#099">2</span>:]<span style="color:#000;font-weight:bold">.</span>tz_convert(<span style="color:#d14">&#39;Europe/Moscow&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">147</span>]: result <span style="color:#000;font-weight:bold">=</span> ts1 <span style="color:#000;font-weight:bold">+</span> ts2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">148</span>]: result<span style="color:#000;font-weight:bold">.</span>index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">148</span>]: 
</span></span><span style="display:flex;"><span>DatetimeIndex([<span style="color:#d14">&#39;2012-03-07 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-08 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-09 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-12 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-13 09:30:00+00:00&#39;</span>, <span style="color:#d14">&#39;2012-03-14 09:30:00+00:00&#39;</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#39;2012-03-15 09:30:00+00:00&#39;</span>],
</span></span><span style="display:flex;"><span>              dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;datetime64[ns, UTC]&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;B&#39;</span>)
</span></span></code></pre></div><h2 id="115-时期及其算术运算">11.5 时期及其算术运算</h2>
<p>时期（period）表示的是时间区间，比如数日、数月、数季、数年等。Period类所表示的就是这种数据类型，其构造函数需要用到一个字符串或整数，以及表11-4中的频率：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">149</span>]: p <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#099">2007</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">150</span>]: p
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">150</span>]: Period(<span style="color:#d14">&#39;2007&#39;</span>, <span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span></code></pre></div><p>这里，这个Period对象表示的是从2007年1月1日到2007年12月31日之间的整段时间。只需对Period对象加上或减去一个整数即可达到根据其频率进行位移的效果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">151</span>]: p <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">151</span>]: Period(<span style="color:#d14">&#39;2012&#39;</span>, <span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">152</span>]: p <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">152</span>]: Period(<span style="color:#d14">&#39;2005&#39;</span>, <span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span></code></pre></div><p>如果两个Period对象拥有相同的频率，则它们的差就是它们之间的单位数量：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">153</span>]: pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#d14">&#39;2014&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;A-DEC&#39;</span>) <span style="color:#000;font-weight:bold">-</span> p
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">153</span>]: <span style="color:#099">7</span>
</span></span></code></pre></div><p>period_range函数可用于创建规则的时期范围：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">154</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>period_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, <span style="color:#d14">&#39;2000-06-30&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">155</span>]: rng
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">155</span>]: PeriodIndex([<span style="color:#d14">&#39;2000-01&#39;</span>, <span style="color:#d14">&#39;2000-02&#39;</span>, <span style="color:#d14">&#39;2000-03&#39;</span>, <span style="color:#d14">&#39;2000-04&#39;</span>, <span style="color:#d14">&#39;2000-05&#39;</span>, <span style="color:#d14">&#39;20</span>
</span></span><span style="display:flex;"><span><span style="color:#099">00</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span><span style="color:#d14">&#39;], dtype=&#39;</span>period[M]<span style="color:#d14">&#39;, freq=&#39;</span>M<span style="color:#d14">&#39;)</span>
</span></span></code></pre></div><p>PeriodIndex类保存了一组Period，它可以在任何pandas数据结构中被用作轴索引：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">156</span>]: pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">6</span>), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">156</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.514551</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.559782</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.783408</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.797685</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.172670</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>    <span style="color:#099">0.680215</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>如果你有一个字符串数组，你也可以使用PeriodIndex类：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">157</span>]: values <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;2001Q3&#39;</span>, <span style="color:#d14">&#39;2002Q2&#39;</span>, <span style="color:#d14">&#39;2003Q1&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">158</span>]: index <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>PeriodIndex(values, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">159</span>]: index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">159</span>]: PeriodIndex([<span style="color:#d14">&#39;2001Q3&#39;</span>, <span style="color:#d14">&#39;2002Q2&#39;</span>, <span style="color:#d14">&#39;2003Q1&#39;</span>], dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;period[Q-DEC]&#39;</span>, freq
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-DEC&#39;</span>)
</span></span></code></pre></div><h3 id="1151-时期的频率转换">11.5.1 时期的频率转换</h3>
<p>Period和PeriodIndex对象都可以通过其asfreq方法被转换成别的频率。假设我们有一个年度时期，希望将其转换为当年年初或年末的一个月度时期。该任务非常简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">160</span>]: p <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#d14">&#39;2007&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">161</span>]: p
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">161</span>]: Period(<span style="color:#d14">&#39;2007&#39;</span>, <span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">162</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;M&#39;</span>, how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;start&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">162</span>]: Period(<span style="color:#d14">&#39;2007-01&#39;</span>, <span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">163</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;M&#39;</span>, how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">163</span>]: Period(<span style="color:#d14">&#39;2007-12&#39;</span>, <span style="color:#d14">&#39;M&#39;</span>)
</span></span></code></pre></div><p>你可以将Period(&lsquo;2007&rsquo;,&lsquo;A-DEC&rsquo;)看做一个被划分为多个月度时期的时间段中的游标。图11-1对此进行了说明。对于一个不以12月结束的财政年度，月度子时期的归属情况就不一样了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">164</span>]: p <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#d14">&#39;2007&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;A-JUN&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">165</span>]: p
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">165</span>]: Period(<span style="color:#d14">&#39;2007&#39;</span>, <span style="color:#d14">&#39;A-JUN&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">166</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;M&#39;</span>, <span style="color:#d14">&#39;start&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">166</span>]: Period(<span style="color:#d14">&#39;2006-07&#39;</span>, <span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">167</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;M&#39;</span>, <span style="color:#d14">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">167</span>]: Period(<span style="color:#d14">&#39;2007-06&#39;</span>, <span style="color:#d14">&#39;M&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031121609434.png" alt="图11-1 Period频率转换示例"></p>
<p>在将高频率转换为低频率时，超时期（superperiod）是由子时期（subperiod）所属的位置决定的。例如，在A-JUN频率中，月份“2007年8月”实际上是属于周期“2008年”的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">168</span>]: p <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#d14">&#39;Aug-2007&#39;</span>, <span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">169</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;A-JUN&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">169</span>]: Period(<span style="color:#d14">&#39;2008&#39;</span>, <span style="color:#d14">&#39;A-JUN&#39;</span>)
</span></span></code></pre></div><p>完整的PeriodIndex或TimeSeries的频率转换方式也是如此：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">170</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>period_range(<span style="color:#d14">&#39;2006&#39;</span>, <span style="color:#d14">&#39;2009&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;A-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">171</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#0086b3">len</span>(rng)), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">172</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">172</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2006</span>    <span style="color:#099">1.607578</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>    <span style="color:#099">0.200381</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.834068</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.302988</span>
</span></span><span style="display:flex;"><span>Freq: A<span style="color:#000;font-weight:bold">-</span>DEC, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">173</span>]: ts<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;M&#39;</span>, how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;start&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">173</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2006</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">1.607578</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0.200381</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.834068</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.302988</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>这里，根据年度时期的第一个月，每年的时期被取代为每月的时期。如果我们想要每年的最后一个工作日，我们可以使用“B”频率，并指明想要该时期的末尾：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">174</span>]: ts<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;B&#39;</span>, how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">174</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2006</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">1.607578</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">0.200381</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.834068</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.302988</span>
</span></span><span style="display:flex;"><span>Freq: B, dtype: float64
</span></span></code></pre></div><h3 id="1152-按季度计算的时期频率">11.5.2 按季度计算的时期频率</h3>
<p>季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及“财年末”的概念，通常是一年12个月中某月的最后一个日历日或工作日。就这一点来说，时期&quot;2012Q4&quot;根据财年末的不同会有不同的含义。pandas支持12种可能的季度型频率，即Q-JAN到Q-DEC：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">175</span>]: p <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Period(<span style="color:#d14">&#39;2012Q4&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-JAN&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">176</span>]: p
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">176</span>]: Period(<span style="color:#d14">&#39;2012Q4&#39;</span>, <span style="color:#d14">&#39;Q-JAN&#39;</span>)
</span></span></code></pre></div><p>在以1月结束的财年中，2012Q4是从11月到1月（将其转换为日型频率就明白了）。图11-2对此进行了说明：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">177</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;D&#39;</span>, <span style="color:#d14">&#39;start&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">177</span>]: Period(<span style="color:#d14">&#39;2011-11-01&#39;</span>, <span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">178</span>]: p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;D&#39;</span>, <span style="color:#d14">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">178</span>]: Period(<span style="color:#d14">&#39;2012-01-31&#39;</span>, <span style="color:#d14">&#39;D&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031121647886.png" alt="图11.2 不同季度型频率之间的转换"></p>
<p>因此，Period之间的算术运算会非常简单。例如，要获取该季度倒数第二个工作日下午4点的时间戳，你可以这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">179</span>]: p4pm <span style="color:#000;font-weight:bold">=</span> (p<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;B&#39;</span>, <span style="color:#d14">&#39;e&#39;</span>) <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;T&#39;</span>, <span style="color:#d14">&#39;s&#39;</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">16</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">180</span>]: p4pm
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">180</span>]: Period(<span style="color:#d14">&#39;2012-01-30 16:00&#39;</span>, <span style="color:#d14">&#39;T&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">181</span>]: p4pm<span style="color:#000;font-weight:bold">.</span>to_timestamp()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">181</span>]: Timestamp(<span style="color:#d14">&#39;2012-01-30 16:00:00&#39;</span>)
</span></span></code></pre></div><p>period_range可用于生成季度型范围。季度型范围的算术运算也跟上面是一样的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">182</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>period_range(<span style="color:#d14">&#39;2011Q3&#39;</span>, <span style="color:#d14">&#39;2012Q4&#39;</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-JAN&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">183</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>arange(<span style="color:#0086b3">len</span>(rng)), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">184</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">184</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span>Q3    <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span>Q4    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span>Q1    <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span>Q2    <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span>Q3    <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span>Q4    <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>Freq: Q<span style="color:#000;font-weight:bold">-</span>JAN, dtype: int64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">185</span>]: new_rng <span style="color:#000;font-weight:bold">=</span> (rng<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;B&#39;</span>, <span style="color:#d14">&#39;e&#39;</span>) <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">.</span>asfreq(<span style="color:#d14">&#39;T&#39;</span>, <span style="color:#d14">&#39;s&#39;</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">16</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">186</span>]: ts<span style="color:#000;font-weight:bold">.</span>index <span style="color:#000;font-weight:bold">=</span> new_rng<span style="color:#000;font-weight:bold">.</span>to_timestamp()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">187</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">187</span>]:
</span></span><span style="display:flex;"><span><span style="color:#099">2010</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">28</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2012</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span> <span style="color:#099">16</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><h3 id="1153-将timestamp转换为period及其反向过程">11.5.3 将Timestamp转换为Period（及其反向过程）</h3>
<p>通过使用to_period方法，可以将由时间戳索引的Series和DataFrame对象转换为以时期索引：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">188</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">189</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">3</span>), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">190</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">190</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">1.663261</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.996206</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">1.521760</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">191</span>]: pts <span style="color:#000;font-weight:bold">=</span> ts<span style="color:#000;font-weight:bold">.</span>to_period()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">192</span>]: pts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">192</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">1.663261</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.996206</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">1.521760</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>由于时期指的是非重叠时间区间，因此对于给定的频率，一个时间戳只能属于一个时期。新PeriodIndex的频率默认是从时间戳推断而来的，你也可以指定任何别的频率。结果中允许存在重复时期：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">193</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/29/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">6</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">194</span>]: ts2 <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">6</span>), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">195</span>]: ts2
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">195</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.244175</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>    <span style="color:#099">0.423331</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.654040</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">2.089154</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.060220</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.167933</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">196</span>]: ts2<span style="color:#000;font-weight:bold">.</span>to_period(<span style="color:#d14">&#39;M&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">196</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0.244175</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0.423331</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.654040</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">2.089154</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.060220</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.167933</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>要转换回时间戳，使用to_timestamp即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">197</span>]: pts <span style="color:#000;font-weight:bold">=</span> ts2<span style="color:#000;font-weight:bold">.</span>to_period()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">198</span>]: pts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">198</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.244175</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>    <span style="color:#099">0.423331</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.654040</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">2.089154</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.060220</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.167933</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">199</span>]: pts<span style="color:#000;font-weight:bold">.</span>to_timestamp(how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">199</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.244175</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>    <span style="color:#099">0.423331</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.654040</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">2.089154</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.060220</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.167933</span>
</span></span><span style="display:flex;"><span>Freq: D, dtype: float64
</span></span></code></pre></div><h3 id="1154-通过数组创建periodindex">11.5.4 通过数组创建PeriodIndex</h3>
<p>固定频率的数据集通常会将时间信息分开存放在多个列中。例如，在下面这个宏观经济数据集中，年度和季度就分别存放在不同的列中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">200</span>]: data <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_csv(<span style="color:#d14">&#39;examples/macrodata.csv&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">201</span>]: data<span style="color:#000;font-weight:bold">.</span>head(<span style="color:#099">5</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">201</span>]: 
</span></span><span style="display:flex;"><span>     year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>  <span style="color:#099">1959.0</span>      <span style="color:#099">1.0</span>  <span style="color:#099">2710.349</span>    <span style="color:#099">1707.4</span>  <span style="color:#099">286.898</span>   <span style="color:#099">470.045</span>   <span style="color:#099">1886.9</span>  <span style="color:#099">28.98</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>  <span style="color:#099">1959.0</span>      <span style="color:#099">2.0</span>  <span style="color:#099">2778.801</span>    <span style="color:#099">1733.7</span>  <span style="color:#099">310.859</span>   <span style="color:#099">481.301</span>   <span style="color:#099">1919.7</span>  <span style="color:#099">29.15</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>  <span style="color:#099">1959.0</span>      <span style="color:#099">3.0</span>  <span style="color:#099">2775.488</span>    <span style="color:#099">1751.8</span>  <span style="color:#099">289.226</span>   <span style="color:#099">491.260</span>   <span style="color:#099">1916.4</span>  <span style="color:#099">29.35</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>  <span style="color:#099">1959.0</span>      <span style="color:#099">4.0</span>  <span style="color:#099">2785.204</span>    <span style="color:#099">1753.7</span>  <span style="color:#099">299.356</span>   <span style="color:#099">484.052</span>   <span style="color:#099">1931.3</span>  <span style="color:#099">29.37</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>  <span style="color:#099">1960.0</span>      <span style="color:#099">1.0</span>  <span style="color:#099">2847.699</span>    <span style="color:#099">1770.5</span>  <span style="color:#099">331.722</span>   <span style="color:#099">462.199</span>   <span style="color:#099">1955.5</span>  <span style="color:#099">29.54</span>   
</span></span><span style="display:flex;"><span>      m1  tbilrate  unemp      pop  infl  realint  
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>  <span style="color:#099">139.7</span>      <span style="color:#099">2.82</span>    <span style="color:#099">5.8</span>  <span style="color:#099">177.146</span>  <span style="color:#099">0.00</span>     <span style="color:#099">0.00</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>  <span style="color:#099">141.7</span>      <span style="color:#099">3.08</span>    <span style="color:#099">5.1</span>  <span style="color:#099">177.830</span>  <span style="color:#099">2.34</span>     <span style="color:#099">0.74</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>  <span style="color:#099">140.5</span>      <span style="color:#099">3.82</span>    <span style="color:#099">5.3</span>  <span style="color:#099">178.657</span>  <span style="color:#099">2.74</span>     <span style="color:#099">1.09</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>  <span style="color:#099">140.0</span>      <span style="color:#099">4.33</span>    <span style="color:#099">5.6</span>  <span style="color:#099">179.386</span>  <span style="color:#099">0.27</span>     <span style="color:#099">4.06</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>  <span style="color:#099">139.6</span>      <span style="color:#099">3.50</span>    <span style="color:#099">5.2</span>  <span style="color:#099">180.007</span>  <span style="color:#099">2.31</span>     <span style="color:#099">1.19</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">202</span>]: data<span style="color:#000;font-weight:bold">.</span>year
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">202</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>      <span style="color:#099">1959.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>      <span style="color:#099">1959.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>      <span style="color:#099">1959.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>      <span style="color:#099">1959.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>      <span style="color:#099">1960.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>      <span style="color:#099">1960.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>      <span style="color:#099">1960.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">7</span>      <span style="color:#099">1960.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">8</span>      <span style="color:#099">1961.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">9</span>      <span style="color:#099">1961.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">193</span>    <span style="color:#099">2007.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">194</span>    <span style="color:#099">2007.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">195</span>    <span style="color:#099">2007.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">196</span>    <span style="color:#099">2008.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">197</span>    <span style="color:#099">2008.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">198</span>    <span style="color:#099">2008.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">199</span>    <span style="color:#099">2008.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">200</span>    <span style="color:#099">2009.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">201</span>    <span style="color:#099">2009.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">202</span>    <span style="color:#099">2009.0</span>
</span></span><span style="display:flex;"><span>Name: year, Length: <span style="color:#099">203</span>, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">203</span>]: data<span style="color:#000;font-weight:bold">.</span>quarter
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">203</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>      <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>      <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>      <span style="color:#099">4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>      <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>      <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">7</span>      <span style="color:#099">4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">8</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">9</span>      <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#099">193</span>    <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">194</span>    <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">195</span>    <span style="color:#099">4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">196</span>    <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">197</span>    <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">198</span>    <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">199</span>    <span style="color:#099">4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">200</span>    <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">201</span>    <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">202</span>    <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span>Name: quarter, Length: <span style="color:#099">203</span>, dtype: float64
</span></span></code></pre></div><p>通过将这些数组以及一个频率传入PeriodIndex，就可以将它们合并成DataFrame的一个索引：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">204</span>]: index <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>PeriodIndex(year<span style="color:#000;font-weight:bold">=</span>data<span style="color:#000;font-weight:bold">.</span>year, quarter<span style="color:#000;font-weight:bold">=</span>data<span style="color:#000;font-weight:bold">.</span>quarter,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                        freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">205</span>]: index
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">205</span>]: 
</span></span><span style="display:flex;"><span>PeriodIndex([<span style="color:#d14">&#39;1959Q1&#39;</span>, <span style="color:#d14">&#39;1959Q2&#39;</span>, <span style="color:#d14">&#39;1959Q3&#39;</span>, <span style="color:#d14">&#39;1959Q4&#39;</span>, <span style="color:#d14">&#39;1960Q1&#39;</span>, <span style="color:#d14">&#39;1960Q2&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#d14">&#39;1960Q3&#39;</span>, <span style="color:#d14">&#39;1960Q4&#39;</span>, <span style="color:#d14">&#39;1961Q1&#39;</span>, <span style="color:#d14">&#39;1961Q2&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>             <span style="color:#d14">&#39;2007Q2&#39;</span>, <span style="color:#d14">&#39;2007Q3&#39;</span>, <span style="color:#d14">&#39;2007Q4&#39;</span>, <span style="color:#d14">&#39;2008Q1&#39;</span>, <span style="color:#d14">&#39;2008Q2&#39;</span>, <span style="color:#d14">&#39;2008Q3&#39;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#d14">&#39;2008Q4&#39;</span>, <span style="color:#d14">&#39;2009Q1&#39;</span>, <span style="color:#d14">&#39;2009Q2&#39;</span>, <span style="color:#d14">&#39;2009Q3&#39;</span>],
</span></span><span style="display:flex;"><span>            dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;period[Q-DEC]&#39;</span>, length<span style="color:#000;font-weight:bold">=</span><span style="color:#099">203</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Q-DEC&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">206</span>]: data<span style="color:#000;font-weight:bold">.</span>index <span style="color:#000;font-weight:bold">=</span> index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">207</span>]: data<span style="color:#000;font-weight:bold">.</span>infl
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">207</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">1959</span>Q1    <span style="color:#099">0.00</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1959</span>Q2    <span style="color:#099">2.34</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1959</span>Q3    <span style="color:#099">2.74</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1959</span>Q4    <span style="color:#099">0.27</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1960</span>Q1    <span style="color:#099">2.31</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1960</span>Q2    <span style="color:#099">0.14</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1960</span>Q3    <span style="color:#099">2.70</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1960</span>Q4    <span style="color:#099">1.21</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1961</span>Q1   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.40</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1961</span>Q2    <span style="color:#099">1.47</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>Q2    <span style="color:#099">2.75</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>Q3    <span style="color:#099">3.45</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>Q4    <span style="color:#099">6.38</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>Q1    <span style="color:#099">2.82</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>Q2    <span style="color:#099">8.53</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>Q3   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">3.16</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>Q4   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">8.79</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>Q1    <span style="color:#099">0.94</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>Q2    <span style="color:#099">3.37</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>Q3    <span style="color:#099">3.56</span>
</span></span><span style="display:flex;"><span>Freq: Q<span style="color:#000;font-weight:bold">-</span>DEC, Name: infl, Length: <span style="color:#099">203</span>, dtype: float64
</span></span></code></pre></div><h2 id="116-重采样及频率转换">11.6 重采样及频率转换</h2>
<p>重采样（resampling）指的是将时间序列从一个频率转换到另一个频率的处理过程。将高频率数据聚合到低频率称为降采样（downsampling），而将低频率数据转换到高频率则称为升采样（upsampling）。并不是所有的重采样都能被划分到这两个大类中。例如，将W-WED（每周三）转换为W-FRI既不是降采样也不是升采样。</p>
<p>pandas对象都带有一个resample方法，它是各种频率转换工作的主力函数。resample有一个类似于groupby的API，调用resample可以分组数据，然后会调用一个聚合函数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">208</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">100</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">209</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#0086b3">len</span>(rng)), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">210</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">210</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>    <span style="color:#099">0.631634</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.594313</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.519937</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>    <span style="color:#099">1.108752</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>    <span style="color:#099">1.255853</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.024330</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">2.047939</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.272657</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.692615</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">1.423830</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">...</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.007852</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.638806</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">1.401227</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">1.758539</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>    <span style="color:#099">0.628932</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.423776</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>    <span style="color:#099">0.789740</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>    <span style="color:#099">0.937568</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">2.253294</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.772919</span>
</span></span><span style="display:flex;"><span>Freq: D, Length: <span style="color:#099">100</span>, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">211</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;M&#39;</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">211</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.165893</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">29</span>    <span style="color:#099">0.078606</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span>    <span style="color:#099">0.223811</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">30</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.063643</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">212</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;M&#39;</span>, kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;period&#39;</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">212</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.165893</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">0.078606</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">0.223811</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>   <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.063643</span>
</span></span><span style="display:flex;"><span>Freq: M, dtype: float64
</span></span></code></pre></div><p>resample是一个灵活高效的方法，可用于处理非常大的时间序列。我将通过一系列的示例说明其用法。表11-5总结它的一些选项。</p>
<p>表11-5 resample方法的参数
<img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122022359.png" alt=""></p>
<h3 id="1161-降采样">11.6.1 降采样</h3>
<p>将数据聚合到规律的低频率是一件非常普通的时间序列处理任务。待聚合的数据不必拥有固定的频率，期望的频率会自动定义聚合的面元边界，这些面元用于将时间序列拆分为多个片段。例如，要转换到月度频率（&lsquo;M&rsquo;或&rsquo;BM&rsquo;），数据需要被划分到多个单月时间段中。各时间段都是半开放的。一个数据点只能属于一个时间段，所有时间段的并集必须能组成整个时间帧。在用resample对数据进行降采样时，需要考虑两样东西：</p>
<ul>
<li>各区间哪边是闭合的。</li>
<li>如何标记各个聚合面元，用区间的开头还是末尾。</li>
</ul>
<p>为了说明，我们来看一些“1分钟”数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">213</span>]: rng <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;2000-01-01&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">12</span>, freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;T&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">214</span>]: ts <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(np<span style="color:#000;font-weight:bold">.</span>arange(<span style="color:#099">12</span>), index<span style="color:#000;font-weight:bold">=</span>rng)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">215</span>]: ts
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">215</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">01</span>:<span style="color:#099">00</span>     <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">02</span>:<span style="color:#099">00</span>     <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">03</span>:<span style="color:#099">00</span>     <span style="color:#099">3</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">04</span>:<span style="color:#099">00</span>     <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">05</span>:<span style="color:#099">00</span>     <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">06</span>:<span style="color:#099">00</span>     <span style="color:#099">6</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">07</span>:<span style="color:#099">00</span>     <span style="color:#099">7</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">08</span>:<span style="color:#099">00</span>     <span style="color:#099">8</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">09</span>:<span style="color:#099">00</span>     <span style="color:#099">9</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">10</span>:<span style="color:#099">00</span>    <span style="color:#099">10</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">11</span>:<span style="color:#099">00</span>    <span style="color:#099">11</span>
</span></span><span style="display:flex;"><span>Freq: T, dtype: int64
</span></span></code></pre></div><p>假设你想要通过求和的方式将这些数据聚合到“5分钟”块中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">216</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>, closed<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>)<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">216</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">1999</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">23</span>:<span style="color:#099">55</span>:<span style="color:#099">00</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">05</span>:<span style="color:#099">00</span>    <span style="color:#099">40</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">10</span>:<span style="color:#099">00</span>    <span style="color:#099">11</span>
</span></span><span style="display:flex;"><span>Freq: <span style="color:#099">5</span>T, dtype: int64
</span></span></code></pre></div><p>传入的频率将会以“5分钟”的增量定义面元边界。默认情况下，面元的右边界是包含的，因此00:00到00:05的区间中是包含00:05的。传入closed=&lsquo;left&rsquo;会让区间以左边界闭合：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">217</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>, closed<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>)<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">217</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">1999</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">23</span>:<span style="color:#099">55</span>:<span style="color:#099">00</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>    <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">05</span>:<span style="color:#099">00</span>    <span style="color:#099">40</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">10</span>:<span style="color:#099">00</span>    <span style="color:#099">11</span>
</span></span><span style="display:flex;"><span>Freq: <span style="color:#099">5</span>T, dtype: int64
</span></span></code></pre></div><p>如你所见，最终的时间序列是以各面元右边界的时间戳进行标记的。传入label=&lsquo;right&rsquo;即可用面元的邮编界对其进行标记：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">218</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>, closed<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>, label<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>)<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">218</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">05</span>:<span style="color:#099">00</span>    <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">10</span>:<span style="color:#099">00</span>    <span style="color:#099">40</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">15</span>:<span style="color:#099">00</span>    <span style="color:#099">11</span>
</span></span><span style="display:flex;"><span>Freq: <span style="color:#099">5</span>T, dtype: int64
</span></span></code></pre></div><p>图11-3说明了“1分钟”数据被转换为“5分钟”数据的处理过程。</p>
<p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122053525.png" alt="图11-3 各种closed、label约定的“5分钟”重采样演示"></p>
<p>最后，你可能希望对结果索引做一些位移，比如从右边界减去一秒以便更容易明白该时间戳到底表示的是哪个区间。只需通过loffset设置一个字符串或日期偏移量即可实现这个目的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">219</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>, closed<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:             label<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>, loffset<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;-1s&#39;</span>)<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">219</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">1999</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">23</span>:<span style="color:#099">59</span>:<span style="color:#099">59</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">04</span>:<span style="color:#099">59</span>    <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">219</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>, closed<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:             label<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;right&#39;</span>, loffset<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;-1s&#39;</span>)<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">219</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">1999</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">31</span> <span style="color:#099">23</span>:<span style="color:#099">59</span>:<span style="color:#099">59</span>     <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">04</span>:<span style="color:#099">59</span>    <span style="color:#099">15</span>
</span></span></code></pre></div><p>此外，也可以通过调用结果对象的shift方法来实现该目的，这样就不需要设置loffset了。</p>
<p>##OHLC重采样</p>
<p>金融领域中有一种无所不在的时间序列聚合方式，即计算各面元的四个值：第一个值（open，开盘）、最后一个值（close，收盘）、最大值（high，最高）以及最小值（low，最低）。传入how=&lsquo;ohlc&rsquo;即可得到一个含有这四种聚合值的DataFrame。整个过程很高效，只需一次扫描即可计算出结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">220</span>]: ts<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;5min&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ohlc()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">220</span>]: 
</span></span><span style="display:flex;"><span>                     <span style="color:#0086b3">open</span>  high  low  close
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">00</span>:<span style="color:#099">00</span>     <span style="color:#099">0</span>     <span style="color:#099">4</span>    <span style="color:#099">0</span>      <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">05</span>:<span style="color:#099">00</span>     <span style="color:#099">5</span>     <span style="color:#099">9</span>    <span style="color:#099">5</span>      <span style="color:#099">9</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span> <span style="color:#099">00</span>:<span style="color:#099">10</span>:<span style="color:#099">00</span>    <span style="color:#099">10</span>    <span style="color:#099">11</span>   <span style="color:#099">10</span>     <span style="color:#099">11</span>
</span></span></code></pre></div><p>##升采样和插值</p>
<p>在将数据从低频率转换到高频率时，就不需要聚合了。我们来看一个带有一些周型数据的DataFrame：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">221</span>]: frame <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">2</span>, <span style="color:#099">4</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                      index<span style="color:#000;font-weight:bold">=</span>pd<span style="color:#000;font-weight:bold">.</span>date_range(<span style="color:#d14">&#39;1/1/2000&#39;</span>, periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                          freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;W-WED&#39;</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                      columns<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;Colorado&#39;</span>, <span style="color:#d14">&#39;Texas&#39;</span>, <span style="color:#d14">&#39;New York&#39;</span>, <span style="color:#d14">&#39;Ohio&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">222</span>]: frame
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">222</span>]: 
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.046662</span>  <span style="color:#099">0.927238</span>  <span style="color:#099">0.482284</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.867130</span>
</span></span></code></pre></div><p>当你对这个数据进行聚合，每组只有一个值，这样就会引入缺失值。我们使用asfreq方法转换成高频，不经过聚合：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">223</span>]: df_daily <span style="color:#000;font-weight:bold">=</span> frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;D&#39;</span>)<span style="color:#000;font-weight:bold">.</span>asfreq()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">224</span>]: df_daily
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">224</span>]: 
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.046662</span>  <span style="color:#099">0.927238</span>  <span style="color:#099">0.482284</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.867130</span>
</span></span></code></pre></div><p>假设你想要用前面的周型值填充“非星期三”。resampling的填充和插值方式跟fillna和reindex的一样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">225</span>]: frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;D&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">225</span>]: 
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.046662</span>  <span style="color:#099">0.927238</span>  <span style="color:#099">0.482284</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.867130</span>
</span></span></code></pre></div><p>同样，这里也可以只填充指定的时期数（目的是限制前面的观测值的持续使用距离）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">226</span>]: frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;D&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill(limit<span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">226</span>]:
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span>       NaN       NaN       NaN       NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.046662</span>  <span style="color:#099">0.927238</span>  <span style="color:#099">0.482284</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.867130</span>
</span></span></code></pre></div><p>注意，新的日期索引完全没必要跟旧的重叠：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">227</span>]: frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;W-THU&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">227</span>]: 
</span></span><span style="display:flex;"><span>            Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.896431</span>  <span style="color:#099">0.677263</span>  <span style="color:#099">0.036503</span>  <span style="color:#099">0.087102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.046662</span>  <span style="color:#099">0.927238</span>  <span style="color:#099">0.482284</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.867130</span>
</span></span></code></pre></div><h3 id="1162-通过时期进行重采样">11.6.2 通过时期进行重采样</h3>
<p>对那些使用时期索引的数据进行重采样与时间戳很像：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">228</span>]: frame <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(np<span style="color:#000;font-weight:bold">.</span>random<span style="color:#000;font-weight:bold">.</span>randn(<span style="color:#099">24</span>, <span style="color:#099">4</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                      index<span style="color:#000;font-weight:bold">=</span>pd<span style="color:#000;font-weight:bold">.</span>period_range(<span style="color:#d14">&#39;1-2000&#39;</span>, <span style="color:#d14">&#39;12-2001&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                            freq<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;M&#39;</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                      columns<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;Colorado&#39;</span>, <span style="color:#d14">&#39;Texas&#39;</span>, <span style="color:#d14">&#39;New York&#39;</span>, <span style="color:#d14">&#39;Ohio&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">229</span>]: frame[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">229</span>]: 
</span></span><span style="display:flex;"><span>         Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span>  <span style="color:#099">0.493841</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.155434</span>  <span style="color:#099">1.397286</span>  <span style="color:#099">1.507055</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.179442</span>  <span style="color:#099">0.443171</span>  <span style="color:#099">1.395676</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.529658</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>  <span style="color:#099">0.787358</span>  <span style="color:#099">0.248845</span>  <span style="color:#099">0.743239</span>  <span style="color:#099">1.267746</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>  <span style="color:#099">1.302395</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.272154</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.051532</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.467740</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.040816</span>  <span style="color:#099">0.426419</span>  <span style="color:#099">0.312945</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1.115689</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">230</span>]: annual_frame <span style="color:#000;font-weight:bold">=</span> frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;A-DEC&#39;</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">231</span>]: annual_frame
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">231</span>]: 
</span></span><span style="display:flex;"><span>      Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span></code></pre></div><p>升采样要稍微麻烦一些，因为你必须决定在新频率中各区间的哪端用于放置原来的值，就像asfreq方法那样。convention参数默认为&rsquo;start&rsquo;，也可设置为&rsquo;end&rsquo;：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Q-DEC: Quarterly, year ending in December</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">232</span>]: annual_frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;Q-DEC&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">232</span>]: 
</span></span><span style="display:flex;"><span>        Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q1  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q2  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q3  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q4  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q1  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q2  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q3  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q4  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">233</span>]: annual_frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;Q-DEC&#39;</span>, convention<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;end&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">233</span>]: 
</span></span><span style="display:flex;"><span>        Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q4  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q1  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q2  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q3  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q4  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span></code></pre></div><p>由于时期指的是时间区间，所以升采样和降采样的规则就比较严格：</p>
<ul>
<li>在降采样中，目标频率必须是源频率的子时期（subperiod）。</li>
<li>在升采样中，目标频率必须是源频率的超时期（superperiod）。</li>
</ul>
<p>如果不满足这些条件，就会引发异常。这主要影响的是按季、年、周计算的频率。例如，由Q-MAR定义的时间区间只能升采样为A-MAR、A-JUN、A-SEP、A-DEC等：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">234</span>]: annual_frame<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;Q-MAR&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">234</span>]: 
</span></span><span style="display:flex;"><span>        Colorado     Texas  New York      Ohio
</span></span><span style="display:flex;"><span><span style="color:#099">2000</span>Q4  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q1  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q2  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q3  <span style="color:#099">0.556703</span>  <span style="color:#099">0.016631</span>  <span style="color:#099">0.111873</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.027445</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2001</span>Q4  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span>Q1  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span>Q2  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2002</span>Q3  <span style="color:#099">0.046303</span>  <span style="color:#099">0.163344</span>  <span style="color:#099">0.251503</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.157276</span>
</span></span></code></pre></div><h2 id="117-移动窗口函数">11.7 移动窗口函数</h2>
<p>在移动窗口（可以带有指数衰减权数）上计算的各种统计函数也是一类常见于时间序列的数组变换。这样可以圆滑噪音数据或断裂数据。我将它们称为移动窗口函数（moving window function），其中还包括那些窗口不定长的函数（如指数加权移动平均）。跟其他统计函数一样，移动窗口函数也会自动排除缺失值。</p>
<p>开始之前，我们加载一些时间序列数据，将其重采样为工作日频率：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">235</span>]: close_px_all <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_csv(<span style="color:#d14">&#39;examples/stock_px_2.csv&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                            parse_dates<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>, index_col<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">236</span>]: close_px <span style="color:#000;font-weight:bold">=</span> close_px_all[[<span style="color:#d14">&#39;AAPL&#39;</span>, <span style="color:#d14">&#39;MSFT&#39;</span>, <span style="color:#d14">&#39;XOM&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">237</span>]: close_px <span style="color:#000;font-weight:bold">=</span> close_px<span style="color:#000;font-weight:bold">.</span>resample(<span style="color:#d14">&#39;B&#39;</span>)<span style="color:#000;font-weight:bold">.</span>ffill()
</span></span></code></pre></div><p>现在引入rolling运算符，它与resample和groupby很像。可以在TimeSeries或DataFrame以及一个window（表示期数，见图11-4）上调用它：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">238</span>]: close_px<span style="color:#000;font-weight:bold">.</span>AAPL<span style="color:#000;font-weight:bold">.</span>plot()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">238</span>]: <span style="color:#000;font-weight:bold">&lt;</span>matplotlib<span style="color:#000;font-weight:bold">.</span>axes<span style="color:#000;font-weight:bold">.</span>_subplots<span style="color:#000;font-weight:bold">.</span>AxesSubplot at <span style="color:#099">0x7f2f2570cf98</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">239</span>]: close_px<span style="color:#000;font-weight:bold">.</span>AAPL<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">250</span>)<span style="color:#000;font-weight:bold">.</span>mean()<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122133037.png" alt="图11-4 苹果公司股价的250日均线"></p>
<p>表达式rolling(250)与groupby很像，但不是对其进行分组，而是创建一个按照250天分组的滑动窗口对象。然后，我们就得到了苹果公司股价的250天的移动窗口。</p>
<p>默认情况下，rolling函数需要窗口中所有的值为非NA值。可以修改该行为以解决缺失数据的问题。其实，在时间序列开始处尚不足窗口期的那些数据就是个特例（见图11-5）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">241</span>]: appl_std250 <span style="color:#000;font-weight:bold">=</span> close_px<span style="color:#000;font-weight:bold">.</span>AAPL<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">250</span>, min_periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>)<span style="color:#000;font-weight:bold">.</span>std()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">242</span>]: appl_std250[<span style="color:#099">5</span>:<span style="color:#099">12</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">242</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span>         NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">15</span>    <span style="color:#099">0.077496</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">16</span>    <span style="color:#099">0.074760</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">17</span>    <span style="color:#099">0.112368</span>
</span></span><span style="display:flex;"><span>Freq: B, Name: AAPL, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">243</span>]: appl_std250<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122145664.png" alt="图11-5 苹果公司250日每日回报标准差"></p>
<p>要计算扩展窗口平均（expanding window mean），可以使用expanding而不是rolling。“扩展”意味着，从时间序列的起始处开始窗口，增加窗口直到它超过所有的序列。apple_std250时间序列的扩展窗口平均如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">244</span>]: expanding_mean <span style="color:#000;font-weight:bold">=</span> appl_std250<span style="color:#000;font-weight:bold">.</span>expanding()<span style="color:#000;font-weight:bold">.</span>mean()
</span></span></code></pre></div><p>对DataFrame调用rolling_mean（以及与之类似的函数）会将转换应用到所有的列上（见图11-6）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">246</span>]: close_px<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">60</span>)<span style="color:#000;font-weight:bold">.</span>mean()<span style="color:#000;font-weight:bold">.</span>plot(logy<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122152236.png" alt="图11-6 各股价60日均线（对数Y轴）"></p>
<p>rolling函数也可以接受一个指定固定大小时间补偿字符串，而不是一组时期。这样可以方便处理不规律的时间序列。这些字符串也可以传递给resample。例如，我们可以计算20天的滚动均值，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">247</span>]: close_px<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#d14">&#39;20D&#39;</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">247</span>]:
</span></span><span style="display:flex;"><span>                  AAPL       MSFT        XOM
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">02</span>    <span style="color:#099">7.400000</span>  <span style="color:#099">21.110000</span>  <span style="color:#099">29.220000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>    <span style="color:#099">7.425000</span>  <span style="color:#099">21.125000</span>  <span style="color:#099">29.230000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>    <span style="color:#099">7.433333</span>  <span style="color:#099">21.256667</span>  <span style="color:#099">29.473333</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>    <span style="color:#099">7.432500</span>  <span style="color:#099">21.425000</span>  <span style="color:#099">29.342500</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">08</span>    <span style="color:#099">7.402000</span>  <span style="color:#099">21.402000</span>  <span style="color:#099">29.240000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">09</span>    <span style="color:#099">7.391667</span>  <span style="color:#099">21.490000</span>  <span style="color:#099">29.273333</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>    <span style="color:#099">7.387143</span>  <span style="color:#099">21.558571</span>  <span style="color:#099">29.238571</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span>    <span style="color:#099">7.378750</span>  <span style="color:#099">21.633750</span>  <span style="color:#099">29.197500</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span>    <span style="color:#099">7.370000</span>  <span style="color:#099">21.717778</span>  <span style="color:#099">29.194444</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2003</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">15</span>    <span style="color:#099">7.355000</span>  <span style="color:#099">21.757000</span>  <span style="color:#099">29.152000</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                <span style="color:#000;font-weight:bold">...</span>        <span style="color:#000;font-weight:bold">...</span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">03</span>  <span style="color:#099">398.002143</span>  <span style="color:#099">25.890714</span>  <span style="color:#099">72.413571</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">04</span>  <span style="color:#099">396.802143</span>  <span style="color:#099">25.807857</span>  <span style="color:#099">72.427143</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">05</span>  <span style="color:#099">395.751429</span>  <span style="color:#099">25.729286</span>  <span style="color:#099">72.422857</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">06</span>  <span style="color:#099">394.099286</span>  <span style="color:#099">25.673571</span>  <span style="color:#099">72.375714</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">07</span>  <span style="color:#099">392.479333</span>  <span style="color:#099">25.712000</span>  <span style="color:#099">72.454667</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>  <span style="color:#099">389.351429</span>  <span style="color:#099">25.602143</span>  <span style="color:#099">72.527857</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">11</span>  <span style="color:#099">388.505000</span>  <span style="color:#099">25.674286</span>  <span style="color:#099">72.835000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>  <span style="color:#099">388.531429</span>  <span style="color:#099">25.810000</span>  <span style="color:#099">73.400714</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">13</span>  <span style="color:#099">388.826429</span>  <span style="color:#099">25.961429</span>  <span style="color:#099">73.905000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2011</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">14</span>  <span style="color:#099">391.038000</span>  <span style="color:#099">26.048667</span>  <span style="color:#099">74.185333</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">2292</span> rows x <span style="color:#099">3</span> columns]
</span></span></code></pre></div><h3 id="1171-指数加权函数">11.7.1 指数加权函数</h3>
<p>另一种使用固定大小窗口及相等权数观测值的办法是，定义一个衰减因子（decay factor）常量，以便使近期的观测值拥有更大的权数。衰减因子的定义方式有很多，比较流行的是使用时间间隔（span），它可以使结果兼容于窗口大小等于时间间隔的简单移动窗口（simple moving window）函数。</p>
<p>由于指数加权统计会赋予近期的观测值更大的权数，因此相对于等权统计，它能“适应”更快的变化。</p>
<p>除了rolling和expanding，pandas还有ewm运算符。下面这个例子对比了苹果公司股价的30日移动平均和span=30的指数加权移动平均（如图11-7所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">249</span>]: aapl_px <span style="color:#000;font-weight:bold">=</span> close_px<span style="color:#000;font-weight:bold">.</span>AAPL[<span style="color:#d14">&#39;2006&#39;</span>:<span style="color:#d14">&#39;2007&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">250</span>]: ma60 <span style="color:#000;font-weight:bold">=</span> aapl_px<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">30</span>, min_periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">20</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">251</span>]: ewma60 <span style="color:#000;font-weight:bold">=</span> aapl_px<span style="color:#000;font-weight:bold">.</span>ewm(span<span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>)<span style="color:#000;font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">252</span>]: ma60<span style="color:#000;font-weight:bold">.</span>plot(style<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;k--&#39;</span>, label<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Simple MA&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">252</span>]: <span style="color:#000;font-weight:bold">&lt;</span>matplotlib<span style="color:#000;font-weight:bold">.</span>axes<span style="color:#000;font-weight:bold">.</span>_subplots<span style="color:#000;font-weight:bold">.</span>AxesSubplot at <span style="color:#099">0x7f2f252161d0</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">253</span>]: ewma60<span style="color:#000;font-weight:bold">.</span>plot(style<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;k-&#39;</span>, label<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;EW MA&#39;</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">253</span>]: <span style="color:#000;font-weight:bold">&lt;</span>matplotlib<span style="color:#000;font-weight:bold">.</span>axes<span style="color:#000;font-weight:bold">.</span>_subplots<span style="color:#000;font-weight:bold">.</span>AxesSubplot at <span style="color:#099">0x7f2f252161d0</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">254</span>]: plt<span style="color:#000;font-weight:bold">.</span>legend()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031122226190.png" alt="图11-7 简单移动平均与指数加权移动平均"></p>
<h3 id="1172-二元移动窗口函数">11.7.2 二元移动窗口函数</h3>
<p>有些统计运算（如相关系数和协方差）需要在两个时间序列上执行。例如，金融分析师常常对某只股票对某个参考指数（如标准普尔500指数）的相关系数感兴趣。要进行说明，我们先计算我们感兴趣的时间序列的百分数变化：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">256</span>]: spx_px <span style="color:#000;font-weight:bold">=</span> close_px_all[<span style="color:#d14">&#39;SPX&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">257</span>]: spx_rets <span style="color:#000;font-weight:bold">=</span> spx_px<span style="color:#000;font-weight:bold">.</span>pct_change()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">258</span>]: returns <span style="color:#000;font-weight:bold">=</span> close_px<span style="color:#000;font-weight:bold">.</span>pct_change()
</span></span></code></pre></div><p>调用rolling之后，corr聚合函数开始计算与spx_rets滚动相关系数（结果见图11-8）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">259</span>]: corr <span style="color:#000;font-weight:bold">=</span> returns<span style="color:#000;font-weight:bold">.</span>AAPL<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">125</span>, min_periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">100</span>)<span style="color:#000;font-weight:bold">.</span>corr(spx_rets)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">260</span>]: corr<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031131637209.png" alt="图11-8 AAPL 6个月的回报与标准普尔500指数的相关系数"></p>
<p>假设你想要一次性计算多只股票与标准普尔500指数的相关系数。虽然编写一个循环并新建一个DataFrame不是什么难事，但比较啰嗦。其实，只需传入一个TimeSeries和一个DataFrame，rolling_corr就会自动计算TimeSeries（本例中就是spx_rets）与DataFrame各列的相关系数。结果如图11-9所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">262</span>]: corr <span style="color:#000;font-weight:bold">=</span> returns<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">125</span>, min_periods<span style="color:#000;font-weight:bold">=</span><span style="color:#099">100</span>)<span style="color:#000;font-weight:bold">.</span>corr(spx_rets)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">263</span>]: corr<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031131651174.png" alt="图11-9 3只股票6个月的回报与标准普尔500指数的相关系数"></p>
<h3 id="1173-用户定义的移动窗口函数">11.7.3 用户定义的移动窗口函数</h3>
<p>rolling_apply函数使你能够在移动窗口上应用自己设计的数组函数。唯一要求的就是：该函数要能从数组的各个片段中产生单个值（即约简）。比如说，当我们用rolling(&hellip;).quantile(q)计算样本分位数时，可能对样本中特定值的百分等级感兴趣。scipy.stats.percentileofscore函数就能达到这个目的（结果见图11-10）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">265</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">scipy.stats</span> <span style="color:#000;font-weight:bold">import</span> percentileofscore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">266</span>]: score_at_2percent <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: percentileofscore(x, <span style="color:#099">0.02</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">267</span>]: result <span style="color:#000;font-weight:bold">=</span> returns<span style="color:#000;font-weight:bold">.</span>AAPL<span style="color:#000;font-weight:bold">.</span>rolling(<span style="color:#099">250</span>)<span style="color:#000;font-weight:bold">.</span>apply(score_at_2percent)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">268</span>]: result<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031131723334.png" alt="图11-10 AAPL 2%回报率的百分等级（一年窗口期）"></p>
<p>如果你没安装SciPy，可以使用conda或pip安装。</p>
<h2 id="118-总结">11.8 总结</h2>
<p>与前面章节接触的数据相比，时间序列数据要求不同类型的分析和数据转换工具。</p>
<p>在接下来的章节中，我们将学习一些高级的pandas方法和如何开始使用<code>建模库statsmodels和scikit-learn</code>。</p>

    </div>

    

    

    <div class="container-prevnext">
    <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch06-%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%AD%98%E5%82%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/">← 第六章 数据加载、存储与文件格式</a></div>
    <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch13-python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/">第十三章 Python 建模库介绍  →</a></div>
</div>
    
    

    
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        京ICP备2022007001号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
    
</div></div>
    </body>
</html>
