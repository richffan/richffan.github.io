<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="第十四章 数据分析案例 - https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch14-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/">
    <meta name="author" content="richfan - https://richfan.site/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>第十四章 数据分析案例</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://richfan.site/style.min.d252ad53a5e6b2ae6b8c6c1661107189be3668e36c8dd61697bbe008595a7e04.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"isSingleColumnOfPostList": true,
		"hasFoldAllCodeBlocks": false,
		"svgColor": "",
		"en": false,
		"dark": true
	}
</div>
    <h1 class="title">
        
            第十四章 数据分析案例
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill="#6c757d" p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill="#6c757d"></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill="#6c757d"></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill="#6c757d" p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill="#6c757d" p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill="#6c757d" p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill="#6c757d" p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill="#6c757d"></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">















<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2023-09-25&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2023-09-25&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            12955 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            26 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
			<a href="/categories/%E7%A8%8B%E6%8A%80">程技</a>
			
		</div>
		<div class="tag">
			
			 - 
			
			<a href="/tags/python">python</a>
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch12-pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch10-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88%E4%B8%8E%E5%88%86%E7%BB%84%E8%BF%90%E7%AE%97/"><img src="/imgs/icons/arrow-right-circle.svg" alt=""></a></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#141-来自bitly的usagov数据">14.1 来自Bitly的USA.gov数据</a>
      <ul>
        <li><a href="#1411-用pandas对时区进行计数">14.1.1 用pandas对时区进行计数</a></li>
      </ul>
    </li>
    <li><a href="#142-movielens-1m数据集">14.2 MovieLens 1M数据集</a>
      <ul>
        <li><a href="#1421-计算评分分歧">14.2.1 计算评分分歧</a></li>
      </ul>
    </li>
    <li><a href="#143-1880-2010年间全美婴儿姓名">14.3 1880-2010年间全美婴儿姓名</a>
      <ul>
        <li><a href="#1431-分析命名趋势">14.3.1 分析命名趋势</a></li>
        <li><a href="#1432-评估命名多样性的增长">14.3.2 评估命名多样性的增长</a></li>
        <li><a href="#1433-最后一个字母的变革">14.3.3 “最后一个字母”的变革</a></li>
        <li><a href="#1434-变成女孩名字的男孩名字以及相反的情况">14.3.4 变成女孩名字的男孩名字（以及相反的情况）</a></li>
      </ul>
    </li>
    <li><a href="#144-usda食品数据库">14.4 USDA食品数据库</a></li>
    <li><a href="#145-2012联邦选举委员会数据库">14.5 2012联邦选举委员会数据库</a>
      <ul>
        <li><a href="#1451-根据职业和雇主统计赞助信息">14.5.1 根据职业和雇主统计赞助信息</a></li>
        <li><a href="#1452-对出资额分组">14.5.2 对出资额分组</a></li>
        <li><a href="#1453-根据州统计赞助信息">14.5.3 根据州统计赞助信息</a></li>
      </ul>
    </li>
    <li><a href="#146-总结">14.6 总结</a></li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <p>本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展示的方法适用于其它数据集，也包括你的。本章包含了一些各种各样的案例数据集，可以用来练习。</p>
<p>案例数据集可以在Github仓库找到，见第一章。</p>
<h2 id="141-来自bitly的usagov数据">14.1 来自Bitly的USA.gov数据</h2>
<p>2011年，URL缩短服务Bitly跟美国政府网站USA.gov合作，提供了一份从生成.gov或.mil短链接的用户那里收集来的匿名数据。在2011年，除实时数据之外，还可以下载文本文件形式的每小时快照。写作此书时（2017年），这项服务已经关闭，但我们保存一份数据用于本书的案例。</p>
<p>以每小时快照为例，文件中各行的格式为JSON（即JavaScript Object Notation，这是一种常用的Web数据格式）。例如，如果我们只读取某个文件中的第一行，那么所看到的结果应该是下面这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">5</span>]: path <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;datasets/bitly_usagov/example.txt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">6</span>]: <span style="color:#0086b3">open</span>(path)<span style="color:#000;font-weight:bold">.</span>readline()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">6</span>]: <span style="color:#d14">&#39;{ &#34;a&#34;: &#34;Mozilla</span><span style="color:#d14">\\</span><span style="color:#d14">/5.0 (Windows NT 6.1; WOW64) AppleWebKit</span><span style="color:#d14">\\</span><span style="color:#d14">/535.11</span>
</span></span><span style="display:flex;"><span>(KHTML, like Gecko) Chrome\\<span style="color:#000;font-weight:bold">/</span><span style="color:#099">17.0.963.78</span> Safari\\<span style="color:#000;font-weight:bold">/</span><span style="color:#099">535.11</span><span style="color:#d14">&#34;, &#34;</span>c<span style="color:#d14">&#34;: &#34;</span>US<span style="color:#d14">&#34;, &#34;</span>nk<span style="color:#d14">&#34;: 1,</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;tz&#34;</span>: <span style="color:#d14">&#34;America</span><span style="color:#d14">\\</span><span style="color:#d14">/New_York&#34;</span>, <span style="color:#d14">&#34;gr&#34;</span>: <span style="color:#d14">&#34;MA&#34;</span>, <span style="color:#d14">&#34;g&#34;</span>: <span style="color:#d14">&#34;A6qOVH&#34;</span>, <span style="color:#d14">&#34;h&#34;</span>: <span style="color:#d14">&#34;wfLQtf&#34;</span>, <span style="color:#d14">&#34;l&#34;</span>:
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;orofrog&#34;</span>, <span style="color:#d14">&#34;al&#34;</span>: <span style="color:#d14">&#34;en-US,en;q=0.8&#34;</span>, <span style="color:#d14">&#34;hh&#34;</span>: <span style="color:#d14">&#34;1.usa.gov&#34;</span>, <span style="color:#d14">&#34;r&#34;</span>:
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;http:</span><span style="color:#d14">\\</span><span style="color:#d14">/</span><span style="color:#d14">\\</span><span style="color:#d14">/www.facebook.com</span><span style="color:#d14">\\</span><span style="color:#d14">/l</span><span style="color:#d14">\\</span><span style="color:#d14">/7AQEFzjSi</span><span style="color:#d14">\\</span><span style="color:#d14">/1.usa.gov</span><span style="color:#d14">\\</span><span style="color:#d14">/wfLQtf&#34;</span>, <span style="color:#d14">&#34;u&#34;</span>:
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;http:</span><span style="color:#d14">\\</span><span style="color:#d14">/</span><span style="color:#d14">\\</span><span style="color:#d14">/www.ncbi.nlm.nih.gov</span><span style="color:#d14">\\</span><span style="color:#d14">/pubmed</span><span style="color:#d14">\\</span><span style="color:#d14">/22415991&#34;</span>, <span style="color:#d14">&#34;t&#34;</span>: <span style="color:#099">1331923247</span>, <span style="color:#d14">&#34;hc&#34;</span>:
</span></span><span style="display:flex;"><span><span style="color:#099">1331822918</span>, <span style="color:#d14">&#34;cy&#34;</span>: <span style="color:#d14">&#34;Danvers&#34;</span>, <span style="color:#d14">&#34;ll&#34;</span>: [ <span style="color:#099">42.576698</span>, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">70.954903</span> ] }\n<span style="color:#d14">&#39;</span>
</span></span></code></pre></div><p>Python有内置或第三方模块可以将JSON字符串转换成Python字典对象。这里，我将使用json模块及其loads函数逐行加载已经下载好的数据文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">json</span>
</span></span><span style="display:flex;"><span>path <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;datasets/bitly_usagov/example.txt&#39;</span>
</span></span><span style="display:flex;"><span>records <span style="color:#000;font-weight:bold">=</span> [json<span style="color:#000;font-weight:bold">.</span>loads(line) <span style="color:#000;font-weight:bold">for</span> line <span style="color:#000;font-weight:bold">in</span> <span style="color:#0086b3">open</span>(path)]
</span></span></code></pre></div><p>现在，records对象就成为一组Python字典了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">18</span>]: records[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">18</span>]:
</span></span><span style="display:flex;"><span>{<span style="color:#d14">&#39;a&#39;</span>: <span style="color:#d14">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko)</span>
</span></span><span style="display:flex;"><span>Chrome<span style="color:#000;font-weight:bold">/</span><span style="color:#099">17.0.963.78</span> Safari<span style="color:#000;font-weight:bold">/</span><span style="color:#099">535.11</span><span style="color:#d14">&#39;,</span>
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;al&#39;</span>: <span style="color:#d14">&#39;en-US,en;q=0.8&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;c&#39;</span>: <span style="color:#d14">&#39;US&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;cy&#39;</span>: <span style="color:#d14">&#39;Danvers&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;g&#39;</span>: <span style="color:#d14">&#39;A6qOVH&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;gr&#39;</span>: <span style="color:#d14">&#39;MA&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;h&#39;</span>: <span style="color:#d14">&#39;wfLQtf&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;hc&#39;</span>: <span style="color:#099">1331822918</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;hh&#39;</span>: <span style="color:#d14">&#39;1.usa.gov&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;l&#39;</span>: <span style="color:#d14">&#39;orofrog&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;ll&#39;</span>: [<span style="color:#099">42.576698</span>, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">70.954903</span>],
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;nk&#39;</span>: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;r&#39;</span>: <span style="color:#d14">&#39;http://www.facebook.com/l/7AQEFzjSi/1.usa.gov/wfLQtf&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;t&#39;</span>: <span style="color:#099">1331923247</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;tz&#39;</span>: <span style="color:#d14">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;u&#39;</span>: <span style="color:#d14">&#39;http://www.ncbi.nlm.nih.gov/pubmed/22415991&#39;</span>}
</span></span></code></pre></div><p>##用纯Python代码对时区进行计数</p>
<p>假设我们想要知道该数据集中最常出现的是哪个时区（即tz字段），得到答案的办法有很多。首先，我们用列表推导式取出一组时区：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">12</span>]: time_zones <span style="color:#000;font-weight:bold">=</span> [rec[<span style="color:#d14">&#39;tz&#39;</span>] <span style="color:#000;font-weight:bold">for</span> rec <span style="color:#000;font-weight:bold">in</span> records]
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">---------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">KeyError</span>                                  Traceback (most recent call last)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span>ipython<span style="color:#000;font-weight:bold">-</span><span style="color:#0086b3">input</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span>db4fbd348da9<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">&lt;</span>module<span style="color:#000;font-weight:bold">&gt;</span>()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">----&gt;</span> <span style="color:#099">1</span> time_zones <span style="color:#000;font-weight:bold">=</span> [rec[<span style="color:#d14">&#39;tz&#39;</span>] <span style="color:#000;font-weight:bold">for</span> rec <span style="color:#000;font-weight:bold">in</span> records]
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span>ipython<span style="color:#000;font-weight:bold">-</span><span style="color:#0086b3">input</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span><span style="color:#000;font-weight:bold">-</span>db4fbd348da9<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">&lt;</span>listcomp<span style="color:#000;font-weight:bold">&gt;</span>(<span style="color:#099">.0</span>)
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">----&gt;</span> <span style="color:#099">1</span> time_zones <span style="color:#000;font-weight:bold">=</span> [rec[<span style="color:#d14">&#39;tz&#39;</span>] <span style="color:#000;font-weight:bold">for</span> rec <span style="color:#000;font-weight:bold">in</span> records]
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">KeyError</span>: <span style="color:#d14">&#39;tz&#39;</span>
</span></span></code></pre></div><p>晕！原来并不是所有记录都有时区字段。这个好办，只需在列表推导式末尾加上一个if &rsquo;tz&rsquo;in rec判断即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">13</span>]: time_zones <span style="color:#000;font-weight:bold">=</span> [rec[<span style="color:#d14">&#39;tz&#39;</span>] <span style="color:#000;font-weight:bold">for</span> rec <span style="color:#000;font-weight:bold">in</span> records <span style="color:#000;font-weight:bold">if</span> <span style="color:#d14">&#39;tz&#39;</span> <span style="color:#000;font-weight:bold">in</span> rec]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">14</span>]: time_zones[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">14</span>]: 
</span></span><span style="display:flex;"><span>[<span style="color:#d14">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;America/Denver&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;America/Sao_Paulo&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;Europe/Warsaw&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;&#39;</span>]
</span></span></code></pre></div><p>只看前10个时区，我们发现有些是未知的（即空的）。虽然可以将它们过滤掉，但现在暂时先留着。接下来，为了对时区进行计数，这里介绍两个办法：一个较难（只使用标准Python库），另一个较简单（使用pandas）。计数的办法之一是在遍历时区的过程中将计数值保存在字典中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_counts</span>(sequence):
</span></span><span style="display:flex;"><span>    counts <span style="color:#000;font-weight:bold">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> x <span style="color:#000;font-weight:bold">in</span> sequence:
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> x <span style="color:#000;font-weight:bold">in</span> counts:
</span></span><span style="display:flex;"><span>            counts[x] <span style="color:#000;font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            counts[x] <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> counts
</span></span></code></pre></div><p>如果使用Python标准库的更高级工具，那么你可能会将代码写得更简洁一些：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">from</span> <span style="color:#555">collections</span> <span style="color:#000;font-weight:bold">import</span> defaultdict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_counts2</span>(sequence):
</span></span><span style="display:flex;"><span>    counts <span style="color:#000;font-weight:bold">=</span> defaultdict(<span style="color:#0086b3">int</span>) <span style="color:#998;font-style:italic"># values will initialize to 0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> x <span style="color:#000;font-weight:bold">in</span> sequence:
</span></span><span style="display:flex;"><span>        counts[x] <span style="color:#000;font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> counts
</span></span></code></pre></div><p>我将逻辑写到函数中是为了获得更高的复用性。要用它对时区进行处理，只需将time_zones传入即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">17</span>]: counts <span style="color:#000;font-weight:bold">=</span> get_counts(time_zones)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">18</span>]: counts[<span style="color:#d14">&#39;America/New_York&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">18</span>]: <span style="color:#099">1251</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">19</span>]: <span style="color:#0086b3">len</span>(time_zones)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">19</span>]: <span style="color:#099">3440</span>
</span></span></code></pre></div><p>如果想要得到前10位的时区及其计数值，我们需要用到一些有关字典的处理技巧：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">top_counts</span>(count_dict, n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>):
</span></span><span style="display:flex;"><span>    value_key_pairs <span style="color:#000;font-weight:bold">=</span> [(count, tz) <span style="color:#000;font-weight:bold">for</span> tz, count <span style="color:#000;font-weight:bold">in</span> count_dict<span style="color:#000;font-weight:bold">.</span>items()]
</span></span><span style="display:flex;"><span>    value_key_pairs<span style="color:#000;font-weight:bold">.</span>sort()
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> value_key_pairs[<span style="color:#000;font-weight:bold">-</span>n:]
</span></span></code></pre></div><p>然后有：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">21</span>]: top_counts(counts)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">21</span>]: 
</span></span><span style="display:flex;"><span>[(<span style="color:#099">33</span>, <span style="color:#d14">&#39;America/Sao_Paulo&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">35</span>, <span style="color:#d14">&#39;Europe/Madrid&#39;</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#099">36</span>, <span style="color:#d14">&#39;Pacific/Honolulu&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">37</span>, <span style="color:#d14">&#39;Asia/Tokyo&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">74</span>, <span style="color:#d14">&#39;Europe/London&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">191</span>, <span style="color:#d14">&#39;America/Denver&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">382</span>, <span style="color:#d14">&#39;America/Los_Angeles&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">400</span>, <span style="color:#d14">&#39;America/Chicago&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">521</span>, <span style="color:#d14">&#39;&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#099">1251</span>, <span style="color:#d14">&#39;America/New_York&#39;</span>)]
</span></span></code></pre></div><p>如果你搜索Python的标准库，你能找到collections.Counter类，它可以使这项工作更简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">22</span>]: <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">collections</span> <span style="color:#000;font-weight:bold">import</span> Counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">23</span>]: counts <span style="color:#000;font-weight:bold">=</span> Counter(time_zones)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">24</span>]: counts<span style="color:#000;font-weight:bold">.</span>most_common(<span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">24</span>]: 
</span></span><span style="display:flex;"><span>[(<span style="color:#d14">&#39;America/New_York&#39;</span>, <span style="color:#099">1251</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;&#39;</span>, <span style="color:#099">521</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;America/Chicago&#39;</span>, <span style="color:#099">400</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;America/Los_Angeles&#39;</span>, <span style="color:#099">382</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;America/Denver&#39;</span>, <span style="color:#099">191</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;Europe/London&#39;</span>, <span style="color:#099">74</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;Asia/Tokyo&#39;</span>, <span style="color:#099">37</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;Pacific/Honolulu&#39;</span>, <span style="color:#099">36</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;Europe/Madrid&#39;</span>, <span style="color:#099">35</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#d14">&#39;America/Sao_Paulo&#39;</span>, <span style="color:#099">33</span>)]
</span></span></code></pre></div><h3 id="1411-用pandas对时区进行计数">14.1.1 用pandas对时区进行计数</h3>
<p>从原始记录的集合创建DateFrame，与将记录列表传递到pandas.DataFrame一样简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">25</span>]: <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="color:#000;font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">26</span>]: frame <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(records)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">27</span>]: frame<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>RangeIndex: <span style="color:#099">3560</span> entries, <span style="color:#099">0</span> to <span style="color:#099">3559</span>
</span></span><span style="display:flex;"><span>Data columns (total <span style="color:#099">18</span> columns):
</span></span><span style="display:flex;"><span>_heartbeat_    <span style="color:#099">120</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span>a              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>al             <span style="color:#099">3094</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>c              <span style="color:#099">2919</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>cy             <span style="color:#099">2919</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>g              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>gr             <span style="color:#099">2919</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>h              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>hc             <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span>hh             <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>kw             <span style="color:#099">93</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>l              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>ll             <span style="color:#099">2919</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>nk             <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span>r              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>t              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span>tz             <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>u              <span style="color:#099">3440</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>dtypes: float64(<span style="color:#099">4</span>), <span style="color:#0086b3">object</span>(<span style="color:#099">14</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">500.7</span><span style="color:#000;font-weight:bold">+</span> KB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">28</span>]: frame[<span style="color:#d14">&#39;tz&#39;</span>][:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">28</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>     America<span style="color:#000;font-weight:bold">/</span>New_York
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>       America<span style="color:#000;font-weight:bold">/</span>Denver
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>     America<span style="color:#000;font-weight:bold">/</span>New_York
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>    America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>     America<span style="color:#000;font-weight:bold">/</span>New_York
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>     America<span style="color:#000;font-weight:bold">/</span>New_York
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>        Europe<span style="color:#000;font-weight:bold">/</span>Warsaw
</span></span><span style="display:flex;"><span><span style="color:#099">7</span>                     
</span></span><span style="display:flex;"><span><span style="color:#099">8</span>                     
</span></span><span style="display:flex;"><span><span style="color:#099">9</span>                     
</span></span><span style="display:flex;"><span>Name: tz, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>这里frame的输出形式是摘要视图（summary view），主要用于较大的DataFrame对象。我们然后可以对Series使用value_counts方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">29</span>]: tz_counts <span style="color:#000;font-weight:bold">=</span> frame[<span style="color:#d14">&#39;tz&#39;</span>]<span style="color:#000;font-weight:bold">.</span>value_counts()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">30</span>]: tz_counts[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">30</span>]: 
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>New_York       <span style="color:#099">1251</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#099">521</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Chicago         <span style="color:#099">400</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Los_Angeles     <span style="color:#099">382</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Denver          <span style="color:#099">191</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>London            <span style="color:#099">74</span>
</span></span><span style="display:flex;"><span>Asia<span style="color:#000;font-weight:bold">/</span>Tokyo               <span style="color:#099">37</span>
</span></span><span style="display:flex;"><span>Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu         <span style="color:#099">36</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>Madrid            <span style="color:#099">35</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo        <span style="color:#099">33</span>
</span></span><span style="display:flex;"><span>Name: tz, dtype: int64
</span></span></code></pre></div><p>我们可以用matplotlib可视化这个数据。为此，我们先给记录中未知或缺失的时区填上一个替代值。fillna函数可以替换缺失值（NA），而未知值（空字符串）则可以通过布尔型数组索引加以替换：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">31</span>]: clean_tz <span style="color:#000;font-weight:bold">=</span> frame[<span style="color:#d14">&#39;tz&#39;</span>]<span style="color:#000;font-weight:bold">.</span>fillna(<span style="color:#d14">&#39;Missing&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">32</span>]: clean_tz[clean_tz <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;&#39;</span>] <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;Unknown&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">33</span>]: tz_counts <span style="color:#000;font-weight:bold">=</span> clean_tz<span style="color:#000;font-weight:bold">.</span>value_counts()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">34</span>]: tz_counts[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">34</span>]: 
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>New_York       <span style="color:#099">1251</span>
</span></span><span style="display:flex;"><span>Unknown                 <span style="color:#099">521</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Chicago         <span style="color:#099">400</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Los_Angeles     <span style="color:#099">382</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Denver          <span style="color:#099">191</span>
</span></span><span style="display:flex;"><span>Missing                 <span style="color:#099">120</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>London            <span style="color:#099">74</span>
</span></span><span style="display:flex;"><span>Asia<span style="color:#000;font-weight:bold">/</span>Tokyo               <span style="color:#099">37</span>
</span></span><span style="display:flex;"><span>Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu         <span style="color:#099">36</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>Madrid            <span style="color:#099">35</span>
</span></span><span style="display:flex;"><span>Name: tz, dtype: int64
</span></span></code></pre></div><p>此时，我们可以用seaborn包创建水平柱状图（结果见图14-1）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">36</span>]: <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">seaborn</span> <span style="color:#000;font-weight:bold">as</span> <span style="color:#555">sns</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">37</span>]: subset <span style="color:#000;font-weight:bold">=</span> tz_counts[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">38</span>]: sns<span style="color:#000;font-weight:bold">.</span>barplot(y<span style="color:#000;font-weight:bold">=</span>subset<span style="color:#000;font-weight:bold">.</span>index, x<span style="color:#000;font-weight:bold">=</span>subset<span style="color:#000;font-weight:bold">.</span>values)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180126143.png" alt="图14-1 usa.gov示例数据中最常出现的时区"></p>
<p>a字段含有执行URL短缩操作的浏览器、设备、应用程序的相关信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">39</span>]: frame[<span style="color:#d14">&#39;a&#39;</span>][<span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">39</span>]: <span style="color:#d14">&#39;GoogleMaps/RochesterNY&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">40</span>]: frame[<span style="color:#d14">&#39;a&#39;</span>][<span style="color:#099">50</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">40</span>]: <span style="color:#d14">&#39;Mozilla/5.0 (Windows NT 5.1; rv:10.0.2)</span>
</span></span><span style="display:flex;"><span>Gecko<span style="color:#000;font-weight:bold">/</span><span style="color:#099">20100101</span> Firefox<span style="color:#000;font-weight:bold">/</span><span style="color:#099">10.0.2</span><span style="color:#d14">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">41</span>]: frame[<span style="color:#d14">&#39;a&#39;</span>][<span style="color:#099">51</span>][:<span style="color:#099">50</span>]  <span style="color:#998;font-style:italic"># long line</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">41</span>]: <span style="color:#d14">&#39;Mozilla/5.0 (Linux; U; Android 2.2.2; en-us; LG-P9&#39;</span>
</span></span></code></pre></div><p>将这些&quot;agent&quot;字符串中的所有信息都解析出来是一件挺郁闷的工作。一种策略是将这种字符串的第一节（与浏览器大致对应）分离出来并得到另外一份用户行为摘要：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">42</span>]: results <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series([x<span style="color:#000;font-weight:bold">.</span>split()[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">for</span> x <span style="color:#000;font-weight:bold">in</span> frame<span style="color:#000;font-weight:bold">.</span>a<span style="color:#000;font-weight:bold">.</span>dropna()])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">43</span>]: results[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">43</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>               Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">5.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>    GoogleMaps<span style="color:#000;font-weight:bold">/</span>RochesterNY
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>               Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>               Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">5.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>               Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">5.0</span>
</span></span><span style="display:flex;"><span>dtype: <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">44</span>]: results<span style="color:#000;font-weight:bold">.</span>value_counts()[:<span style="color:#099">8</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">44</span>]: 
</span></span><span style="display:flex;"><span>Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">5.0</span>                 <span style="color:#099">2594</span>
</span></span><span style="display:flex;"><span>Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">4.0</span>                  <span style="color:#099">601</span>
</span></span><span style="display:flex;"><span>GoogleMaps<span style="color:#000;font-weight:bold">/</span>RochesterNY       <span style="color:#099">121</span>
</span></span><span style="display:flex;"><span>Opera<span style="color:#000;font-weight:bold">/</span><span style="color:#099">9.80</span>                    <span style="color:#099">34</span>
</span></span><span style="display:flex;"><span>TEST_INTERNET_AGENT           <span style="color:#099">24</span>
</span></span><span style="display:flex;"><span>GoogleProducer                <span style="color:#099">21</span>
</span></span><span style="display:flex;"><span>Mozilla<span style="color:#000;font-weight:bold">/</span><span style="color:#099">6.0</span>                    <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>BlackBerry8520<span style="color:#000;font-weight:bold">/</span><span style="color:#099">5.0.0.681</span>       <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><p>现在，假设你想按Windows和非Windows用户对时区统计信息进行分解。为了简单起见，我们假定只要agent字符串中含有&quot;Windows&quot;就认为该用户为Windows用户。由于有的agent缺失，所以首先将它们从数据中移除：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">45</span>]: cframe <span style="color:#000;font-weight:bold">=</span> frame[frame<span style="color:#000;font-weight:bold">.</span>a<span style="color:#000;font-weight:bold">.</span>notnull()]
</span></span></code></pre></div><p>然后计算出各行是否含有Windows的值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">47</span>]: cframe[<span style="color:#d14">&#39;os&#39;</span>] <span style="color:#000;font-weight:bold">=</span> np<span style="color:#000;font-weight:bold">.</span>where(cframe[<span style="color:#d14">&#39;a&#39;</span>]<span style="color:#000;font-weight:bold">.</span>str<span style="color:#000;font-weight:bold">.</span>contains(<span style="color:#d14">&#39;Windows&#39;</span>),
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                         <span style="color:#d14">&#39;Windows&#39;</span>, <span style="color:#d14">&#39;Not Windows&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">48</span>]: cframe[<span style="color:#d14">&#39;os&#39;</span>][:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">48</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>        Windows
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>    Not Windows
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>        Windows
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>    Not Windows
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>        Windows
</span></span><span style="display:flex;"><span>Name: os, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>接下来就可以根据时区和新得到的操作系统列表对数据进行分组了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">49</span>]: by_tz_os <span style="color:#000;font-weight:bold">=</span> cframe<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;tz&#39;</span>, <span style="color:#d14">&#39;os&#39;</span>])
</span></span></code></pre></div><p>分组计数，类似于value_counts函数，可以用size来计算。并利用unstack对计数结果进行重塑：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">50</span>]: agg_counts <span style="color:#000;font-weight:bold">=</span> by_tz_os<span style="color:#000;font-weight:bold">.</span>size()<span style="color:#000;font-weight:bold">.</span>unstack()<span style="color:#000;font-weight:bold">.</span>fillna(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">51</span>]: agg_counts[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">51</span>]: 
</span></span><span style="display:flex;"><span>os                              Not Windows  Windows
</span></span><span style="display:flex;"><span>tz                                                  
</span></span><span style="display:flex;"><span>                                      <span style="color:#099">245.0</span>    <span style="color:#099">276.0</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Cairo                            <span style="color:#099">0.0</span>      <span style="color:#099">3.0</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Casablanca                       <span style="color:#099">0.0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Ceuta                            <span style="color:#099">0.0</span>      <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Johannesburg                     <span style="color:#099">0.0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Lusaka                           <span style="color:#099">0.0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Anchorage                       <span style="color:#099">4.0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Buenos_Aires          <span style="color:#099">1.0</span>      <span style="color:#099">0.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Cordoba               <span style="color:#099">0.0</span>      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Mendoza               <span style="color:#099">0.0</span>      <span style="color:#099">1.0</span>
</span></span></code></pre></div><p>最后，我们来选取最常出现的时区。为了达到这个目的，我根据agg_counts中的行数构造了一个间接索引数组：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Use to sort in ascending order</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">52</span>]: indexer <span style="color:#000;font-weight:bold">=</span> agg_counts<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">.</span>argsort()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">53</span>]: indexer[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">53</span>]: 
</span></span><span style="display:flex;"><span>tz
</span></span><span style="display:flex;"><span>                                  <span style="color:#099">24</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Cairo                      <span style="color:#099">20</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Casablanca                 <span style="color:#099">21</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Ceuta                      <span style="color:#099">92</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Johannesburg               <span style="color:#099">87</span>
</span></span><span style="display:flex;"><span>Africa<span style="color:#000;font-weight:bold">/</span>Lusaka                     <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Anchorage                 <span style="color:#099">54</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Buenos_Aires    <span style="color:#099">57</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Cordoba         <span style="color:#099">26</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Argentina<span style="color:#000;font-weight:bold">/</span>Mendoza         <span style="color:#099">55</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span></code></pre></div><p>然后我通过take按照这个顺序截取了最后10行最大值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">54</span>]: count_subset <span style="color:#000;font-weight:bold">=</span> agg_counts<span style="color:#000;font-weight:bold">.</span>take(indexer[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">10</span>:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">55</span>]: count_subset
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">55</span>]: 
</span></span><span style="display:flex;"><span>os                   Not Windows  Windows
</span></span><span style="display:flex;"><span>tz                                       
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo           <span style="color:#099">13.0</span>     <span style="color:#099">20.0</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>Madrid               <span style="color:#099">16.0</span>     <span style="color:#099">19.0</span>
</span></span><span style="display:flex;"><span>Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu             <span style="color:#099">0.0</span>     <span style="color:#099">36.0</span>
</span></span><span style="display:flex;"><span>Asia<span style="color:#000;font-weight:bold">/</span>Tokyo                   <span style="color:#099">2.0</span>     <span style="color:#099">35.0</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>London               <span style="color:#099">43.0</span>     <span style="color:#099">31.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Denver             <span style="color:#099">132.0</span>     <span style="color:#099">59.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Los_Angeles        <span style="color:#099">130.0</span>    <span style="color:#099">252.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Chicago            <span style="color:#099">115.0</span>    <span style="color:#099">285.0</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#099">245.0</span>    <span style="color:#099">276.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>New_York           <span style="color:#099">339.0</span>    <span style="color:#099">912.0</span>
</span></span></code></pre></div><p>pandas有一个简便方法nlargest，可以做同样的工作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">56</span>]: agg_counts<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">.</span>nlargest(<span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">56</span>]: 
</span></span><span style="display:flex;"><span>tz
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>New_York       <span style="color:#099">1251.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#099">521.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Chicago         <span style="color:#099">400.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Los_Angeles     <span style="color:#099">382.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Denver          <span style="color:#099">191.0</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>London            <span style="color:#099">74.0</span>
</span></span><span style="display:flex;"><span>Asia<span style="color:#000;font-weight:bold">/</span>Tokyo               <span style="color:#099">37.0</span>
</span></span><span style="display:flex;"><span>Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu         <span style="color:#099">36.0</span>
</span></span><span style="display:flex;"><span>Europe<span style="color:#000;font-weight:bold">/</span>Madrid            <span style="color:#099">35.0</span>
</span></span><span style="display:flex;"><span>America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo        <span style="color:#099">33.0</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span></code></pre></div><p>然后，如这段代码所示，可以用柱状图表示。我传递一个额外参数到seaborn的barpolt函数，来画一个堆积条形图（见图14-2）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Rearrange the data for plotting</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">58</span>]: count_subset <span style="color:#000;font-weight:bold">=</span> count_subset<span style="color:#000;font-weight:bold">.</span>stack()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">59</span>]: count_subset<span style="color:#000;font-weight:bold">.</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;total&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">60</span>]: count_subset <span style="color:#000;font-weight:bold">=</span> count_subset<span style="color:#000;font-weight:bold">.</span>reset_index()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">61</span>]: count_subset[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">61</span>]: 
</span></span><span style="display:flex;"><span>                  tz           os  total
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>  America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo  Not Windows   <span style="color:#099">13.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>  America<span style="color:#000;font-weight:bold">/</span>Sao_Paulo      Windows   <span style="color:#099">20.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>      Europe<span style="color:#000;font-weight:bold">/</span>Madrid  Not Windows   <span style="color:#099">16.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>      Europe<span style="color:#000;font-weight:bold">/</span>Madrid      Windows   <span style="color:#099">19.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>   Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu  Not Windows    <span style="color:#099">0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>   Pacific<span style="color:#000;font-weight:bold">/</span>Honolulu      Windows   <span style="color:#099">36.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>         Asia<span style="color:#000;font-weight:bold">/</span>Tokyo  Not Windows    <span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">7</span>         Asia<span style="color:#000;font-weight:bold">/</span>Tokyo      Windows   <span style="color:#099">35.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">8</span>      Europe<span style="color:#000;font-weight:bold">/</span>London  Not Windows   <span style="color:#099">43.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">9</span>      Europe<span style="color:#000;font-weight:bold">/</span>London      Windows   <span style="color:#099">31.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">62</span>]: sns<span style="color:#000;font-weight:bold">.</span>barplot(x<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;total&#39;</span>, y<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;tz&#39;</span>, hue<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;os&#39;</span>,  data<span style="color:#000;font-weight:bold">=</span>count_subset)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180143099.png" alt="图14-2 最常出现时区的Windows和非Windows用户"></p>
<p>这张图不容易看出Windows用户在小分组中的相对比例，因此标准化分组百分比之和为1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">norm_total</span>(group):
</span></span><span style="display:flex;"><span>    group[<span style="color:#d14">&#39;normed_total&#39;</span>] <span style="color:#000;font-weight:bold">=</span> group<span style="color:#000;font-weight:bold">.</span>total <span style="color:#000;font-weight:bold">/</span> group<span style="color:#000;font-weight:bold">.</span>total<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> group
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#000;font-weight:bold">=</span> count_subset<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;tz&#39;</span>)<span style="color:#000;font-weight:bold">.</span>apply(norm_total)
</span></span></code></pre></div><p>再次画图，见图14-3：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">65</span>]: sns<span style="color:#000;font-weight:bold">.</span>barplot(x<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;normed_total&#39;</span>, y<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;tz&#39;</span>, hue<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;os&#39;</span>,  data<span style="color:#000;font-weight:bold">=</span>results)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180149689.png" alt="图14-3 最常出现时区的Windows和非Windows用户的百分比"></p>
<p>我们还可以用groupby的transform方法，更高效的计算标准化的和：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">66</span>]: g <span style="color:#000;font-weight:bold">=</span> count_subset<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;tz&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">67</span>]: results2 <span style="color:#000;font-weight:bold">=</span> count_subset<span style="color:#000;font-weight:bold">.</span>total <span style="color:#000;font-weight:bold">/</span> g<span style="color:#000;font-weight:bold">.</span>total<span style="color:#000;font-weight:bold">.</span>transform(<span style="color:#d14">&#39;sum&#39;</span>)
</span></span></code></pre></div><h2 id="142-movielens-1m数据集">14.2 MovieLens 1M数据集</h2>
<p>GroupLens Research（http://www.grouplens.org/node/73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。</p>
<p>MovieLens 1M数据集含有来自6000名用户对4000部电影的100万条评分数据。它分为三个表：评分、用户信息和电影信息。将该数据从zip文件中解压出来之后，可以通过pandas.read_table将各个表分别读到一个pandas DataFrame对象中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="color:#000;font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Make display smaller</span>
</span></span><span style="display:flex;"><span>pd<span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">.</span>display<span style="color:#000;font-weight:bold">.</span>max_rows <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unames <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;user_id&#39;</span>, <span style="color:#d14">&#39;gender&#39;</span>, <span style="color:#d14">&#39;age&#39;</span>, <span style="color:#d14">&#39;occupation&#39;</span>, <span style="color:#d14">&#39;zip&#39;</span>]
</span></span><span style="display:flex;"><span>users <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_table(<span style="color:#d14">&#39;datasets/movielens/users.dat&#39;</span>, sep<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;::&#39;</span>,
</span></span><span style="display:flex;"><span>                      header<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">None</span>, names<span style="color:#000;font-weight:bold">=</span>unames)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rnames <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;user_id&#39;</span>, <span style="color:#d14">&#39;movie_id&#39;</span>, <span style="color:#d14">&#39;rating&#39;</span>, <span style="color:#d14">&#39;timestamp&#39;</span>]
</span></span><span style="display:flex;"><span>ratings <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_table(<span style="color:#d14">&#39;datasets/movielens/ratings.dat&#39;</span>, sep<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;::&#39;</span>,
</span></span><span style="display:flex;"><span>                        header<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">None</span>, names<span style="color:#000;font-weight:bold">=</span>rnames)
</span></span><span style="display:flex;"><span>mnames <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;movie_id&#39;</span>, <span style="color:#d14">&#39;title&#39;</span>, <span style="color:#d14">&#39;genres&#39;</span>]
</span></span><span style="display:flex;"><span>movies <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_table(<span style="color:#d14">&#39;datasets/movielens/movies.dat&#39;</span>, sep<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;::&#39;</span>,
</span></span><span style="display:flex;"><span>                       header<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">None</span>, names<span style="color:#000;font-weight:bold">=</span>mnames)
</span></span></code></pre></div><p>利用Python的切片语法，通过查看每个DataFrame的前几行即可验证数据加载工作是否一切顺利：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">69</span>]: users[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">69</span>]: 
</span></span><span style="display:flex;"><span>   user_id gender  age  occupation    <span style="color:#0086b3">zip</span>
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>        <span style="color:#099">1</span>      F    <span style="color:#099">1</span>          <span style="color:#099">10</span>  <span style="color:#099">48067</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>        <span style="color:#099">2</span>      M   <span style="color:#099">56</span>          <span style="color:#099">16</span>  <span style="color:#099">70072</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>        <span style="color:#099">3</span>      M   <span style="color:#099">25</span>          <span style="color:#099">15</span>  <span style="color:#099">55117</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>        <span style="color:#099">4</span>      M   <span style="color:#099">45</span>           <span style="color:#099">7</span>  <span style="color:#099">02460</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>        <span style="color:#099">5</span>      M   <span style="color:#099">25</span>          <span style="color:#099">20</span>  <span style="color:#099">55455</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">70</span>]: ratings[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">70</span>]: 
</span></span><span style="display:flex;"><span>   user_id  movie_id  rating  timestamp
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>        <span style="color:#099">1</span>      <span style="color:#099">1193</span>       <span style="color:#099">5</span>  <span style="color:#099">978300760</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>        <span style="color:#099">1</span>       <span style="color:#099">661</span>       <span style="color:#099">3</span>  <span style="color:#099">978302109</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>        <span style="color:#099">1</span>       <span style="color:#099">914</span>       <span style="color:#099">3</span>  <span style="color:#099">978301968</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>        <span style="color:#099">1</span>      <span style="color:#099">3408</span>       <span style="color:#099">4</span>  <span style="color:#099">978300275</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>        <span style="color:#099">1</span>      <span style="color:#099">2355</span>       <span style="color:#099">5</span>  <span style="color:#099">978824291</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">71</span>]: movies[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">71</span>]: 
</span></span><span style="display:flex;"><span>   movie_id                               title                        genres
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>         <span style="color:#099">1</span>                    Toy Story (<span style="color:#099">1995</span>)   Animation<span style="color:#000;font-weight:bold">|</span>Children<span style="color:#d14">&#39;s|Comedy</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>         <span style="color:#099">2</span>                      Jumanji (<span style="color:#099">1995</span>)  Adventure<span style="color:#000;font-weight:bold">|</span>Children<span style="color:#d14">&#39;s|Fantasy</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>         <span style="color:#099">3</span>             Grumpier Old Men (<span style="color:#099">1995</span>)                Comedy<span style="color:#000;font-weight:bold">|</span>Romance
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>         <span style="color:#099">4</span>            Waiting to Exhale (<span style="color:#099">1995</span>)                  Comedy<span style="color:#000;font-weight:bold">|</span>Drama
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>         <span style="color:#099">5</span>  Father of the Bride Part II (<span style="color:#099">1995</span>)                        Comedy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">72</span>]: ratings
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">72</span>]: 
</span></span><span style="display:flex;"><span>         user_id  movie_id  rating  timestamp
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>              <span style="color:#099">1</span>      <span style="color:#099">1193</span>       <span style="color:#099">5</span>  <span style="color:#099">978300760</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>              <span style="color:#099">1</span>       <span style="color:#099">661</span>       <span style="color:#099">3</span>  <span style="color:#099">978302109</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>              <span style="color:#099">1</span>       <span style="color:#099">914</span>       <span style="color:#099">3</span>  <span style="color:#099">978301968</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>              <span style="color:#099">1</span>      <span style="color:#099">3408</span>       <span style="color:#099">4</span>  <span style="color:#099">978300275</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>              <span style="color:#099">1</span>      <span style="color:#099">2355</span>       <span style="color:#099">5</span>  <span style="color:#099">978824291</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>          <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>     <span style="color:#000;font-weight:bold">...</span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000204</span>     <span style="color:#099">6040</span>      <span style="color:#099">1091</span>       <span style="color:#099">1</span>  <span style="color:#099">956716541</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000205</span>     <span style="color:#099">6040</span>      <span style="color:#099">1094</span>       <span style="color:#099">5</span>  <span style="color:#099">956704887</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000206</span>     <span style="color:#099">6040</span>       <span style="color:#099">562</span>       <span style="color:#099">5</span>  <span style="color:#099">956704746</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000207</span>     <span style="color:#099">6040</span>      <span style="color:#099">1096</span>       <span style="color:#099">4</span>  <span style="color:#099">956715648</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000208</span>     <span style="color:#099">6040</span>      <span style="color:#099">1097</span>       <span style="color:#099">4</span>  <span style="color:#099">956715569</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">1000209</span> rows x <span style="color:#099">4</span> columns]
</span></span></code></pre></div><p>注意，其中的年龄和职业是以编码形式给出的，它们的具体含义请参考该数据集的README文件。分析散布在三个表中的数据可不是一件轻松的事情。假设我们想要根据性别和年龄计算某部电影的平均得分，如果将所有数据都合并到一个表中的话问题就简单多了。我们先用pandas的merge函数将ratings跟users合并到一起，然后再将movies也合并进去。pandas会根据列名的重叠情况推断出哪些列是合并（或连接）键：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">73</span>]: data <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>merge(pd<span style="color:#000;font-weight:bold">.</span>merge(ratings, users), movies)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">74</span>]: data
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">74</span>]: 
</span></span><span style="display:flex;"><span>         user_id  movie_id  rating  timestamp gender  age  occupation    <span style="color:#0086b3">zip</span>  \
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>              <span style="color:#099">1</span>      <span style="color:#099">1193</span>       <span style="color:#099">5</span>  <span style="color:#099">978300760</span>      F    <span style="color:#099">1</span>          <span style="color:#099">10</span>  <span style="color:#099">48067</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>              <span style="color:#099">2</span>      <span style="color:#099">1193</span>       <span style="color:#099">5</span>  <span style="color:#099">978298413</span>      M   <span style="color:#099">56</span>          <span style="color:#099">16</span>  <span style="color:#099">70072</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>             <span style="color:#099">12</span>      <span style="color:#099">1193</span>       <span style="color:#099">4</span>  <span style="color:#099">978220179</span>      M   <span style="color:#099">25</span>          <span style="color:#099">12</span>  <span style="color:#099">32793</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>             <span style="color:#099">15</span>      <span style="color:#099">1193</span>       <span style="color:#099">4</span>  <span style="color:#099">978199279</span>      M   <span style="color:#099">25</span>           <span style="color:#099">7</span>  <span style="color:#099">22903</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>             <span style="color:#099">17</span>      <span style="color:#099">1193</span>       <span style="color:#099">5</span>  <span style="color:#099">978158471</span>      M   <span style="color:#099">50</span>           <span style="color:#099">1</span>  <span style="color:#099">95350</span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>          <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>     <span style="color:#000;font-weight:bold">...</span>        <span style="color:#000;font-weight:bold">...</span>    <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">...</span>         <span style="color:#000;font-weight:bold">...</span>    <span style="color:#000;font-weight:bold">...</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1000204</span>     <span style="color:#099">5949</span>      <span style="color:#099">2198</span>       <span style="color:#099">5</span>  <span style="color:#099">958846401</span>      M   <span style="color:#099">18</span>          <span style="color:#099">17</span>  <span style="color:#099">47901</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1000205</span>     <span style="color:#099">5675</span>      <span style="color:#099">2703</span>       <span style="color:#099">3</span>  <span style="color:#099">976029116</span>      M   <span style="color:#099">35</span>          <span style="color:#099">14</span>  <span style="color:#099">30030</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1000206</span>     <span style="color:#099">5780</span>      <span style="color:#099">2845</span>       <span style="color:#099">1</span>  <span style="color:#099">958153068</span>      M   <span style="color:#099">18</span>          <span style="color:#099">17</span>  <span style="color:#099">92886</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1000207</span>     <span style="color:#099">5851</span>      <span style="color:#099">3607</span>       <span style="color:#099">5</span>  <span style="color:#099">957756608</span>      F   <span style="color:#099">18</span>          <span style="color:#099">20</span>  <span style="color:#099">55410</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1000208</span>     <span style="color:#099">5938</span>      <span style="color:#099">2909</span>       <span style="color:#099">4</span>  <span style="color:#099">957273353</span>      M   <span style="color:#099">25</span>           <span style="color:#099">1</span>  <span style="color:#099">35401</span>   
</span></span><span style="display:flex;"><span>                                               title                genres  
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>             One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)                 Drama  </span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>             One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)                 Drama  </span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>             One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)                 Drama  </span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>             One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)                 Drama  </span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>             One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)                 Drama  </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                                              <span style="color:#000;font-weight:bold">...</span>                   <span style="color:#000;font-weight:bold">...</span>  
</span></span><span style="display:flex;"><span><span style="color:#099">1000204</span>                           Modulations (<span style="color:#099">1998</span>)           Documentary  
</span></span><span style="display:flex;"><span><span style="color:#099">1000205</span>                        Broken Vessels (<span style="color:#099">1998</span>)                 Drama  
</span></span><span style="display:flex;"><span><span style="color:#099">1000206</span>                            White Boys (<span style="color:#099">1999</span>)                 Drama  
</span></span><span style="display:flex;"><span><span style="color:#099">1000207</span>                     One Little Indian (<span style="color:#099">1973</span>)  Comedy<span style="color:#000;font-weight:bold">|</span>Drama<span style="color:#000;font-weight:bold">|</span>Western  
</span></span><span style="display:flex;"><span><span style="color:#099">1000208</span>  Five Wives, Three Secretaries <span style="color:#000;font-weight:bold">and</span> Me (<span style="color:#099">1998</span>)           Documentary  
</span></span><span style="display:flex;"><span>[<span style="color:#099">1000209</span> rows x <span style="color:#099">10</span> columns]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">75</span>]: data<span style="color:#000;font-weight:bold">.</span>iloc[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">75</span>]: 
</span></span><span style="display:flex;"><span>user_id                                            <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>movie_id                                        <span style="color:#099">1193</span>
</span></span><span style="display:flex;"><span>rating                                             <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>timestamp                                  <span style="color:#099">978300760</span>
</span></span><span style="display:flex;"><span>gender                                             F
</span></span><span style="display:flex;"><span>age                                                <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>occupation                                        <span style="color:#099">10</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">zip</span>                                            <span style="color:#099">48067</span>
</span></span><span style="display:flex;"><span>title         One Flew Over the Cuckoo<span style="color:#d14">&#39;s Nest (1975)</span>
</span></span><span style="display:flex;"><span>genres                                         Drama
</span></span><span style="display:flex;"><span>Name: <span style="color:#099">0</span>, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>为了按性别计算每部电影的平均得分，我们可以使用pivot_table方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">76</span>]: mean_ratings <span style="color:#000;font-weight:bold">=</span> data<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;rating&#39;</span>, index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;title&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                                 columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;gender&#39;</span>, aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;mean&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">77</span>]: mean_ratings[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">77</span>]: 
</span></span><span style="display:flex;"><span>gender                                F         M
</span></span><span style="display:flex;"><span>title                                            
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">1</span>,<span style="color:#099">000</span>,<span style="color:#099">000</span> Duck (<span style="color:#099">1971</span>)         <span style="color:#099">3.375000</span>  <span style="color:#099">2.761905</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;Night Mother (1986)           3.388889  3.352941</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;Til There Was You (1997)      2.675676  2.733333</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;burbs, The (1989)             2.793478  2.962085</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>And Justice <span style="color:#000;font-weight:bold">for</span> All (<span style="color:#099">1979</span>)  <span style="color:#099">3.828571</span>  <span style="color:#099">3.689024</span>
</span></span></code></pre></div><p>该操作产生了另一个DataFrame，其内容为电影平均得分，行标为电影名称（索引），列标为性别。现在，我打算过滤掉评分数据不够250条的电影（随便选的一个数字）。为了达到这个目的，我先对title进行分组，然后利用size()得到一个含有各电影分组大小的Series对象：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">78</span>]: ratings_by_title <span style="color:#000;font-weight:bold">=</span> data<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;title&#39;</span>)<span style="color:#000;font-weight:bold">.</span>size()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">79</span>]: ratings_by_title[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">79</span>]: 
</span></span><span style="display:flex;"><span>title
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">1</span>,<span style="color:#099">000</span>,<span style="color:#099">000</span> Duck (<span style="color:#099">1971</span>)                <span style="color:#099">37</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;Night Mother (1986)                  70</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;Til There Was You (1997)             52</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;burbs, The (1989)                   303</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>And Justice <span style="color:#000;font-weight:bold">for</span> All (<span style="color:#099">1979</span>)        <span style="color:#099">199</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">900</span> (<span style="color:#099">1994</span>)                           <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span><span style="color:#099">10</span> Things I Hate About You (<span style="color:#099">1999</span>)    <span style="color:#099">700</span>
</span></span><span style="display:flex;"><span><span style="color:#099">101</span> Dalmatians (<span style="color:#099">1961</span>)                <span style="color:#099">565</span>
</span></span><span style="display:flex;"><span><span style="color:#099">101</span> Dalmatians (<span style="color:#099">1996</span>)                <span style="color:#099">364</span>
</span></span><span style="display:flex;"><span><span style="color:#099">12</span> Angry Men (<span style="color:#099">1957</span>)                  <span style="color:#099">616</span>
</span></span><span style="display:flex;"><span>dtype: int64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">80</span>]: active_titles <span style="color:#000;font-weight:bold">=</span> ratings_by_title<span style="color:#000;font-weight:bold">.</span>index[ratings_by_title <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">250</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">81</span>]: active_titles
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">81</span>]: 
</span></span><span style="display:flex;"><span>Index([<span style="color:#d14">&#39;&#39;</span>burbs, The (<span style="color:#099">1989</span>)<span style="color:#d14">&#39;, &#39;</span><span style="color:#099">10</span> Things I Hate About You (<span style="color:#099">1999</span>)<span style="color:#d14">&#39;,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;101 Dalmatians (1961)&#39;</span>, <span style="color:#d14">&#39;101 Dalmatians (1996)&#39;</span>, <span style="color:#d14">&#39;12 Angry Men (1957)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;13th Warrior, The (1999)&#39;</span>, <span style="color:#d14">&#39;2 Days in the Valley (1996)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;20,000 Leagues Under the Sea (1954)&#39;</span>, <span style="color:#d14">&#39;2001: A Space Odyssey (1968)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;2010 (1984)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;X-Men (2000)&#39;</span>, <span style="color:#d14">&#39;Year of Living Dangerously (1982)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Yellow Submarine (1968)&#39;</span>, <span style="color:#d14">&#39;You&#39;</span>ve Got Mail (<span style="color:#099">1998</span>)<span style="color:#d14">&#39;,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Young Frankenstein (1974)&#39;</span>, <span style="color:#d14">&#39;Young Guns (1988)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Young Guns II (1990)&#39;</span>, <span style="color:#d14">&#39;Young Sherlock Holmes (1985)&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Zero Effect (1998)&#39;</span>, <span style="color:#d14">&#39;eXistenZ (1999)&#39;</span>],
</span></span><span style="display:flex;"><span>      dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;object&#39;</span>, name<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;title&#39;</span>, length<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1216</span>)
</span></span></code></pre></div><p>标题索引中含有评分数据大于250条的电影名称，然后我们就可以据此从前面的mean_ratings中选取所需的行了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Select rows on the index</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">82</span>]: mean_ratings <span style="color:#000;font-weight:bold">=</span> mean_ratings<span style="color:#000;font-weight:bold">.</span>loc[active_titles]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">83</span>]: mean_ratings
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">83</span>]: 
</span></span><span style="display:flex;"><span>gender                                    F         M
</span></span><span style="display:flex;"><span>title                                                
</span></span><span style="display:flex;"><span><span style="color:#d14">&#39;burbs, The (1989)                 2.793478  2.962085</span>
</span></span><span style="display:flex;"><span><span style="color:#099">10</span> Things I Hate About You (<span style="color:#099">1999</span>)  <span style="color:#099">3.646552</span>  <span style="color:#099">3.311966</span>
</span></span><span style="display:flex;"><span><span style="color:#099">101</span> Dalmatians (<span style="color:#099">1961</span>)              <span style="color:#099">3.791444</span>  <span style="color:#099">3.500000</span>
</span></span><span style="display:flex;"><span><span style="color:#099">101</span> Dalmatians (<span style="color:#099">1996</span>)              <span style="color:#099">3.240000</span>  <span style="color:#099">2.911215</span>
</span></span><span style="display:flex;"><span><span style="color:#099">12</span> Angry Men (<span style="color:#099">1957</span>)                <span style="color:#099">4.184397</span>  <span style="color:#099">4.328421</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                                     <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>Young Guns (<span style="color:#099">1988</span>)                  <span style="color:#099">3.371795</span>  <span style="color:#099">3.425620</span>
</span></span><span style="display:flex;"><span>Young Guns II (<span style="color:#099">1990</span>)               <span style="color:#099">2.934783</span>  <span style="color:#099">2.904025</span>
</span></span><span style="display:flex;"><span>Young Sherlock Holmes (<span style="color:#099">1985</span>)       <span style="color:#099">3.514706</span>  <span style="color:#099">3.363344</span>
</span></span><span style="display:flex;"><span>Zero Effect (<span style="color:#099">1998</span>)                 <span style="color:#099">3.864407</span>  <span style="color:#099">3.723140</span>
</span></span><span style="display:flex;"><span>eXistenZ (<span style="color:#099">1999</span>)                    <span style="color:#099">3.098592</span>  <span style="color:#099">3.289086</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">1216</span> rows x <span style="color:#099">2</span> columns]
</span></span></code></pre></div><p>为了了解女性观众最喜欢的电影，我们可以对F列降序排列：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">85</span>]: top_female_ratings <span style="color:#000;font-weight:bold">=</span> mean_ratings<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;F&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">86</span>]: top_female_ratings[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">86</span>]: 
</span></span><span style="display:flex;"><span>gender                                                     F         M
</span></span><span style="display:flex;"><span>title                                                                 
</span></span><span style="display:flex;"><span>Close Shave, A (<span style="color:#099">1995</span>)                               <span style="color:#099">4.644444</span>  <span style="color:#099">4.473795</span>
</span></span><span style="display:flex;"><span>Wrong Trousers, The (<span style="color:#099">1993</span>)                          <span style="color:#099">4.588235</span>  <span style="color:#099">4.478261</span>
</span></span><span style="display:flex;"><span>Sunset Blvd<span style="color:#000;font-weight:bold">.</span> (a<span style="color:#000;font-weight:bold">.</span>k<span style="color:#000;font-weight:bold">.</span>a<span style="color:#000;font-weight:bold">.</span> Sunset Boulevard) (<span style="color:#099">1950</span>)       <span style="color:#099">4.572650</span>  <span style="color:#099">4.464589</span>
</span></span><span style="display:flex;"><span>Wallace <span style="color:#000;font-weight:bold">&amp;</span> Gromit: The Best of Aardman Animation<span style="color:#000;font-weight:bold">...</span>  <span style="color:#099">4.563107</span>  <span style="color:#099">4.385075</span>
</span></span><span style="display:flex;"><span>Schindler<span style="color:#d14">&#39;s List (1993)                             4.562602  4.491415</span>
</span></span><span style="display:flex;"><span>Shawshank Redemption, The (<span style="color:#099">1994</span>)                    <span style="color:#099">4.539075</span>  <span style="color:#099">4.560625</span>
</span></span><span style="display:flex;"><span>Grand Day Out, A (<span style="color:#099">1992</span>)                             <span style="color:#099">4.537879</span>  <span style="color:#099">4.293255</span>
</span></span><span style="display:flex;"><span>To Kill a Mockingbird (<span style="color:#099">1962</span>)                        <span style="color:#099">4.536667</span>  <span style="color:#099">4.372611</span>
</span></span><span style="display:flex;"><span>Creature Comforts (<span style="color:#099">1990</span>)                            <span style="color:#099">4.513889</span>  <span style="color:#099">4.272277</span>
</span></span><span style="display:flex;"><span>Usual Suspects, The (<span style="color:#099">1995</span>)                          <span style="color:#099">4.513317</span>  <span style="color:#099">4.518248</span>
</span></span></code></pre></div><h3 id="1421-计算评分分歧">14.2.1 计算评分分歧</h3>
<p>假设我们想要找出男性和女性观众分歧最大的电影。一个办法是给mean_ratings加上一个用于存放平均得分之差的列，并对其进行排序：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">87</span>]: mean_ratings[<span style="color:#d14">&#39;diff&#39;</span>] <span style="color:#000;font-weight:bold">=</span> mean_ratings[<span style="color:#d14">&#39;M&#39;</span>] <span style="color:#000;font-weight:bold">-</span> mean_ratings[<span style="color:#d14">&#39;F&#39;</span>]
</span></span></code></pre></div><p>按&quot;diff&quot;排序即可得到分歧最大且女性观众更喜欢的电影：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">88</span>]: sorted_by_diff <span style="color:#000;font-weight:bold">=</span> mean_ratings<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;diff&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">89</span>]: sorted_by_diff[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">89</span>]: 
</span></span><span style="display:flex;"><span>gender                                        F         M      diff
</span></span><span style="display:flex;"><span>title                                                              
</span></span><span style="display:flex;"><span>Dirty Dancing (<span style="color:#099">1987</span>)                   <span style="color:#099">3.790378</span>  <span style="color:#099">2.959596</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.830782</span>
</span></span><span style="display:flex;"><span>Jumpin<span style="color:#d14">&#39; Jack Flash (1986)              3.254717  2.578358 -0.676359</span>
</span></span><span style="display:flex;"><span>Grease (<span style="color:#099">1978</span>)                          <span style="color:#099">3.975265</span>  <span style="color:#099">3.367041</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.608224</span>
</span></span><span style="display:flex;"><span>Little Women (<span style="color:#099">1994</span>)                    <span style="color:#099">3.870588</span>  <span style="color:#099">3.321739</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.548849</span>
</span></span><span style="display:flex;"><span>Steel Magnolias (<span style="color:#099">1989</span>)                 <span style="color:#099">3.901734</span>  <span style="color:#099">3.365957</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.535777</span>
</span></span><span style="display:flex;"><span>Anastasia (<span style="color:#099">1997</span>)                       <span style="color:#099">3.800000</span>  <span style="color:#099">3.281609</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.518391</span>
</span></span><span style="display:flex;"><span>Rocky Horror Picture Show, The (<span style="color:#099">1975</span>)  <span style="color:#099">3.673016</span>  <span style="color:#099">3.160131</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.512885</span>
</span></span><span style="display:flex;"><span>Color Purple, The (<span style="color:#099">1985</span>)               <span style="color:#099">4.158192</span>  <span style="color:#099">3.659341</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.498851</span>
</span></span><span style="display:flex;"><span>Age of Innocence, The (<span style="color:#099">1993</span>)           <span style="color:#099">3.827068</span>  <span style="color:#099">3.339506</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.487561</span>
</span></span><span style="display:flex;"><span>Free Willy (<span style="color:#099">1993</span>)                      <span style="color:#099">2.921348</span>  <span style="color:#099">2.438776</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">0.482573</span>
</span></span></code></pre></div><p>对排序结果反序并取出前10行，得到的则是男性观众更喜欢的电影：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Reverse order of rows, take first 10 rows</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">90</span>]: sorted_by_diff[::<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>][:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">90</span>]: 
</span></span><span style="display:flex;"><span>gender                                         F         M      diff
</span></span><span style="display:flex;"><span>title                                                               
</span></span><span style="display:flex;"><span>Good, The Bad <span style="color:#000;font-weight:bold">and</span> The Ugly, The (<span style="color:#099">1966</span>)  <span style="color:#099">3.494949</span>  <span style="color:#099">4.221300</span>  <span style="color:#099">0.726351</span>
</span></span><span style="display:flex;"><span>Kentucky Fried Movie, The (<span style="color:#099">1977</span>)        <span style="color:#099">2.878788</span>  <span style="color:#099">3.555147</span>  <span style="color:#099">0.676359</span>
</span></span><span style="display:flex;"><span>Dumb <span style="color:#000;font-weight:bold">&amp;</span> Dumber (<span style="color:#099">1994</span>)                    <span style="color:#099">2.697987</span>  <span style="color:#099">3.336595</span>  <span style="color:#099">0.638608</span>
</span></span><span style="display:flex;"><span>Longest Day, The (<span style="color:#099">1962</span>)                 <span style="color:#099">3.411765</span>  <span style="color:#099">4.031447</span>  <span style="color:#099">0.619682</span>
</span></span><span style="display:flex;"><span>Cable Guy, The (<span style="color:#099">1996</span>)                   <span style="color:#099">2.250000</span>  <span style="color:#099">2.863787</span>  <span style="color:#099">0.613787</span>
</span></span><span style="display:flex;"><span>Evil Dead II (Dead By Dawn) (<span style="color:#099">1987</span>)      <span style="color:#099">3.297297</span>  <span style="color:#099">3.909283</span>  <span style="color:#099">0.611985</span>
</span></span><span style="display:flex;"><span>Hidden, The (<span style="color:#099">1987</span>)                      <span style="color:#099">3.137931</span>  <span style="color:#099">3.745098</span>  <span style="color:#099">0.607167</span>
</span></span><span style="display:flex;"><span>Rocky III (<span style="color:#099">1982</span>)                        <span style="color:#099">2.361702</span>  <span style="color:#099">2.943503</span>  <span style="color:#099">0.581801</span>
</span></span><span style="display:flex;"><span>Caddyshack (<span style="color:#099">1980</span>)                       <span style="color:#099">3.396135</span>  <span style="color:#099">3.969737</span>  <span style="color:#099">0.573602</span>
</span></span><span style="display:flex;"><span>For a Few Dollars More (<span style="color:#099">1965</span>)           <span style="color:#099">3.409091</span>  <span style="color:#099">3.953795</span>  <span style="color:#099">0.544704</span>
</span></span></code></pre></div><p>如果只是想要找出分歧最大的电影（不考虑性别因素），则可以计算得分数据的方差或标准差：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Standard deviation of rating grouped by title</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">91</span>]: rating_std_by_title <span style="color:#000;font-weight:bold">=</span> data<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;title&#39;</span>)[<span style="color:#d14">&#39;rating&#39;</span>]<span style="color:#000;font-weight:bold">.</span>std()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Filter down to active_titles</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">92</span>]: rating_std_by_title <span style="color:#000;font-weight:bold">=</span> rating_std_by_title<span style="color:#000;font-weight:bold">.</span>loc[active_titles]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Order Series by value in descending order</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">93</span>]: rating_std_by_title<span style="color:#000;font-weight:bold">.</span>sort_values(ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">93</span>]: 
</span></span><span style="display:flex;"><span>title
</span></span><span style="display:flex;"><span>Dumb <span style="color:#000;font-weight:bold">&amp;</span> Dumber (<span style="color:#099">1994</span>)                     <span style="color:#099">1.321333</span>
</span></span><span style="display:flex;"><span>Blair Witch Project, The (<span style="color:#099">1999</span>)          <span style="color:#099">1.316368</span>
</span></span><span style="display:flex;"><span>Natural Born Killers (<span style="color:#099">1994</span>)              <span style="color:#099">1.307198</span>
</span></span><span style="display:flex;"><span>Tank Girl (<span style="color:#099">1995</span>)                         <span style="color:#099">1.277695</span>
</span></span><span style="display:flex;"><span>Rocky Horror Picture Show, The (<span style="color:#099">1975</span>)    <span style="color:#099">1.260177</span>
</span></span><span style="display:flex;"><span>Eyes Wide Shut (<span style="color:#099">1999</span>)                    <span style="color:#099">1.259624</span>
</span></span><span style="display:flex;"><span>Evita (<span style="color:#099">1996</span>)                             <span style="color:#099">1.253631</span>
</span></span><span style="display:flex;"><span>Billy Madison (<span style="color:#099">1995</span>)                     <span style="color:#099">1.249970</span>
</span></span><span style="display:flex;"><span>Fear <span style="color:#000;font-weight:bold">and</span> Loathing <span style="color:#000;font-weight:bold">in</span> Las Vegas (<span style="color:#099">1998</span>)    <span style="color:#099">1.246408</span>
</span></span><span style="display:flex;"><span>Bicentennial Man (<span style="color:#099">1999</span>)                  <span style="color:#099">1.245533</span>
</span></span><span style="display:flex;"><span>Name: rating, dtype: float64
</span></span></code></pre></div><p>可能你已经注意到了，电影分类是以竖线（|）分隔的字符串形式给出的。如果想对电影分类进行分析的话，就需要先将其转换成更有用的形式才行。</p>
<h2 id="143-1880-2010年间全美婴儿姓名">14.3 1880-2010年间全美婴儿姓名</h2>
<p>美国社会保障总署（SSA）提供了一份从1880年到现在的婴儿名字频率数据。Hadley Wickham（许多流行R包的作者）经常用这份数据来演示R的数据处理功能。</p>
<p>我们要做一些数据规整才能加载这个数据集，这么做就会产生一个如下的DataFrame：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">4</span>]: names<span style="color:#000;font-weight:bold">.</span>head(<span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">4</span>]:
</span></span><span style="display:flex;"><span>        name sex  births  year
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>       Mary   F    <span style="color:#099">7065</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>       Anna   F    <span style="color:#099">2604</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>       Emma   F    <span style="color:#099">2003</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>  Elizabeth   F    <span style="color:#099">1939</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>     Minnie   F    <span style="color:#099">1746</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>   Margaret   F    <span style="color:#099">1578</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>        Ida   F    <span style="color:#099">1472</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">7</span>      Alice   F    <span style="color:#099">1414</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">8</span>     Bertha   F    <span style="color:#099">1320</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">9</span>      Sarah   F    <span style="color:#099">1288</span>  <span style="color:#099">1880</span>
</span></span></code></pre></div><p>你可以用这个数据集做很多事，例如：</p>
<ul>
<li>计算指定名字（可以是你自己的，也可以是别人的）的年度比例。</li>
<li>计算某个名字的相对排名。</li>
<li>计算各年度最流行的名字，以及增长或减少最快的名字。</li>
<li>分析名字趋势：元音、辅音、长度、总体多样性、拼写变化、首尾字母等。</li>
<li>分析外源性趋势：圣经中的名字、名人、人口结构变化等。</li>
</ul>
<p>利用前面介绍过的那些工具，这些分析工作都能很轻松地完成，我会讲解其中的一些。</p>
<p>到编写本书时为止，美国社会保障总署将该数据库按年度制成了多个数据文件，其中给出了每个性别/名字组合的出生总数。这些文件的原始档案可以在这里获取：<a href="http://www.ssa.gov/oact/babynames/limits.html">http://www.ssa.gov/oact/babynames/limits.html</a>。</p>
<p>如果你在阅读本书的时候这个页面已经不见了，也可以用搜索引擎找找。</p>
<p>下载&quot;National data&quot;文件names.zip，解压后的目录中含有一组文件（如yob1880.txt）。我用UNIX的head命令查看了其中一个文件的前10行（在Windows上，你可以用more命令，或直接在文本编辑器中打开）：</p>
<pre tabindex="0"><code>In [94]: !head -n 10 datasets/babynames/yob1880.txt
Mary,F,7065
Anna,F,2604
Emma,F,2003
Elizabeth,F,1939
Minnie,F,1746
Margaret,F,1578
Ida,F,1472
Alice,F,1414
Bertha,F,1320
Sarah,F,1288
</code></pre><p>由于这是一个非常标准的以逗号隔开的格式，所以可以用pandas.read_csv将其加载到DataFrame中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">95</span>]: <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="color:#000;font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">96</span>]: names1880 <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>pd<span style="color:#000;font-weight:bold">.</span>read_csv(<span style="color:#d14">&#39;datasets/babynames/yob1880.txt&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">....</span>:                         names<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;name&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>, <span style="color:#d14">&#39;births&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">97</span>]: names1880
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">97</span>]: 
</span></span><span style="display:flex;"><span>           name sex  births
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>          Mary   F    <span style="color:#099">7065</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>          Anna   F    <span style="color:#099">2604</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>          Emma   F    <span style="color:#099">2003</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>     Elizabeth   F    <span style="color:#099">1939</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>        Minnie   F    <span style="color:#099">1746</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>         <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">..</span>     <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1995</span>     Woodie   M       <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1996</span>     Worthy   M       <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1997</span>     Wright   M       <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1998</span>       York   M       <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1999</span>  Zachariah   M       <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">2000</span> rows x <span style="color:#099">3</span> columns]
</span></span></code></pre></div><p>这些文件中仅含有当年出现超过5次的名字。为了简单起见，我们可以用births列的sex分组小计表示该年度的births总计：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">98</span>]: names1880<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;sex&#39;</span>)<span style="color:#000;font-weight:bold">.</span>births<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">98</span>]: 
</span></span><span style="display:flex;"><span>sex
</span></span><span style="display:flex;"><span>F     <span style="color:#099">90993</span>
</span></span><span style="display:flex;"><span>M    <span style="color:#099">110493</span>
</span></span><span style="display:flex;"><span>Name: births, dtype: int64
</span></span></code></pre></div><p>由于该数据集按年度被分隔成了多个文件，所以第一件事情就是要将所有数据都组装到一个DataFrame里面，并加上一个year字段。使用pandas.concat即可达到这个目的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>years <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">range</span>(<span style="color:#099">1880</span>, <span style="color:#099">2011</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pieces <span style="color:#000;font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>columns <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;name&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>, <span style="color:#d14">&#39;births&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> year <span style="color:#000;font-weight:bold">in</span> years:
</span></span><span style="display:flex;"><span>    path <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;datasets/babynames/yob</span><span style="color:#d14">%d</span><span style="color:#d14">.txt&#39;</span> <span style="color:#000;font-weight:bold">%</span> year
</span></span><span style="display:flex;"><span>    frame <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_csv(path, names<span style="color:#000;font-weight:bold">=</span>columns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    frame[<span style="color:#d14">&#39;year&#39;</span>] <span style="color:#000;font-weight:bold">=</span> year
</span></span><span style="display:flex;"><span>    pieces<span style="color:#000;font-weight:bold">.</span>append(frame)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Concatenate everything into a single DataFrame</span>
</span></span><span style="display:flex;"><span>names <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>concat(pieces, ignore_index<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span></code></pre></div><p>这里需要注意几件事情。第一，concat默认是按行将多个DataFrame组合到一起的；第二，必须指定ignore_index=True，因为我们不希望保留read_csv所返回的原始行号。现在我们得到了一个非常大的DataFrame，它含有全部的名字数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">100</span>]: names
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">100</span>]: 
</span></span><span style="display:flex;"><span>              name sex  births  year
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>             Mary   F    <span style="color:#099">7065</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>             Anna   F    <span style="color:#099">2604</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>             Emma   F    <span style="color:#099">2003</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>        Elizabeth   F    <span style="color:#099">1939</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>           Minnie   F    <span style="color:#099">1746</span>  <span style="color:#099">1880</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>            <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">..</span>     <span style="color:#000;font-weight:bold">...</span>   <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690779</span>    Zymaire   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690780</span>     Zyonne   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690781</span>  Zyquarius   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690782</span>      Zyran   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690783</span>      Zzyzx   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">1690784</span> rows x <span style="color:#099">4</span> columns]
</span></span></code></pre></div><p>有了这些数据之后，我们就可以利用groupby或pivot_table在year和sex级别上对其进行聚合了，如图14-4所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">101</span>]: total_births <span style="color:#000;font-weight:bold">=</span> names<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;births&#39;</span>, index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;year&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                  columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;sex&#39;</span>, aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">sum</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">102</span>]: total_births<span style="color:#000;font-weight:bold">.</span>tail()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">102</span>]: 
</span></span><span style="display:flex;"><span>sex         F        M
</span></span><span style="display:flex;"><span>year                  
</span></span><span style="display:flex;"><span><span style="color:#099">2006</span>  <span style="color:#099">1896468</span>  <span style="color:#099">2050234</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>  <span style="color:#099">1916888</span>  <span style="color:#099">2069242</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>  <span style="color:#099">1883645</span>  <span style="color:#099">2032310</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>  <span style="color:#099">1827643</span>  <span style="color:#099">1973359</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2010</span>  <span style="color:#099">1759010</span>  <span style="color:#099">1898382</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">103</span>]: total_births<span style="color:#000;font-weight:bold">.</span>plot(title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Total births by sex and year&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180243650.png" alt="图14-4 按性别和年度统计的总出生数"></p>
<p>下面我们来插入一个prop列，用于存放指定名字的婴儿数相对于总出生数的比例。prop值为0.02表示每100名婴儿中有2名取了当前这个名字。因此，我们先按year和sex分组，然后再将新列加到各个分组上：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">add_prop</span>(group):
</span></span><span style="display:flex;"><span>    group[<span style="color:#d14">&#39;prop&#39;</span>] <span style="color:#000;font-weight:bold">=</span> group<span style="color:#000;font-weight:bold">.</span>births <span style="color:#000;font-weight:bold">/</span> group<span style="color:#000;font-weight:bold">.</span>births<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> group
</span></span><span style="display:flex;"><span>names <span style="color:#000;font-weight:bold">=</span> names<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;year&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>])<span style="color:#000;font-weight:bold">.</span>apply(add_prop)
</span></span></code></pre></div><p>现在，完整的数据集就有了下面这些列：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">105</span>]: names
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">105</span>]: 
</span></span><span style="display:flex;"><span>              name sex  births  year      prop
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>             Mary   F    <span style="color:#099">7065</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.077643</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>             Anna   F    <span style="color:#099">2604</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.028618</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>             Emma   F    <span style="color:#099">2003</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.022013</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>        Elizabeth   F    <span style="color:#099">1939</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.021309</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>           Minnie   F    <span style="color:#099">1746</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.019188</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>            <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">..</span>     <span style="color:#000;font-weight:bold">...</span>   <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690779</span>    Zymaire   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000003</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690780</span>     Zyonne   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000003</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690781</span>  Zyquarius   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000003</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690782</span>      Zyran   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000003</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1690783</span>      Zzyzx   M       <span style="color:#099">5</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000003</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">1690784</span> rows x <span style="color:#099">5</span> columns]
</span></span></code></pre></div><p>在执行这样的分组处理时，一般都应该做一些有效性检查，比如验证所有分组的prop的总和是否为1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">106</span>]: names<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;year&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>])<span style="color:#000;font-weight:bold">.</span>prop<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">106</span>]: 
</span></span><span style="display:flex;"><span>year  sex
</span></span><span style="display:flex;"><span><span style="color:#099">1880</span>  F      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>      M      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1881</span>  F      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>      M      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1882</span>  F      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>  M      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>  F      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>      M      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2010</span>  F      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>      M      <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>Name: prop, Length: <span style="color:#099">262</span>, dtype: float64
</span></span></code></pre></div><p>工作完成。为了便于实现更进一步的分析，我需要取出该数据的一个子集：每对sex/year组合的前1000个名字。这又是一个分组操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_top1000</span>(group):
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> group<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;births&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)[:<span style="color:#099">1000</span>]
</span></span><span style="display:flex;"><span>grouped <span style="color:#000;font-weight:bold">=</span> names<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;year&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>])
</span></span><span style="display:flex;"><span>top1000 <span style="color:#000;font-weight:bold">=</span> grouped<span style="color:#000;font-weight:bold">.</span>apply(get_top1000)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Drop the group index, not needed</span>
</span></span><span style="display:flex;"><span>top1000<span style="color:#000;font-weight:bold">.</span>reset_index(inplace<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>, drop<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span></code></pre></div><p>如果你喜欢DIY的话，也可以这样：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pieces <span style="color:#000;font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> year, group <span style="color:#000;font-weight:bold">in</span> names<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;year&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>]):
</span></span><span style="display:flex;"><span>    pieces<span style="color:#000;font-weight:bold">.</span>append(group<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;births&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)[:<span style="color:#099">1000</span>])
</span></span><span style="display:flex;"><span>top1000 <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>concat(pieces, ignore_index<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>)
</span></span></code></pre></div><p>现在的结果数据集就小多了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">108</span>]: top1000
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">108</span>]: 
</span></span><span style="display:flex;"><span>             name sex  births  year      prop
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>            Mary   F    <span style="color:#099">7065</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.077643</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>            Anna   F    <span style="color:#099">2604</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.028618</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>            Emma   F    <span style="color:#099">2003</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.022013</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>       Elizabeth   F    <span style="color:#099">1939</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.021309</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>          Minnie   F    <span style="color:#099">1746</span>  <span style="color:#099">1880</span>  <span style="color:#099">0.019188</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>           <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">..</span>     <span style="color:#000;font-weight:bold">...</span>   <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261872</span>     Camilo   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261873</span>     Destin   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261874</span>     Jaquan   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261875</span>     Jaydan   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261876</span>     Maxton   M     <span style="color:#099">193</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">261877</span> rows x <span style="color:#099">5</span> columns]
</span></span></code></pre></div><p>接下来的数据分析工作就针对这个top1000数据集了。</p>
<h3 id="1431-分析命名趋势">14.3.1 分析命名趋势</h3>
<p>有了完整的数据集和刚才生成的top1000数据集，我们就可以开始分析各种命名趋势了。首先将前1000个名字分为男女两个部分：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">109</span>]: boys <span style="color:#000;font-weight:bold">=</span> top1000[top1000<span style="color:#000;font-weight:bold">.</span>sex <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;M&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">110</span>]: girls <span style="color:#000;font-weight:bold">=</span> top1000[top1000<span style="color:#000;font-weight:bold">.</span>sex <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;F&#39;</span>]
</span></span></code></pre></div><p>这是两个简单的时间序列，只需稍作整理即可绘制出相应的图表（比如每年叫做John和Mary的婴儿数）。我们先生成一张按year和name统计的总出生数透视表：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">111</span>]: total_births <span style="color:#000;font-weight:bold">=</span> top1000<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;births&#39;</span>, index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;year&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                    columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;name&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                    aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">sum</span>)
</span></span></code></pre></div><p>现在，我们用DataFrame的plot方法绘制几个名字的曲线图（见图14-5）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">112</span>]: total_births<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>Int64Index: <span style="color:#099">131</span> entries, <span style="color:#099">1880</span> to <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span>Columns: <span style="color:#099">6868</span> entries, Aaden to Zuri
</span></span><span style="display:flex;"><span>dtypes: float64(<span style="color:#099">6868</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">6.9</span> MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">113</span>]: subset <span style="color:#000;font-weight:bold">=</span> total_births[[<span style="color:#d14">&#39;John&#39;</span>, <span style="color:#d14">&#39;Harry&#39;</span>, <span style="color:#d14">&#39;Mary&#39;</span>, <span style="color:#d14">&#39;Marilyn&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">114</span>]: subset<span style="color:#000;font-weight:bold">.</span>plot(subplots<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">True</span>, figsize<span style="color:#000;font-weight:bold">=</span>(<span style="color:#099">12</span>, <span style="color:#099">10</span>), grid<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:             title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Number of births per year&#34;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180302658.png" alt="图14-5 几个男孩和女孩名字随时间变化的使用数量"></p>
<p>从图中可以看出，这几个名字在美国人民的心目中已经风光不再了。但事实并非如此简单，我们在下一节中就能知道是怎么一回事了。</p>
<h3 id="1432-评估命名多样性的增长">14.3.2 评估命名多样性的增长</h3>
<p>一种解释是父母愿意给小孩起常见的名字越来越少。这个假设可以从数据中得到验证。一个办法是计算最流行的1000个名字所占的比例，我按year和sex进行聚合并绘图（见图14-6）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">116</span>]: table <span style="color:#000;font-weight:bold">=</span> top1000<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;prop&#39;</span>, index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;year&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                             columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;sex&#39;</span>, aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">sum</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">117</span>]: table<span style="color:#000;font-weight:bold">.</span>plot(title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Sum of table1000.prop by year and sex&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:            yticks<span style="color:#000;font-weight:bold">=</span>np<span style="color:#000;font-weight:bold">.</span>linspace(<span style="color:#099">0</span>, <span style="color:#099">1.2</span>, <span style="color:#099">13</span>), xticks<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">range</span>(<span style="color:#099">1880</span>, <span style="color:#099">2020</span>, <span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180317016.png" alt="图14-6 分性别统计的前1000个名字在总出生人数中的比例"></p>
<p>从图中可以看出，名字的多样性确实出现了增长（前1000项的比例降低）。另一个办法是计算占总出生人数前50%的不同名字的数量，这个数字不太好计算。我们只考虑2010年男孩的名字：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">118</span>]: df <span style="color:#000;font-weight:bold">=</span> boys[boys<span style="color:#000;font-weight:bold">.</span>year <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">2010</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">119</span>]: df
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">119</span>]: 
</span></span><span style="display:flex;"><span>           name sex  births  year      prop
</span></span><span style="display:flex;"><span><span style="color:#099">260877</span>    Jacob   M   <span style="color:#099">21875</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.011523</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260878</span>    Ethan   M   <span style="color:#099">17866</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.009411</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260879</span>  Michael   M   <span style="color:#099">17133</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.009025</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260880</span>   Jayden   M   <span style="color:#099">17030</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.008971</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260881</span>  William   M   <span style="color:#099">16870</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.008887</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>         <span style="color:#000;font-weight:bold">...</span>  <span style="color:#000;font-weight:bold">..</span>     <span style="color:#000;font-weight:bold">...</span>   <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261872</span>   Camilo   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261873</span>   Destin   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261874</span>   Jaquan   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261875</span>   Jaydan   M     <span style="color:#099">194</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span><span style="color:#099">261876</span>   Maxton   M     <span style="color:#099">193</span>  <span style="color:#099">2010</span>  <span style="color:#099">0.000102</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">1000</span> rows x <span style="color:#099">5</span> columns]
</span></span></code></pre></div><p>在对prop降序排列之后，我们想知道前面多少个名字的人数加起来才够50%。虽然编写一个for循环确实也能达到目的，但NumPy有一种更聪明的矢量方式。先计算prop的累计和cumsum，然后再通过searchsorted方法找出0.5应该被插入在哪个位置才能保证不破坏顺序：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">120</span>]: prop_cumsum <span style="color:#000;font-weight:bold">=</span> df<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;prop&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)<span style="color:#000;font-weight:bold">.</span>prop<span style="color:#000;font-weight:bold">.</span>cumsum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">121</span>]: prop_cumsum[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">121</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">260877</span>    <span style="color:#099">0.011523</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260878</span>    <span style="color:#099">0.020934</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260879</span>    <span style="color:#099">0.029959</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260880</span>    <span style="color:#099">0.038930</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260881</span>    <span style="color:#099">0.047817</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260882</span>    <span style="color:#099">0.056579</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260883</span>    <span style="color:#099">0.065155</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260884</span>    <span style="color:#099">0.073414</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260885</span>    <span style="color:#099">0.081528</span>
</span></span><span style="display:flex;"><span><span style="color:#099">260886</span>    <span style="color:#099">0.089621</span>
</span></span><span style="display:flex;"><span>Name: prop, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">122</span>]: prop_cumsum<span style="color:#000;font-weight:bold">.</span>values<span style="color:#000;font-weight:bold">.</span>searchsorted(<span style="color:#099">0.5</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">122</span>]: <span style="color:#099">116</span>
</span></span></code></pre></div><p>由于数组索引是从0开始的，因此我们要给这个结果加1，即最终结果为117。拿1900年的数据来做个比较，这个数字要小得多：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">123</span>]: df <span style="color:#000;font-weight:bold">=</span> boys[boys<span style="color:#000;font-weight:bold">.</span>year <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1900</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">124</span>]: in1900 <span style="color:#000;font-weight:bold">=</span> df<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;prop&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)<span style="color:#000;font-weight:bold">.</span>prop<span style="color:#000;font-weight:bold">.</span>cumsum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">125</span>]: in1900<span style="color:#000;font-weight:bold">.</span>values<span style="color:#000;font-weight:bold">.</span>searchsorted(<span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">125</span>]: <span style="color:#099">25</span>
</span></span></code></pre></div><p>现在就可以对所有year/sex组合执行这个计算了。按这两个字段进行groupby处理，然后用一个函数计算各分组的这个值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_quantile_count</span>(group, q<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0.5</span>):
</span></span><span style="display:flex;"><span>    group <span style="color:#000;font-weight:bold">=</span> group<span style="color:#000;font-weight:bold">.</span>sort_values(by<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;prop&#39;</span>, ascending<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> group<span style="color:#000;font-weight:bold">.</span>prop<span style="color:#000;font-weight:bold">.</span>cumsum()<span style="color:#000;font-weight:bold">.</span>values<span style="color:#000;font-weight:bold">.</span>searchsorted(q) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diversity <span style="color:#000;font-weight:bold">=</span> top1000<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;year&#39;</span>, <span style="color:#d14">&#39;sex&#39;</span>])<span style="color:#000;font-weight:bold">.</span>apply(get_quantile_count)
</span></span><span style="display:flex;"><span>diversity <span style="color:#000;font-weight:bold">=</span> diversity<span style="color:#000;font-weight:bold">.</span>unstack(<span style="color:#d14">&#39;sex&#39;</span>)
</span></span></code></pre></div><p>现在，diversity这个DataFrame拥有两个时间序列（每个性别各一个，按年度索引）。通过IPython，你可以查看其内容，还可以像之前那样绘制图表（如图14-7所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">128</span>]: diversity<span style="color:#000;font-weight:bold">.</span>head()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">128</span>]: 
</span></span><span style="display:flex;"><span>sex    F   M
</span></span><span style="display:flex;"><span>year        
</span></span><span style="display:flex;"><span><span style="color:#099">1880</span>  <span style="color:#099">38</span>  <span style="color:#099">14</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1881</span>  <span style="color:#099">38</span>  <span style="color:#099">14</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1882</span>  <span style="color:#099">38</span>  <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1883</span>  <span style="color:#099">39</span>  <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1884</span>  <span style="color:#099">39</span>  <span style="color:#099">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">129</span>]: diversity<span style="color:#000;font-weight:bold">.</span>plot(title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Number of popular names in top 50%&#34;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180325177.png" alt="图14-7 按年度统计的密度表"></p>
<p>从图中可以看出，女孩名字的多样性总是比男孩的高，而且还在变得越来越高。读者们可以自己分析一下具体是什么在驱动这个多样性（比如拼写形式的变化）。</p>
<h3 id="1433-最后一个字母的变革">14.3.3 “最后一个字母”的变革</h3>
<p>2007年，一名婴儿姓名研究人员Laura Wattenberg在她自己的网站上指出（http://www.babynamewizard.com）：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># extract last letter from name column</span>
</span></span><span style="display:flex;"><span>get_last_letter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: x[<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>last_letters <span style="color:#000;font-weight:bold">=</span> names<span style="color:#000;font-weight:bold">.</span>name<span style="color:#000;font-weight:bold">.</span>map(get_last_letter)
</span></span><span style="display:flex;"><span>last_letters<span style="color:#000;font-weight:bold">.</span>name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;last_letter&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>table <span style="color:#000;font-weight:bold">=</span> names<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;births&#39;</span>, index<span style="color:#000;font-weight:bold">=</span>last_letters,
</span></span><span style="display:flex;"><span>                          columns<span style="color:#000;font-weight:bold">=</span>[<span style="color:#d14">&#39;sex&#39;</span>, <span style="color:#d14">&#39;year&#39;</span>], aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">sum</span>)
</span></span></code></pre></div><p>然后，我选出具有一定代表性的三年，并输出前面几行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">131</span>]: subtable <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">.</span>reindex(columns<span style="color:#000;font-weight:bold">=</span>[<span style="color:#099">1910</span>, <span style="color:#099">1960</span>, <span style="color:#099">2010</span>], level<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;year&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">132</span>]: subtable<span style="color:#000;font-weight:bold">.</span>head()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">132</span>]: 
</span></span><span style="display:flex;"><span>sex                 F                            M                    
</span></span><span style="display:flex;"><span>year             <span style="color:#099">1910</span>      <span style="color:#099">1960</span>      <span style="color:#099">2010</span>     <span style="color:#099">1910</span>      <span style="color:#099">1960</span>      <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span>last_letter                                                           
</span></span><span style="display:flex;"><span>a            <span style="color:#099">108376.0</span>  <span style="color:#099">691247.0</span>  <span style="color:#099">670605.0</span>    <span style="color:#099">977.0</span>    <span style="color:#099">5204.0</span>   <span style="color:#099">28438.0</span>
</span></span><span style="display:flex;"><span>b                 NaN     <span style="color:#099">694.0</span>     <span style="color:#099">450.0</span>    <span style="color:#099">411.0</span>    <span style="color:#099">3912.0</span>   <span style="color:#099">38859.0</span>
</span></span><span style="display:flex;"><span>c                 <span style="color:#099">5.0</span>      <span style="color:#099">49.0</span>     <span style="color:#099">946.0</span>    <span style="color:#099">482.0</span>   <span style="color:#099">15476.0</span>   <span style="color:#099">23125.0</span>
</span></span><span style="display:flex;"><span>d              <span style="color:#099">6750.0</span>    <span style="color:#099">3729.0</span>    <span style="color:#099">2607.0</span>  <span style="color:#099">22111.0</span>  <span style="color:#099">262112.0</span>   <span style="color:#099">44398.0</span>
</span></span><span style="display:flex;"><span>e            <span style="color:#099">133569.0</span>  <span style="color:#099">435013.0</span>  <span style="color:#099">313833.0</span>  <span style="color:#099">28655.0</span>  <span style="color:#099">178823.0</span>  <span style="color:#099">129012.0</span>
</span></span></code></pre></div><p>接下来我们需要按总出生数对该表进行规范化处理，以便计算出各性别各末字母占总出生人数的比例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">133</span>]: subtable<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">133</span>]: 
</span></span><span style="display:flex;"><span>sex  year
</span></span><span style="display:flex;"><span>F    <span style="color:#099">1910</span>     <span style="color:#099">396416.0</span>
</span></span><span style="display:flex;"><span>     <span style="color:#099">1960</span>    <span style="color:#099">2022062.0</span>
</span></span><span style="display:flex;"><span>     <span style="color:#099">2010</span>    <span style="color:#099">1759010.0</span>
</span></span><span style="display:flex;"><span>M    <span style="color:#099">1910</span>     <span style="color:#099">194198.0</span>
</span></span><span style="display:flex;"><span>     <span style="color:#099">1960</span>    <span style="color:#099">2132588.0</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2010</span>    <span style="color:#099">1898382.0</span>
</span></span><span style="display:flex;"><span>dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">134</span>]: letter_prop <span style="color:#000;font-weight:bold">=</span> subtable <span style="color:#000;font-weight:bold">/</span> subtable<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">135</span>]: letter_prop
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">135</span>]: 
</span></span><span style="display:flex;"><span>sex                 F                             M                    
</span></span><span style="display:flex;"><span>year             <span style="color:#099">1910</span>      <span style="color:#099">1960</span>      <span style="color:#099">2010</span>      <span style="color:#099">1910</span>      <span style="color:#099">1960</span>      <span style="color:#099">2010</span>
</span></span><span style="display:flex;"><span>last_letter                                                            
</span></span><span style="display:flex;"><span>a            <span style="color:#099">0.273390</span>  <span style="color:#099">0.341853</span>  <span style="color:#099">0.381240</span>  <span style="color:#099">0.005031</span>  <span style="color:#099">0.002440</span>  <span style="color:#099">0.014980</span>
</span></span><span style="display:flex;"><span>b                 NaN  <span style="color:#099">0.000343</span>  <span style="color:#099">0.000256</span>  <span style="color:#099">0.002116</span>  <span style="color:#099">0.001834</span>  <span style="color:#099">0.020470</span>
</span></span><span style="display:flex;"><span>c            <span style="color:#099">0.000013</span>  <span style="color:#099">0.000024</span>  <span style="color:#099">0.000538</span>  <span style="color:#099">0.002482</span>  <span style="color:#099">0.007257</span>  <span style="color:#099">0.012181</span>
</span></span><span style="display:flex;"><span>d            <span style="color:#099">0.017028</span>  <span style="color:#099">0.001844</span>  <span style="color:#099">0.001482</span>  <span style="color:#099">0.113858</span>  <span style="color:#099">0.122908</span>  <span style="color:#099">0.023387</span>
</span></span><span style="display:flex;"><span>e            <span style="color:#099">0.336941</span>  <span style="color:#099">0.215133</span>  <span style="color:#099">0.178415</span>  <span style="color:#099">0.147556</span>  <span style="color:#099">0.083853</span>  <span style="color:#099">0.067959</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>               <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>       <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>v                 NaN  <span style="color:#099">0.000060</span>  <span style="color:#099">0.000117</span>  <span style="color:#099">0.000113</span>
</span></span><span style="display:flex;"><span><span style="color:#099">0.000037</span>  <span style="color:#099">0.001434</span>
</span></span><span style="display:flex;"><span>w            <span style="color:#099">0.000020</span>  <span style="color:#099">0.000031</span>  <span style="color:#099">0.001182</span>  <span style="color:#099">0.006329</span>  <span style="color:#099">0.007711</span>  <span style="color:#099">0.016148</span>
</span></span><span style="display:flex;"><span>x            <span style="color:#099">0.000015</span>  <span style="color:#099">0.000037</span>  <span style="color:#099">0.000727</span>  <span style="color:#099">0.003965</span>  <span style="color:#099">0.001851</span>  <span style="color:#099">0.008614</span>
</span></span><span style="display:flex;"><span>y            <span style="color:#099">0.110972</span>  <span style="color:#099">0.152569</span>  <span style="color:#099">0.116828</span>  <span style="color:#099">0.077349</span>  <span style="color:#099">0.160987</span>  <span style="color:#099">0.058168</span>
</span></span><span style="display:flex;"><span>z            <span style="color:#099">0.002439</span>  <span style="color:#099">0.000659</span>  <span style="color:#099">0.000704</span>  <span style="color:#099">0.000170</span>  <span style="color:#099">0.000184</span>  <span style="color:#099">0.001831</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">26</span> rows x <span style="color:#099">6</span> columns]
</span></span></code></pre></div><p>有了这个字母比例数据之后，就可以生成一张各年度各性别的条形图了，如图14-8所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">matplotlib.pyplot</span> <span style="color:#000;font-weight:bold">as</span> <span style="color:#555">plt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#000;font-weight:bold">=</span> plt<span style="color:#000;font-weight:bold">.</span>subplots(<span style="color:#099">2</span>, <span style="color:#099">1</span>, figsize<span style="color:#000;font-weight:bold">=</span>(<span style="color:#099">10</span>, <span style="color:#099">8</span>))
</span></span><span style="display:flex;"><span>letter_prop[<span style="color:#d14">&#39;M&#39;</span>]<span style="color:#000;font-weight:bold">.</span>plot(kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;bar&#39;</span>, rot<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>, ax<span style="color:#000;font-weight:bold">=</span>axes[<span style="color:#099">0</span>], title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Male&#39;</span>)
</span></span><span style="display:flex;"><span>letter_prop[<span style="color:#d14">&#39;F&#39;</span>]<span style="color:#000;font-weight:bold">.</span>plot(kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;bar&#39;</span>, rot<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>, ax<span style="color:#000;font-weight:bold">=</span>axes[<span style="color:#099">1</span>], title<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;Female&#39;</span>,
</span></span><span style="display:flex;"><span>                      legend<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180345568.png" alt="图14-8 男孩女孩名字中各个末字母的比例"></p>
<p>可以看出，从20世纪60年代开始，以字母&quot;n&quot;结尾的男孩名字出现了显著的增长。回到之前创建的那个完整表，按年度和性别对其进行规范化处理，并在男孩名字中选取几个字母，最后进行转置以便将各个列做成一个时间序列：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">138</span>]: letter_prop <span style="color:#000;font-weight:bold">=</span> table <span style="color:#000;font-weight:bold">/</span> table<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">139</span>]: dny_ts <span style="color:#000;font-weight:bold">=</span> letter_prop<span style="color:#000;font-weight:bold">.</span>loc[[<span style="color:#d14">&#39;d&#39;</span>, <span style="color:#d14">&#39;n&#39;</span>, <span style="color:#d14">&#39;y&#39;</span>], <span style="color:#d14">&#39;M&#39;</span>]<span style="color:#000;font-weight:bold">.</span>T
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">140</span>]: dny_ts<span style="color:#000;font-weight:bold">.</span>head()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">140</span>]: 
</span></span><span style="display:flex;"><span>last_letter         d         n         y
</span></span><span style="display:flex;"><span>year                                     
</span></span><span style="display:flex;"><span><span style="color:#099">1880</span>         <span style="color:#099">0.083055</span>  <span style="color:#099">0.153213</span>  <span style="color:#099">0.075760</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1881</span>         <span style="color:#099">0.083247</span>  <span style="color:#099">0.153214</span>  <span style="color:#099">0.077451</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1882</span>         <span style="color:#099">0.085340</span>  <span style="color:#099">0.149560</span>  <span style="color:#099">0.077537</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1883</span>         <span style="color:#099">0.084066</span>  <span style="color:#099">0.151646</span>  <span style="color:#099">0.079144</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1884</span>         <span style="color:#099">0.086120</span>  <span style="color:#099">0.149915</span>  <span style="color:#099">0.080405</span>
</span></span></code></pre></div><p>有了这个时间序列的DataFrame之后，就可以通过其plot方法绘制出一张趋势图了（如图14-9所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">143</span>]: dny_ts<span style="color:#000;font-weight:bold">.</span>plot()
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180352940.png" alt="图14-9 各年出生的男孩中名字以d/n/y结尾的人数比例"></p>
<h3 id="1434-变成女孩名字的男孩名字以及相反的情况">14.3.4 变成女孩名字的男孩名字（以及相反的情况）</h3>
<p>另一个有趣的趋势是，早年流行于男孩的名字近年来“变性了”，例如Lesley或Leslie。回到top1000数据集，找出其中以&quot;lesl&quot;开头的一组名字：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">144</span>]: all_names <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>Series(top1000<span style="color:#000;font-weight:bold">.</span>name<span style="color:#000;font-weight:bold">.</span>unique())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">145</span>]: lesley_like <span style="color:#000;font-weight:bold">=</span> all_names[all_names<span style="color:#000;font-weight:bold">.</span>str<span style="color:#000;font-weight:bold">.</span>lower()<span style="color:#000;font-weight:bold">.</span>str<span style="color:#000;font-weight:bold">.</span>contains(<span style="color:#d14">&#39;lesl&#39;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">146</span>]: lesley_like
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">146</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">632</span>     Leslie
</span></span><span style="display:flex;"><span><span style="color:#099">2294</span>    Lesley
</span></span><span style="display:flex;"><span><span style="color:#099">4262</span>    Leslee
</span></span><span style="display:flex;"><span><span style="color:#099">4728</span>     Lesli
</span></span><span style="display:flex;"><span><span style="color:#099">6103</span>     Lesly
</span></span><span style="display:flex;"><span>dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>然后利用这个结果过滤其他的名字，并按名字分组计算出生数以查看相对频率：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">147</span>]: filtered <span style="color:#000;font-weight:bold">=</span> top1000[top1000<span style="color:#000;font-weight:bold">.</span>name<span style="color:#000;font-weight:bold">.</span>isin(lesley_like)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">148</span>]: filtered<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;name&#39;</span>)<span style="color:#000;font-weight:bold">.</span>births<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">148</span>]: 
</span></span><span style="display:flex;"><span>name
</span></span><span style="display:flex;"><span>Leslee      <span style="color:#099">1082</span>
</span></span><span style="display:flex;"><span>Lesley     <span style="color:#099">35022</span>
</span></span><span style="display:flex;"><span>Lesli        <span style="color:#099">929</span>
</span></span><span style="display:flex;"><span>Leslie    <span style="color:#099">370429</span>
</span></span><span style="display:flex;"><span>Lesly      <span style="color:#099">10067</span>
</span></span><span style="display:flex;"><span>Name: births, dtype: int64
</span></span></code></pre></div><p>接下来，我们按性别和年度进行聚合，并按年度进行规范化处理：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">149</span>]: table <span style="color:#000;font-weight:bold">=</span> filtered<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;births&#39;</span>, index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;year&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                              columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;sex&#39;</span>, aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;sum&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">150</span>]: table <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">.</span>div(table<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>), axis<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">151</span>]: table<span style="color:#000;font-weight:bold">.</span>tail()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">151</span>]: 
</span></span><span style="display:flex;"><span>sex     F   M
</span></span><span style="display:flex;"><span>year         
</span></span><span style="display:flex;"><span><span style="color:#099">2006</span>  <span style="color:#099">1.0</span> NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2007</span>  <span style="color:#099">1.0</span> NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2008</span>  <span style="color:#099">1.0</span> NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2009</span>  <span style="color:#099">1.0</span> NaN
</span></span><span style="display:flex;"><span><span style="color:#099">2010</span>  <span style="color:#099">1.0</span> NaN
</span></span></code></pre></div><p>最后，就可以轻松绘制一张分性别的年度曲线图了（如图2-10所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">153</span>]: table<span style="color:#000;font-weight:bold">.</span>plot(style<span style="color:#000;font-weight:bold">=</span>{<span style="color:#d14">&#39;M&#39;</span>: <span style="color:#d14">&#39;k-&#39;</span>, <span style="color:#d14">&#39;F&#39;</span>: <span style="color:#d14">&#39;k--&#39;</span>})
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180408537.png" alt="图14-10 各年度使用“Lesley型”名字的男女比例"></p>
<h2 id="144-usda食品数据库">14.4 USDA食品数据库</h2>
<p>美国农业部（USDA）制作了一份有关食物营养信息的数据库。Ashley Williams制作了该数据的JSON版（http://ashleyw.co.uk/project/food-nutrient-database）。其中的记录如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;id&#34;</span>: <span style="color:#099">21441</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;description&#34;</span>: <span style="color:#d14">&#34;KENTUCKY FRIED CHICKEN, Fried Chicken, EXTRA CRISPY,</span>
</span></span><span style="display:flex;"><span>Wing, meat <span style="color:#000;font-weight:bold">and</span> skin <span style="color:#000;font-weight:bold">with</span> breading<span style="color:#d14">&#34;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;tags&#34;</span>: [<span style="color:#d14">&#34;KFC&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;manufacturer&#34;</span>: <span style="color:#d14">&#34;Kentucky Fried Chicken&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#d14">&#34;group&#34;</span>: <span style="color:#d14">&#34;Fast Foods&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;portions&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;amount&#34;</span>: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;unit&#34;</span>: <span style="color:#d14">&#34;wing, with skin&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;grams&#34;</span>: <span style="color:#099">68.0</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;nutrients&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;value&#34;</span>: <span style="color:#099">20.8</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;units&#34;</span>: <span style="color:#d14">&#34;g&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;description&#34;</span>: <span style="color:#d14">&#34;Protein&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;group&#34;</span>: <span style="color:#d14">&#34;Composition&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>每种食物都带有若干标识性属性以及两个有关营养成分和分量的列表。这种形式的数据不是很适合分析工作，因此我们需要做一些规整化以使其具有更好用的形式。</p>
<p>从上面列举的那个网址下载并解压数据之后，你可以用任何喜欢的JSON库将其加载到Python中。我用的是Python内置的json模块：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">154</span>]: <span style="color:#000;font-weight:bold">import</span> <span style="color:#555">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">155</span>]: db <span style="color:#000;font-weight:bold">=</span> json<span style="color:#000;font-weight:bold">.</span>load(<span style="color:#0086b3">open</span>(<span style="color:#d14">&#39;datasets/usda_food/database.json&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">156</span>]: <span style="color:#0086b3">len</span>(db)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">156</span>]: <span style="color:#099">6636</span>
</span></span></code></pre></div><p>db中的每个条目都是一个含有某种食物全部数据的字典。nutrients字段是一个字典列表，其中的每个字典对应一种营养成分：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">157</span>]: db[<span style="color:#099">0</span>]<span style="color:#000;font-weight:bold">.</span>keys()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">157</span>]: dict_keys([<span style="color:#d14">&#39;id&#39;</span>, <span style="color:#d14">&#39;description&#39;</span>, <span style="color:#d14">&#39;tags&#39;</span>, <span style="color:#d14">&#39;manufacturer&#39;</span>, <span style="color:#d14">&#39;group&#39;</span>, <span style="color:#d14">&#39;porti</span>
</span></span><span style="display:flex;"><span>ons<span style="color:#d14">&#39;, &#39;</span>nutrients<span style="color:#d14">&#39;])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">158</span>]: db[<span style="color:#099">0</span>][<span style="color:#d14">&#39;nutrients&#39;</span>][<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">158</span>]: 
</span></span><span style="display:flex;"><span>{<span style="color:#d14">&#39;description&#39;</span>: <span style="color:#d14">&#39;Protein&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;group&#39;</span>: <span style="color:#d14">&#39;Composition&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;units&#39;</span>: <span style="color:#d14">&#39;g&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#d14">&#39;value&#39;</span>: <span style="color:#099">25.18</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">159</span>]: nutrients <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(db[<span style="color:#099">0</span>][<span style="color:#d14">&#39;nutrients&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">160</span>]: nutrients[:<span style="color:#099">7</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">160</span>]: 
</span></span><span style="display:flex;"><span>                   description        group units    value
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>                      Protein  Composition     g    <span style="color:#099">25.18</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>            Total lipid (fat)  Composition     g    <span style="color:#099">29.20</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>  Carbohydrate, by difference  Composition     g     <span style="color:#099">3.06</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>                          Ash        Other     g     <span style="color:#099">3.28</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>                       Energy       Energy  kcal   <span style="color:#099">376.00</span>
</span></span><span style="display:flex;"><span><span style="color:#099">5</span>                        Water  Composition     g    <span style="color:#099">39.28</span>
</span></span><span style="display:flex;"><span><span style="color:#099">6</span>                       Energy       Energy    kJ  <span style="color:#099">1573.00</span>
</span></span></code></pre></div><p>在将字典列表转换为DataFrame时，可以只抽取其中的一部分字段。这里，我们将取出食物的名称、分类、编号以及制造商等信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">161</span>]: info_keys <span style="color:#000;font-weight:bold">=</span> [<span style="color:#d14">&#39;description&#39;</span>, <span style="color:#d14">&#39;group&#39;</span>, <span style="color:#d14">&#39;id&#39;</span>, <span style="color:#d14">&#39;manufacturer&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">162</span>]: info <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>DataFrame(db, columns<span style="color:#000;font-weight:bold">=</span>info_keys)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">163</span>]: info[:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">163</span>]: 
</span></span><span style="display:flex;"><span>                          description                   group    <span style="color:#0086b3">id</span>  \
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>                     Cheese, caraway  Dairy <span style="color:#000;font-weight:bold">and</span> Egg Products  <span style="color:#099">1008</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>                     Cheese, cheddar  Dairy <span style="color:#000;font-weight:bold">and</span> Egg Products  <span style="color:#099">1009</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>                        Cheese, edam  Dairy <span style="color:#000;font-weight:bold">and</span> Egg Products  <span style="color:#099">1018</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>                        Cheese, feta  Dairy <span style="color:#000;font-weight:bold">and</span> Egg Products  <span style="color:#099">1019</span>   
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>  Cheese, mozzarella, part skim milk  Dairy <span style="color:#000;font-weight:bold">and</span> Egg Products  <span style="color:#099">1028</span>   
</span></span><span style="display:flex;"><span>  manufacturer  
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>               
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>               
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>               
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>               
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>               
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">164</span>]: info<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>RangeIndex: <span style="color:#099">6636</span> entries, <span style="color:#099">0</span> to <span style="color:#099">6635</span>
</span></span><span style="display:flex;"><span>Data columns (total <span style="color:#099">4</span> columns):
</span></span><span style="display:flex;"><span>description     <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>group           <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">id</span>              <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null int64
</span></span><span style="display:flex;"><span>manufacturer    <span style="color:#099">5195</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>dtypes: int64(<span style="color:#099">1</span>), <span style="color:#0086b3">object</span>(<span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">207.5</span><span style="color:#000;font-weight:bold">+</span> KB
</span></span></code></pre></div><p>通过value_counts，你可以查看食物类别的分布情况：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">165</span>]: pd<span style="color:#000;font-weight:bold">.</span>value_counts(info<span style="color:#000;font-weight:bold">.</span>group)[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">165</span>]: 
</span></span><span style="display:flex;"><span>Vegetables <span style="color:#000;font-weight:bold">and</span> Vegetable Products    <span style="color:#099">812</span>
</span></span><span style="display:flex;"><span>Beef Products                        <span style="color:#099">618</span>
</span></span><span style="display:flex;"><span>Baked Products                       <span style="color:#099">496</span>
</span></span><span style="display:flex;"><span>Breakfast Cereals                    <span style="color:#099">403</span>
</span></span><span style="display:flex;"><span>Fast Foods                           <span style="color:#099">365</span>
</span></span><span style="display:flex;"><span>Legumes <span style="color:#000;font-weight:bold">and</span> Legume Products          <span style="color:#099">365</span>
</span></span><span style="display:flex;"><span>Lamb, Veal, <span style="color:#000;font-weight:bold">and</span> Game Products        <span style="color:#099">345</span>
</span></span><span style="display:flex;"><span>Sweets                               <span style="color:#099">341</span>
</span></span><span style="display:flex;"><span>Pork Products                        <span style="color:#099">328</span>
</span></span><span style="display:flex;"><span>Fruits <span style="color:#000;font-weight:bold">and</span> Fruit Juices              <span style="color:#099">328</span>
</span></span><span style="display:flex;"><span>Name: group, dtype: int64
</span></span></code></pre></div><p>现在，为了对全部营养数据做一些分析，最简单的办法是将所有食物的营养成分整合到一个大表中。我们分几个步骤来实现该目的。首先，将各食物的营养成分列表转换为一个DataFrame，并添加一个表示编号的列，然后将该DataFrame添加到一个列表中。最后通过concat将这些东西连接起来就可以了：</p>
<p>顺利的话，nutrients的结果是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">167</span>]: nutrients
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">167</span>]: 
</span></span><span style="display:flex;"><span>                               description        group units    value     <span style="color:#0086b3">id</span>
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>                                  Protein  Composition     g   <span style="color:#099">25.180</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>                        Total lipid (fat)  Composition     g   <span style="color:#099">29.200</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>              Carbohydrate, by difference  Composition     g    <span style="color:#099">3.060</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>                                      Ash        Other     g    <span style="color:#099">3.280</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>                                   Energy       Energy  kcal  <span style="color:#099">376.000</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                                    <span style="color:#000;font-weight:bold">...</span>          <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>      <span style="color:#000;font-weight:bold">...</span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389350</span>                 Vitamin B<span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>, added     Vitamins   mcg    <span style="color:#099">0.000</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389351</span>                         Cholesterol        Other    mg    <span style="color:#099">0.000</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389352</span>        Fatty acids, total saturated        Other     g    <span style="color:#099">0.072</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389353</span>  Fatty acids, total monounsaturated        Other     g    <span style="color:#099">0.028</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span style="color:#099">0.041</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">389355</span> rows x <span style="color:#099">5</span> columns]
</span></span></code></pre></div><p>我发现这个DataFrame中无论如何都会有一些重复项，所以直接丢弃就可以了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">168</span>]: nutrients<span style="color:#000;font-weight:bold">.</span>duplicated()<span style="color:#000;font-weight:bold">.</span>sum()  <span style="color:#998;font-style:italic"># number of duplicates</span>
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">168</span>]: <span style="color:#099">14179</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">169</span>]: nutrients <span style="color:#000;font-weight:bold">=</span> nutrients<span style="color:#000;font-weight:bold">.</span>drop_duplicates()
</span></span></code></pre></div><p>由于两个DataFrame对象中都有&quot;group&quot;和&quot;description&quot;，所以为了明确到底谁是谁，我们需要对它们进行重命名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">170</span>]: col_mapping <span style="color:#000;font-weight:bold">=</span> {<span style="color:#d14">&#39;description&#39;</span> : <span style="color:#d14">&#39;food&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                <span style="color:#d14">&#39;group&#39;</span>       : <span style="color:#d14">&#39;fgroup&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">171</span>]: info <span style="color:#000;font-weight:bold">=</span> info<span style="color:#000;font-weight:bold">.</span>rename(columns<span style="color:#000;font-weight:bold">=</span>col_mapping, copy<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">172</span>]: info<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>RangeIndex: <span style="color:#099">6636</span> entries, <span style="color:#099">0</span> to <span style="color:#099">6635</span>
</span></span><span style="display:flex;"><span>Data columns (total <span style="color:#099">4</span> columns):
</span></span><span style="display:flex;"><span>food            <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>fgroup          <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">id</span>              <span style="color:#099">6636</span> non<span style="color:#000;font-weight:bold">-</span>null int64
</span></span><span style="display:flex;"><span>manufacturer    <span style="color:#099">5195</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>dtypes: int64(<span style="color:#099">1</span>), <span style="color:#0086b3">object</span>(<span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">207.5</span><span style="color:#000;font-weight:bold">+</span> KB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">173</span>]: col_mapping <span style="color:#000;font-weight:bold">=</span> {<span style="color:#d14">&#39;description&#39;</span> : <span style="color:#d14">&#39;nutrient&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                <span style="color:#d14">&#39;group&#39;</span> : <span style="color:#d14">&#39;nutgroup&#39;</span>}
</span></span><span style="display:flex;"><span>In [<span style="color:#099">174</span>]: nutrients <span style="color:#000;font-weight:bold">=</span> nutrients<span style="color:#000;font-weight:bold">.</span>rename(columns<span style="color:#000;font-weight:bold">=</span>col_mapping, copy<span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">175</span>]: nutrients
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">175</span>]: 
</span></span><span style="display:flex;"><span>                                  nutrient     nutgroup units    value     <span style="color:#0086b3">id</span>
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>                                  Protein  Composition     g   <span style="color:#099">25.180</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">1</span>                        Total lipid (fat)  Composition     g   <span style="color:#099">29.200</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">2</span>              Carbohydrate, by difference  Composition     g    <span style="color:#099">3.060</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">3</span>                                      Ash        Other     g    <span style="color:#099">3.280</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>                                   Energy       Energy  kcal  <span style="color:#099">376.000</span>   <span style="color:#099">1008</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                                    <span style="color:#000;font-weight:bold">...</span>          <span style="color:#000;font-weight:bold">...</span>   <span style="color:#000;font-weight:bold">...</span>      <span style="color:#000;font-weight:bold">...</span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389350</span>                 Vitamin B<span style="color:#000;font-weight:bold">-</span><span style="color:#099">12</span>, added     Vitamins   mcg    <span style="color:#099">0.000</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389351</span>                         Cholesterol        Other    mg    <span style="color:#099">0.000</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389352</span>        Fatty acids, total saturated        Other     g    <span style="color:#099">0.072</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389353</span>  Fatty acids, total monounsaturated        Other     g    <span style="color:#099">0.028</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span><span style="color:#099">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span style="color:#099">0.041</span>  <span style="color:#099">43546</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">375176</span> rows x <span style="color:#099">5</span> columns]
</span></span></code></pre></div><p>做完这些，就可以将info跟nutrients合并起来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">176</span>]: ndata <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>merge(nutrients, info, on<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;id&#39;</span>, how<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;outer&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">177</span>]: ndata<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>Int64Index: <span style="color:#099">375176</span> entries, <span style="color:#099">0</span> to <span style="color:#099">375175</span>
</span></span><span style="display:flex;"><span>Data columns (total <span style="color:#099">8</span> columns):
</span></span><span style="display:flex;"><span>nutrient        <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>nutgroup        <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>units           <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>value           <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span><span style="color:#0086b3">id</span>              <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null int64
</span></span><span style="display:flex;"><span>food            <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>fgroup          <span style="color:#099">375176</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>manufacturer    <span style="color:#099">293054</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>dtypes: float64(<span style="color:#099">1</span>), int64(<span style="color:#099">1</span>), <span style="color:#0086b3">object</span>(<span style="color:#099">6</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">25.8</span><span style="color:#000;font-weight:bold">+</span> MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">178</span>]: ndata<span style="color:#000;font-weight:bold">.</span>iloc[<span style="color:#099">30000</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">178</span>]: 
</span></span><span style="display:flex;"><span>nutrient                                       Glycine
</span></span><span style="display:flex;"><span>nutgroup                                   Amino Acids
</span></span><span style="display:flex;"><span>units                                                g
</span></span><span style="display:flex;"><span>value                                             <span style="color:#099">0.04</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">id</span>                                                <span style="color:#099">6158</span>
</span></span><span style="display:flex;"><span>food            Soup, tomato bisque, canned, condensed
</span></span><span style="display:flex;"><span>fgroup                      Soups, Sauces, <span style="color:#000;font-weight:bold">and</span> Gravies
</span></span><span style="display:flex;"><span>manufacturer                                          
</span></span><span style="display:flex;"><span>Name: <span style="color:#099">30000</span>, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>我们现在可以根据食物分类和营养类型画出一张中位值图（如图14-11所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">180</span>]: result <span style="color:#000;font-weight:bold">=</span> ndata<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;nutrient&#39;</span>, <span style="color:#d14">&#39;fgroup&#39;</span>])[<span style="color:#d14">&#39;value&#39;</span>]<span style="color:#000;font-weight:bold">.</span>quantile(<span style="color:#099">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">181</span>]: result[<span style="color:#d14">&#39;Zinc, Zn&#39;</span>]<span style="color:#000;font-weight:bold">.</span>sort_values()<span style="color:#000;font-weight:bold">.</span>plot(kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;barh&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180432697.png" alt="图片14-11 根据营养分类得出的锌中位值"></p>
<p>只要稍微动一动脑子，就可以发现各营养成分最为丰富的食物是什么了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>by_nutrient <span style="color:#000;font-weight:bold">=</span> ndata<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;nutgroup&#39;</span>, <span style="color:#d14">&#39;nutrient&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_maximum <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: x<span style="color:#000;font-weight:bold">.</span>loc[x<span style="color:#000;font-weight:bold">.</span>value<span style="color:#000;font-weight:bold">.</span>idxmax()]
</span></span><span style="display:flex;"><span>get_minimum <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: x<span style="color:#000;font-weight:bold">.</span>loc[x<span style="color:#000;font-weight:bold">.</span>value<span style="color:#000;font-weight:bold">.</span>idxmin()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_foods <span style="color:#000;font-weight:bold">=</span> by_nutrient<span style="color:#000;font-weight:bold">.</span>apply(get_maximum)[[<span style="color:#d14">&#39;value&#39;</span>, <span style="color:#d14">&#39;food&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># make the food a little smaller</span>
</span></span><span style="display:flex;"><span>max_foods<span style="color:#000;font-weight:bold">.</span>food <span style="color:#000;font-weight:bold">=</span> max_foods<span style="color:#000;font-weight:bold">.</span>food<span style="color:#000;font-weight:bold">.</span>str[:<span style="color:#099">50</span>]
</span></span></code></pre></div><p>由于得到的DataFrame很大，所以不方便在书里面全部打印出来。这里只给出&quot;Amino Acids&quot;营养分组：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">183</span>]: max_foods<span style="color:#000;font-weight:bold">.</span>loc[<span style="color:#d14">&#39;Amino Acids&#39;</span>][<span style="color:#d14">&#39;food&#39;</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">183</span>]: 
</span></span><span style="display:flex;"><span>nutrient
</span></span><span style="display:flex;"><span>Alanine                          Gelatins, dry powder, unsweetened
</span></span><span style="display:flex;"><span>Arginine                              Seeds, sesame flour, low<span style="color:#000;font-weight:bold">-</span>fat
</span></span><span style="display:flex;"><span>Aspartic acid                                  Soy protein isolate
</span></span><span style="display:flex;"><span>Cystine               Seeds, cottonseed flour, low fat (glandless)
</span></span><span style="display:flex;"><span>Glutamic acid                                  Soy protein isolate
</span></span><span style="display:flex;"><span>                                       <span style="color:#000;font-weight:bold">...</span>                        
</span></span><span style="display:flex;"><span>Serine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>Threonine        Soy protein isolate, PROTEIN TECHNOLOGIES INTE<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>Tryptophan        Sea lion, Steller, meat <span style="color:#000;font-weight:bold">with</span> fat (Alaska Native)
</span></span><span style="display:flex;"><span>Tyrosine         Soy protein isolate, PROTEIN TECHNOLOGIES INTE<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>Valine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>Name: food, Length: <span style="color:#099">19</span>, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><h2 id="145-2012联邦选举委员会数据库">14.5 2012联邦选举委员会数据库</h2>
<p>美国联邦选举委员会发布了有关政治竞选赞助方面的数据。其中包括赞助者的姓名、职业、雇主、地址以及出资额等信息。我们对2012年美国总统大选的数据集比较感兴趣（http://www.fec.gov/disclosurep/PDownload.do）。我在2012年6月下载的数据集是一个150MB的CSV文件（P00000001-ALL.csv），我们先用pandas.read_csv将其加载进来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">184</span>]: fec <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>read_csv(<span style="color:#d14">&#39;datasets/fec/P00000001-ALL.csv&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">185</span>]: fec<span style="color:#000;font-weight:bold">.</span>info()
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">&#39;</span><span style="color:#458;font-weight:bold">pandas</span><span style="color:#000;font-weight:bold">.</span>core<span style="color:#000;font-weight:bold">.</span>frame<span style="color:#000;font-weight:bold">.</span>DataFrame<span style="color:#d14">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>RangeIndex: <span style="color:#099">1001731</span> entries, <span style="color:#099">0</span> to <span style="color:#099">1001730</span>
</span></span><span style="display:flex;"><span>Data columns (total <span style="color:#099">16</span> columns):
</span></span><span style="display:flex;"><span>cmte_id              <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>cand_id              <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>cand_nm              <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_nm            <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_city          <span style="color:#099">1001712</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_st            <span style="color:#099">1001727</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_zip           <span style="color:#099">1001620</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_employer      <span style="color:#099">988002</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contbr_occupation    <span style="color:#099">993301</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>contb_receipt_amt    <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null float64
</span></span><span style="display:flex;"><span>contb_receipt_dt     <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>receipt_desc         <span style="color:#099">14166</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>memo_cd              <span style="color:#099">92482</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>memo_text            <span style="color:#099">97770</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>form_tp              <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>file_num             <span style="color:#099">1001731</span> non<span style="color:#000;font-weight:bold">-</span>null int64
</span></span><span style="display:flex;"><span>dtypes: float64(<span style="color:#099">1</span>), int64(<span style="color:#099">1</span>), <span style="color:#0086b3">object</span>(<span style="color:#099">14</span>)
</span></span><span style="display:flex;"><span>memory usage: <span style="color:#099">122.3</span><span style="color:#000;font-weight:bold">+</span> MB
</span></span></code></pre></div><p>该DataFrame中的记录如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">186</span>]: fec<span style="color:#000;font-weight:bold">.</span>iloc[<span style="color:#099">123456</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">186</span>]: 
</span></span><span style="display:flex;"><span>cmte_id             C00431445
</span></span><span style="display:flex;"><span>cand_id             P80003338
</span></span><span style="display:flex;"><span>cand_nm         Obama, Barack
</span></span><span style="display:flex;"><span>contbr_nm         ELLMAN, IRA
</span></span><span style="display:flex;"><span>contbr_city             TEMPE
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">...</span>      
</span></span><span style="display:flex;"><span>receipt_desc              NaN
</span></span><span style="display:flex;"><span>memo_cd                   NaN
</span></span><span style="display:flex;"><span>memo_text                 NaN
</span></span><span style="display:flex;"><span>form_tp                 SA17A
</span></span><span style="display:flex;"><span>file_num               <span style="color:#099">772372</span>
</span></span><span style="display:flex;"><span>Name: <span style="color:#099">123456</span>, Length: <span style="color:#099">16</span>, dtype: <span style="color:#0086b3">object</span>
</span></span></code></pre></div><p>你可能已经想出了许多办法从这些竞选赞助数据中抽取有关赞助人和赞助模式的统计信息。我将在接下来的内容中介绍几种不同的分析工作（运用到目前为止已经学到的方法）。</p>
<p>不难看出，该数据中没有党派信息，因此最好把它加进去。通过unique，你可以获取全部的候选人名单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">187</span>]: unique_cands <span style="color:#000;font-weight:bold">=</span> fec<span style="color:#000;font-weight:bold">.</span>cand_nm<span style="color:#000;font-weight:bold">.</span>unique()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">188</span>]: unique_cands
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">188</span>]: 
</span></span><span style="display:flex;"><span>array([<span style="color:#d14">&#39;Bachmann, Michelle&#39;</span>, <span style="color:#d14">&#39;Romney, Mitt&#39;</span>, <span style="color:#d14">&#39;Obama, Barack&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#34;Roemer, Charles E. &#39;Buddy&#39; III&#34;</span>, <span style="color:#d14">&#39;Pawlenty, Timothy&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Johnson, Gary Earl&#39;</span>, <span style="color:#d14">&#39;Paul, Ron&#39;</span>, <span style="color:#d14">&#39;Santorum, Rick&#39;</span>, <span style="color:#d14">&#39;Cain, Herman&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Gingrich, Newt&#39;</span>, <span style="color:#d14">&#39;McCotter, Thaddeus G&#39;</span>, <span style="color:#d14">&#39;Huntsman, Jon&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#d14">&#39;Perry, Rick&#39;</span>], dtype<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">object</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">189</span>]: unique_cands[<span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">189</span>]: <span style="color:#d14">&#39;Obama, Barack&#39;</span>
</span></span></code></pre></div><p>指明党派信息的方法之一是使用字典：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>parties <span style="color:#000;font-weight:bold">=</span> {<span style="color:#d14">&#39;Bachmann, Michelle&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Cain, Herman&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Gingrich, Newt&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Huntsman, Jon&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Johnson, Gary Earl&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;McCotter, Thaddeus G&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Obama, Barack&#39;</span>: <span style="color:#d14">&#39;Democrat&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Paul, Ron&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Pawlenty, Timothy&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Perry, Rick&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#34;Roemer, Charles E. &#39;Buddy&#39; III&#34;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Romney, Mitt&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#d14">&#39;Santorum, Rick&#39;</span>: <span style="color:#d14">&#39;Republican&#39;</span>}
</span></span></code></pre></div><p>现在，通过这个映射以及Series对象的map方法，你可以根据候选人姓名得到一组党派信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">191</span>]: fec<span style="color:#000;font-weight:bold">.</span>cand_nm[<span style="color:#099">123456</span>:<span style="color:#099">123461</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">191</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">123456</span>    Obama, Barack
</span></span><span style="display:flex;"><span><span style="color:#099">123457</span>    Obama, Barack
</span></span><span style="display:flex;"><span><span style="color:#099">123458</span>    Obama, Barack
</span></span><span style="display:flex;"><span><span style="color:#099">123459</span>    Obama, Barack
</span></span><span style="display:flex;"><span><span style="color:#099">123460</span>    Obama, Barack
</span></span><span style="display:flex;"><span>Name: cand_nm, dtype: <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">192</span>]: fec<span style="color:#000;font-weight:bold">.</span>cand_nm[<span style="color:#099">123456</span>:<span style="color:#099">123461</span>]<span style="color:#000;font-weight:bold">.</span>map(parties)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">192</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">123456</span>    Democrat
</span></span><span style="display:flex;"><span><span style="color:#099">123457</span>    Democrat
</span></span><span style="display:flex;"><span><span style="color:#099">123458</span>    Democrat
</span></span><span style="display:flex;"><span><span style="color:#099">123459</span>    Democrat
</span></span><span style="display:flex;"><span><span style="color:#099">123460</span>    Democrat
</span></span><span style="display:flex;"><span>Name: cand_nm, dtype: <span style="color:#0086b3">object</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Add it as a column</span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">193</span>]: fec[<span style="color:#d14">&#39;party&#39;</span>] <span style="color:#000;font-weight:bold">=</span> fec<span style="color:#000;font-weight:bold">.</span>cand_nm<span style="color:#000;font-weight:bold">.</span>map(parties)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">194</span>]: fec[<span style="color:#d14">&#39;party&#39;</span>]<span style="color:#000;font-weight:bold">.</span>value_counts()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">194</span>]: 
</span></span><span style="display:flex;"><span>Democrat      <span style="color:#099">593746</span>
</span></span><span style="display:flex;"><span>Republican    <span style="color:#099">407985</span>
</span></span><span style="display:flex;"><span>Name: party, dtype: int64
</span></span></code></pre></div><p>这里有两个需要注意的地方。第一，该数据既包括赞助也包括退款（负的出资额）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">195</span>]: (fec<span style="color:#000;font-weight:bold">.</span>contb_receipt_amt <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>)<span style="color:#000;font-weight:bold">.</span>value_counts()
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">195</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">True</span>     <span style="color:#099">991475</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">False</span>     <span style="color:#099">10256</span>
</span></span><span style="display:flex;"><span>Name: contb_receipt_amt, dtype: int64
</span></span></code></pre></div><p>为了简化分析过程，我限定该数据集只能有正的出资额：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">196</span>]: fec <span style="color:#000;font-weight:bold">=</span> fec[fec<span style="color:#000;font-weight:bold">.</span>contb_receipt_amt <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>]
</span></span></code></pre></div><p>由于Barack Obama和Mitt Romney是最主要的两名候选人，所以我还专门准备了一个子集，只包含针对他们两人的竞选活动的赞助信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">197</span>]: fec_mrbo <span style="color:#000;font-weight:bold">=</span> fec[fec<span style="color:#000;font-weight:bold">.</span>cand_nm<span style="color:#000;font-weight:bold">.</span>isin([<span style="color:#d14">&#39;Obama, Barack&#39;</span>,<span style="color:#d14">&#39;Romney, Mitt&#39;</span>])]
</span></span></code></pre></div><h3 id="1451-根据职业和雇主统计赞助信息">14.5.1 根据职业和雇主统计赞助信息</h3>
<p>基于职业的赞助信息统计是另一种经常被研究的统计任务。例如，律师们更倾向于资助民主党，而企业主则更倾向于资助共和党。你可以不相信我，自己看那些数据就知道了。首先，根据职业计算出资总额，这很简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">198</span>]: fec<span style="color:#000;font-weight:bold">.</span>contbr_occupation<span style="color:#000;font-weight:bold">.</span>value_counts()[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">198</span>]: 
</span></span><span style="display:flex;"><span>RETIRED                                   <span style="color:#099">233990</span>
</span></span><span style="display:flex;"><span>INFORMATION REQUESTED                      <span style="color:#099">35107</span>
</span></span><span style="display:flex;"><span>ATTORNEY                                   <span style="color:#099">34286</span>
</span></span><span style="display:flex;"><span>HOMEMAKER                                  <span style="color:#099">29931</span>
</span></span><span style="display:flex;"><span>PHYSICIAN                                  <span style="color:#099">23432</span>
</span></span><span style="display:flex;"><span>INFORMATION REQUESTED PER BEST EFFORTS     <span style="color:#099">21138</span>
</span></span><span style="display:flex;"><span>ENGINEER                                   <span style="color:#099">14334</span>
</span></span><span style="display:flex;"><span>TEACHER                                    <span style="color:#099">13990</span>
</span></span><span style="display:flex;"><span>CONSULTANT                                 <span style="color:#099">13273</span>
</span></span><span style="display:flex;"><span>PROFESSOR                                  <span style="color:#099">12555</span>
</span></span><span style="display:flex;"><span>Name: contbr_occupation, dtype: int64
</span></span></code></pre></div><p>不难看出，许多职业都涉及相同的基本工作类型，或者同一样东西有多种变体。下面的代码片段可以清理一些这样的数据（将一个职业信息映射到另一个）。注意，这里巧妙地利用了dict.get，它允许没有映射关系的职业也能“通过”：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>occ_mapping <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;INFORMATION REQUESTED PER BEST EFFORTS&#39;</span> : <span style="color:#d14">&#39;NOT PROVIDED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;INFORMATION REQUESTED&#39;</span> : <span style="color:#d14">&#39;NOT PROVIDED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;INFORMATION REQUESTED (BEST EFFORTS)&#39;</span> : <span style="color:#d14">&#39;NOT PROVIDED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;C.E.O.&#39;</span>: <span style="color:#d14">&#39;CEO&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># If no mapping provided, return x</span>
</span></span><span style="display:flex;"><span>f <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: occ_mapping<span style="color:#000;font-weight:bold">.</span>get(x, x)
</span></span><span style="display:flex;"><span>fec<span style="color:#000;font-weight:bold">.</span>contbr_occupation <span style="color:#000;font-weight:bold">=</span> fec<span style="color:#000;font-weight:bold">.</span>contbr_occupation<span style="color:#000;font-weight:bold">.</span>map(f)
</span></span></code></pre></div><p>我对雇主信息也进行了同样的处理：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>emp_mapping <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;INFORMATION REQUESTED PER BEST EFFORTS&#39;</span> : <span style="color:#d14">&#39;NOT PROVIDED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;INFORMATION REQUESTED&#39;</span> : <span style="color:#d14">&#39;NOT PROVIDED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;SELF&#39;</span> : <span style="color:#d14">&#39;SELF-EMPLOYED&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#d14">&#39;SELF EMPLOYED&#39;</span> : <span style="color:#d14">&#39;SELF-EMPLOYED&#39;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># If no mapping provided, return x</span>
</span></span><span style="display:flex;"><span>f <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">lambda</span> x: emp_mapping<span style="color:#000;font-weight:bold">.</span>get(x, x)
</span></span><span style="display:flex;"><span>fec<span style="color:#000;font-weight:bold">.</span>contbr_employer <span style="color:#000;font-weight:bold">=</span> fec<span style="color:#000;font-weight:bold">.</span>contbr_employer<span style="color:#000;font-weight:bold">.</span>map(f)
</span></span></code></pre></div><p>现在，你可以通过pivot_table根据党派和职业对数据进行聚合，然后过滤掉总出资额不足200万美元的数据：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">201</span>]: by_occupation <span style="color:#000;font-weight:bold">=</span> fec<span style="color:#000;font-weight:bold">.</span>pivot_table(<span style="color:#d14">&#39;contb_receipt_amt&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                 index<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;contbr_occupation&#39;</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                                 columns<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;party&#39;</span>, aggfunc<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;sum&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">202</span>]: over_2mm <span style="color:#000;font-weight:bold">=</span> by_occupation[by_occupation<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">2000000</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">203</span>]: over_2mm
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">203</span>]: 
</span></span><span style="display:flex;"><span>party                 Democrat    Republican
</span></span><span style="display:flex;"><span>contbr_occupation                           
</span></span><span style="display:flex;"><span>ATTORNEY           <span style="color:#099">11141982.97</span>  <span style="color:#099">7.477194e+06</span>
</span></span><span style="display:flex;"><span>CEO                 <span style="color:#099">2074974.79</span>  <span style="color:#099">4.211041e+06</span>
</span></span><span style="display:flex;"><span>CONSULTANT          <span style="color:#099">2459912.71</span>  <span style="color:#099">2.544725e+06</span>
</span></span><span style="display:flex;"><span>ENGINEER             <span style="color:#099">951525.55</span>  <span style="color:#099">1.818374e+06</span>
</span></span><span style="display:flex;"><span>EXECUTIVE           <span style="color:#099">1355161.05</span>  <span style="color:#099">4.138850e+06</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>                        <span style="color:#000;font-weight:bold">...</span>           <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>PRESIDENT           <span style="color:#099">1878509.95</span>  <span style="color:#099">4.720924e+06</span>
</span></span><span style="display:flex;"><span>PROFESSOR           <span style="color:#099">2165071.08</span>  <span style="color:#099">2.967027e+05</span>
</span></span><span style="display:flex;"><span>REAL ESTATE          <span style="color:#099">528902.09</span>  <span style="color:#099">1.625902e+06</span>
</span></span><span style="display:flex;"><span>RETIRED            <span style="color:#099">25305116.38</span>  <span style="color:#099">2.356124e+07</span>
</span></span><span style="display:flex;"><span>SELF<span style="color:#000;font-weight:bold">-</span>EMPLOYED        <span style="color:#099">672393.40</span>  <span style="color:#099">1.640253e+06</span>
</span></span><span style="display:flex;"><span>[<span style="color:#099">17</span> rows x <span style="color:#099">2</span> columns]
</span></span></code></pre></div><p>把这些数据做成柱状图看起来会更加清楚（&lsquo;barh&rsquo;表示水平柱状图，如图14-12所示）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">205</span>]: over_2mm<span style="color:#000;font-weight:bold">.</span>plot(kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;barh&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180453918.png" alt="图14-12 对各党派总出资额最高的职业"></p>
<p>你可能还想了解一下对Obama和Romney总出资额最高的职业和企业。为此，我们先对候选人进行分组，然后使用本章前面介绍的类似top的方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">get_top_amounts</span>(group, key, n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">5</span>):
</span></span><span style="display:flex;"><span>    totals <span style="color:#000;font-weight:bold">=</span> group<span style="color:#000;font-weight:bold">.</span>groupby(key)[<span style="color:#d14">&#39;contb_receipt_amt&#39;</span>]<span style="color:#000;font-weight:bold">.</span>sum()
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> totals<span style="color:#000;font-weight:bold">.</span>nlargest(n)
</span></span></code></pre></div><p>然后根据职业和雇主进行聚合：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">207</span>]: grouped <span style="color:#000;font-weight:bold">=</span> fec_mrbo<span style="color:#000;font-weight:bold">.</span>groupby(<span style="color:#d14">&#39;cand_nm&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">208</span>]: grouped<span style="color:#000;font-weight:bold">.</span>apply(get_top_amounts, <span style="color:#d14">&#39;contbr_occupation&#39;</span>, n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">7</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">208</span>]: 
</span></span><span style="display:flex;"><span>cand_nm        contbr_occupation    
</span></span><span style="display:flex;"><span>Obama, Barack  RETIRED                  <span style="color:#099">25305116.38</span>
</span></span><span style="display:flex;"><span>               ATTORNEY                 <span style="color:#099">11141982.97</span>
</span></span><span style="display:flex;"><span>               INFORMATION REQUESTED     <span style="color:#099">4866973.96</span>
</span></span><span style="display:flex;"><span>               HOMEMAKER                 <span style="color:#099">4248875.80</span>
</span></span><span style="display:flex;"><span>               PHYSICIAN                 <span style="color:#099">3735124.94</span>
</span></span><span style="display:flex;"><span>                                           <span style="color:#000;font-weight:bold">...</span>     
</span></span><span style="display:flex;"><span>Romney, Mitt   HOMEMAKER                 <span style="color:#099">8147446.22</span>
</span></span><span style="display:flex;"><span>               ATTORNEY                  <span style="color:#099">5364718.82</span>
</span></span><span style="display:flex;"><span>               PRESIDENT                 <span style="color:#099">2491244.89</span>
</span></span><span style="display:flex;"><span>               EXECUTIVE                 <span style="color:#099">2300947.03</span>
</span></span><span style="display:flex;"><span>               C<span style="color:#000;font-weight:bold">.</span>E<span style="color:#000;font-weight:bold">.</span>O<span style="color:#000;font-weight:bold">.</span>                    <span style="color:#099">1968386.11</span>
</span></span><span style="display:flex;"><span>Name: contb_receipt_amt, Length: <span style="color:#099">14</span>, dtype: float64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">209</span>]: grouped<span style="color:#000;font-weight:bold">.</span>apply(get_top_amounts, <span style="color:#d14">&#39;contbr_employer&#39;</span>, n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">209</span>]: 
</span></span><span style="display:flex;"><span>cand_nm        contbr_employer      
</span></span><span style="display:flex;"><span>Obama, Barack  RETIRED                  <span style="color:#099">22694358.85</span>
</span></span><span style="display:flex;"><span>               SELF<span style="color:#000;font-weight:bold">-</span>EMPLOYED            <span style="color:#099">17080985.96</span>
</span></span><span style="display:flex;"><span>               NOT EMPLOYED              <span style="color:#099">8586308.70</span>
</span></span><span style="display:flex;"><span>               INFORMATION REQUESTED     <span style="color:#099">5053480.37</span>
</span></span><span style="display:flex;"><span>               HOMEMAKER                 <span style="color:#099">2605408.54</span>
</span></span><span style="display:flex;"><span>                                           <span style="color:#000;font-weight:bold">...</span>     
</span></span><span style="display:flex;"><span>Romney, Mitt   CREDIT SUISSE              <span style="color:#099">281150.00</span>
</span></span><span style="display:flex;"><span>               MORGAN STANLEY             <span style="color:#099">267266.00</span>
</span></span><span style="display:flex;"><span>               GOLDMAN SACH <span style="color:#000;font-weight:bold">&amp;</span> CO<span style="color:#000;font-weight:bold">.</span>         <span style="color:#099">238250.00</span>
</span></span><span style="display:flex;"><span>               BARCLAYS CAPITAL           <span style="color:#099">162750.00</span>
</span></span><span style="display:flex;"><span>               H<span style="color:#000;font-weight:bold">.</span>I<span style="color:#000;font-weight:bold">.</span>G<span style="color:#000;font-weight:bold">.</span> CAPITAL             <span style="color:#099">139500.00</span>
</span></span><span style="display:flex;"><span>Name: contb_receipt_amt, Length: <span style="color:#099">20</span>, dtype: float64
</span></span></code></pre></div><h3 id="1452-对出资额分组">14.5.2 对出资额分组</h3>
<p>还可以对该数据做另一种非常实用的分析：利用cut函数根据出资额的大小将数据离散化到多个面元中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">210</span>]: bins <span style="color:#000;font-weight:bold">=</span> np<span style="color:#000;font-weight:bold">.</span>array([<span style="color:#099">0</span>, <span style="color:#099">1</span>, <span style="color:#099">10</span>, <span style="color:#099">100</span>, <span style="color:#099">1000</span>, <span style="color:#099">10000</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">.....</span>:                  <span style="color:#099">100000</span>, <span style="color:#099">1000000</span>, <span style="color:#099">10000000</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">211</span>]: labels <span style="color:#000;font-weight:bold">=</span> pd<span style="color:#000;font-weight:bold">.</span>cut(fec_mrbo<span style="color:#000;font-weight:bold">.</span>contb_receipt_amt, bins)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">212</span>]: labels
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">212</span>]: 
</span></span><span style="display:flex;"><span><span style="color:#099">411</span>         (<span style="color:#099">10</span>, <span style="color:#099">100</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">412</span>       (<span style="color:#099">100</span>, <span style="color:#099">1000</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">413</span>       (<span style="color:#099">100</span>, <span style="color:#099">1000</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">414</span>         (<span style="color:#099">10</span>, <span style="color:#099">100</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">415</span>         (<span style="color:#099">10</span>, <span style="color:#099">100</span>]
</span></span><span style="display:flex;"><span>             <span style="color:#000;font-weight:bold">...</span>     
</span></span><span style="display:flex;"><span><span style="color:#099">701381</span>      (<span style="color:#099">10</span>, <span style="color:#099">100</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">701382</span>    (<span style="color:#099">100</span>, <span style="color:#099">1000</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">701383</span>        (<span style="color:#099">1</span>, <span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">701384</span>      (<span style="color:#099">10</span>, <span style="color:#099">100</span>]
</span></span><span style="display:flex;"><span><span style="color:#099">701385</span>    (<span style="color:#099">100</span>, <span style="color:#099">1000</span>]
</span></span><span style="display:flex;"><span>Name: contb_receipt_amt, Length: <span style="color:#099">694282</span>, dtype: category
</span></span><span style="display:flex;"><span>Categories (<span style="color:#099">8</span>, interval[int64]): [(<span style="color:#099">0</span>, <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">1</span>, <span style="color:#099">10</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">10</span>, <span style="color:#099">100</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">100</span>, <span style="color:#099">1000</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#099">000</span>, <span style="color:#099">10000</span>] <span style="color:#000;font-weight:bold">&lt;</span>
</span></span><span style="display:flex;"><span>                                  (<span style="color:#099">10000</span>, <span style="color:#099">100000</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">100000</span>, <span style="color:#099">1000000</span>] <span style="color:#000;font-weight:bold">&lt;</span> (<span style="color:#099">1000000</span>,
</span></span><span style="display:flex;"><span> <span style="color:#099">10000000</span>]]
</span></span></code></pre></div><p>现在可以根据候选人姓名以及面元标签对奥巴马和罗姆尼数据进行分组，以得到一个柱状图：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">213</span>]: grouped <span style="color:#000;font-weight:bold">=</span> fec_mrbo<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;cand_nm&#39;</span>, labels])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">214</span>]: grouped<span style="color:#000;font-weight:bold">.</span>size()<span style="color:#000;font-weight:bold">.</span>unstack(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">214</span>]: 
</span></span><span style="display:flex;"><span>cand_nm              Obama, Barack  Romney, Mitt
</span></span><span style="display:flex;"><span>contb_receipt_amt                               
</span></span><span style="display:flex;"><span>(<span style="color:#099">0</span>, <span style="color:#099">1</span>]                       <span style="color:#099">493.0</span>          <span style="color:#099">77.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">1</span>, <span style="color:#099">10</span>]                    <span style="color:#099">40070.0</span>        <span style="color:#099">3681.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">10</span>, <span style="color:#099">100</span>]                 <span style="color:#099">372280.0</span>       <span style="color:#099">31853.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">100</span>, <span style="color:#099">1000</span>]               <span style="color:#099">153991.0</span>       <span style="color:#099">43357.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">1000</span>, <span style="color:#099">10000</span>]              <span style="color:#099">22284.0</span>       <span style="color:#099">26186.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">10000</span>, <span style="color:#099">100000</span>]                <span style="color:#099">2.0</span>           <span style="color:#099">1.0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">100000</span>, <span style="color:#099">1000000</span>]              <span style="color:#099">3.0</span>           NaN
</span></span><span style="display:flex;"><span>(<span style="color:#099">1000000</span>, <span style="color:#099">10000000</span>]            <span style="color:#099">4.0</span>           NaN
</span></span></code></pre></div><p>从这个数据中可以看出，在小额赞助方面，Obama获得的数量比Romney多得多。你还可以对出资额求和并在面元内规格化，以便图形化显示两位候选人各种赞助额度的比例（见图14-13）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">216</span>]: bucket_sums <span style="color:#000;font-weight:bold">=</span> grouped<span style="color:#000;font-weight:bold">.</span>contb_receipt_amt<span style="color:#000;font-weight:bold">.</span>sum()<span style="color:#000;font-weight:bold">.</span>unstack(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">217</span>]: normed_sums <span style="color:#000;font-weight:bold">=</span> bucket_sums<span style="color:#000;font-weight:bold">.</span>div(bucket_sums<span style="color:#000;font-weight:bold">.</span>sum(axis<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>), axis<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">218</span>]: normed_sums
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">218</span>]: 
</span></span><span style="display:flex;"><span>cand_nm              Obama, Barack  Romney, Mitt
</span></span><span style="display:flex;"><span>contb_receipt_amt                               
</span></span><span style="display:flex;"><span>(<span style="color:#099">0</span>, <span style="color:#099">1</span>]                    <span style="color:#099">0.805182</span>      <span style="color:#099">0.194818</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">1</span>, <span style="color:#099">10</span>]                   <span style="color:#099">0.918767</span>      <span style="color:#099">0.081233</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">10</span>, <span style="color:#099">100</span>]                 <span style="color:#099">0.910769</span>      <span style="color:#099">0.089231</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">100</span>, <span style="color:#099">1000</span>]               <span style="color:#099">0.710176</span>      <span style="color:#099">0.289824</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">1000</span>, <span style="color:#099">10000</span>]             <span style="color:#099">0.447326</span>      <span style="color:#099">0.552674</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">10000</span>, <span style="color:#099">100000</span>]           <span style="color:#099">0.823120</span>      <span style="color:#099">0.176880</span>
</span></span><span style="display:flex;"><span>(<span style="color:#099">100000</span>, <span style="color:#099">1000000</span>]         <span style="color:#099">1.000000</span>           NaN
</span></span><span style="display:flex;"><span>(<span style="color:#099">1000000</span>, <span style="color:#099">10000000</span>]       <span style="color:#099">1.000000</span>           NaN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">219</span>]: normed_sums[:<span style="color:#000;font-weight:bold">-</span><span style="color:#099">2</span>]<span style="color:#000;font-weight:bold">.</span>plot(kind<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;barh&#39;</span>)
</span></span></code></pre></div><p><img src="https://gitee.com/wugenqiang/images/raw/master/02/1240-20201031180513851.png" alt="图14-13 两位候选人收到的各种捐赠额度的总额比例"></p>
<p>我排除了两个最大的面元，因为这些不是由个人捐赠的。</p>
<p>还可以对该分析过程做许多的提炼和改进。比如说，可以根据赞助人的姓名和邮编对数据进行聚合，以便找出哪些人进行了多次小额捐款，哪些人又进行了一次或多次大额捐款。我强烈建议你下载这些数据并自己摸索一下。</p>
<h3 id="1453-根据州统计赞助信息">14.5.3 根据州统计赞助信息</h3>
<p>根据候选人和州对数据进行聚合是常规操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">220</span>]: grouped <span style="color:#000;font-weight:bold">=</span> fec_mrbo<span style="color:#000;font-weight:bold">.</span>groupby([<span style="color:#d14">&#39;cand_nm&#39;</span>, <span style="color:#d14">&#39;contbr_st&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">221</span>]: totals <span style="color:#000;font-weight:bold">=</span> grouped<span style="color:#000;font-weight:bold">.</span>contb_receipt_amt<span style="color:#000;font-weight:bold">.</span>sum()<span style="color:#000;font-weight:bold">.</span>unstack(<span style="color:#099">0</span>)<span style="color:#000;font-weight:bold">.</span>fillna(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">222</span>]: totals <span style="color:#000;font-weight:bold">=</span> totals[totals<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">100000</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">223</span>]: totals[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">223</span>]: 
</span></span><span style="display:flex;"><span>cand_nm    Obama, Barack  Romney, Mitt
</span></span><span style="display:flex;"><span>contbr_st                             
</span></span><span style="display:flex;"><span>AK             <span style="color:#099">281840.15</span>      <span style="color:#099">86204.24</span>
</span></span><span style="display:flex;"><span>AL             <span style="color:#099">543123.48</span>     <span style="color:#099">527303.51</span>
</span></span><span style="display:flex;"><span>AR             <span style="color:#099">359247.28</span>     <span style="color:#099">105556.00</span>
</span></span><span style="display:flex;"><span>AZ            <span style="color:#099">1506476.98</span>    <span style="color:#099">1888436.23</span>
</span></span><span style="display:flex;"><span>CA           <span style="color:#099">23824984.24</span>   <span style="color:#099">11237636.60</span>
</span></span><span style="display:flex;"><span>CO            <span style="color:#099">2132429.49</span>    <span style="color:#099">1506714.12</span>
</span></span><span style="display:flex;"><span>CT            <span style="color:#099">2068291.26</span>    <span style="color:#099">3499475.45</span>
</span></span><span style="display:flex;"><span>DC            <span style="color:#099">4373538.80</span>    <span style="color:#099">1025137.50</span>
</span></span><span style="display:flex;"><span>DE             <span style="color:#099">336669.14</span>      <span style="color:#099">82712.00</span>
</span></span><span style="display:flex;"><span>FL            <span style="color:#099">7318178.58</span>    <span style="color:#099">8338458.81</span>
</span></span></code></pre></div><p>如果对各行除以总赞助额，就会得到各候选人在各州的总赞助额比例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#099">224</span>]: percent <span style="color:#000;font-weight:bold">=</span> totals<span style="color:#000;font-weight:bold">.</span>div(totals<span style="color:#000;font-weight:bold">.</span>sum(<span style="color:#099">1</span>), axis<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#099">225</span>]: percent[:<span style="color:#099">10</span>]
</span></span><span style="display:flex;"><span>Out[<span style="color:#099">225</span>]: 
</span></span><span style="display:flex;"><span>cand_nm    Obama, Barack  Romney, Mitt
</span></span><span style="display:flex;"><span>contbr_st                             
</span></span><span style="display:flex;"><span>AK              <span style="color:#099">0.765778</span>      <span style="color:#099">0.234222</span>
</span></span><span style="display:flex;"><span>AL              <span style="color:#099">0.507390</span>      <span style="color:#099">0.492610</span>
</span></span><span style="display:flex;"><span>AR              <span style="color:#099">0.772902</span>      <span style="color:#099">0.227098</span>
</span></span><span style="display:flex;"><span>AZ              <span style="color:#099">0.443745</span>      <span style="color:#099">0.556255</span>
</span></span><span style="display:flex;"><span>CA              <span style="color:#099">0.679498</span>      <span style="color:#099">0.320502</span>
</span></span><span style="display:flex;"><span>CO              <span style="color:#099">0.585970</span>      <span style="color:#099">0.414030</span>
</span></span><span style="display:flex;"><span>CT              <span style="color:#099">0.371476</span>      <span style="color:#099">0.628524</span>
</span></span><span style="display:flex;"><span>DC              <span style="color:#099">0.810113</span>      <span style="color:#099">0.189887</span>
</span></span><span style="display:flex;"><span>DE              <span style="color:#099">0.802776</span>      <span style="color:#099">0.197224</span>
</span></span><span style="display:flex;"><span>FL              <span style="color:#099">0.467417</span>      <span style="color:#099">0.532583</span>
</span></span></code></pre></div><h2 id="146-总结">14.6 总结</h2>
<p>我们已经完成了正文的最后一章。附录中有一些额外的内容，可能对你有用。</p>
<p>本书第一版出版已经有5年了，Python已经成为了一个流行的、广泛使用的数据分析语言。你从本书中学到的方法，在相当长的一段时间都是可用的。我希望本书介绍的工具和库对你的工作有用。</p>

    </div>

    

    

    <div class="container-prevnext">
    <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch12-pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">← 第十二章 Pandas 高级应用</a></div>
    <div><a href="https://richfan.site/posts/%E7%A8%8B%E6%8A%80/python/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ch10-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88%E4%B8%8E%E5%88%86%E7%BB%84%E8%BF%90%E7%AE%97/">第十章 数据聚合与分组运算  →</a></div>
</div>
    
    

    
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="//beian.miit.gov.cn" target="_blank">
        
        京ICP备2022007001号
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
    
</div></div>
    </body>
</html>
