---
title: "Pandas系列之二：数据索引和筛选"
categories: ["编程"]
tags: ["Pandas"]
date: 2023-09-01
---
Pandas是Python中用来进行数据分析的最流行包之一。在使用Pandas进行数据处理和分析时，我们常常需要对数据进行条件筛选（类似于SQL中的where条件筛选），再对筛选后的数据做进一步的处理、分析，以及可视化等等。

那么，对数据进行筛选一般都有哪些方法呢？常见的筛选条件该怎么写？本文就对笔者在工作中常用的条件筛选方法进行了相应总结。

根据官方文档说明，Pandas共有三种数据索引和筛选的方法，包括基于标签的筛选（Selection byLabel）、基于位置的筛选（Selection by Position）和基于可调用函数的筛选（Selection by Callable）。基于可调用函数的筛选其实也是利用前两种方法，只不过可接受可调用的函数作为索引器。

|筛选方法|函数代码|
|---|---|
|基于标签的筛选|.loc|
|基于位置的筛选|.iloc|
|基于可调用函数的筛选|-|

### 一、数据准备

```python
## 导入包

import warnings

warnings.filterwarnings('ignore')

import pandas as pd
```

我们为本文后续的实验创建了一份模拟数据文件，名为“Pandas数据筛选：测试数据.xlsx”。该文件包含了2021年全年的科创板股票日频数据，包括证券代码、交易日期、高低收开价、市值等字段。

> In[2]:

```python
## 读取数据
df = pd.read_excel('Pandas数据筛选：测试数据.xlsx')

df.head()
```

> Out[2]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|0|688001|华兴源创|2020-01-02|45.02|47.20|45.02|46.05|5559087|257194214|1669293160|18466050000|3.624958e+07|9.731247|
|1|688002|睿创微纳|2020-01-02|38.25|39.25|38.15|38.97|2515263|97172509|2009624720|17341650000|5.156851e+07|7.402834|
|2|688003|天准科技|2020-01-02|29.42|30.20|29.42|30.13|2557919|76566252|1331097690|58331680000|4.417848+07|3.566047|
|3|688005|睿百科技|2020-01-02|33.39|34.14|32.80|33.68|3855016|129128983|1372024420|14929862380|4.073707+07|3.457639|
|4|688006|杭可科技|2020-01-02|39.88|40.96|39.88|40.79|1794504|72805892|1500499800|16356790000|3.678597+07|7.357602|


### 二、基于标签的筛选（Selection by Label）

基于标签的筛选方式为.loc[row_indexer, column_indexer]，索引器接受数据行或列的标签，也接受布尔数组。如果行或列标签不存在，则报KeyError错误。

#### 2.1 基本筛选

- 筛选行标签为1的行。

> In[10]: 

```python
## 筛选行标签为1的行，返回Series

df.loc[1]

## df.loc[1, :]
```

> Out[10]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|1|688002|睿创微纳|2020-01-02|38.25|39.25|38.15|38.97|2515263|97172509|2009624720|17341650000|5.156851e+07|7.402834|

- 筛选行标签从1到5，列标签为证券代码、证券简称、收盘价的数据框子集。

> In[12]: 

```python
## 筛选行标签从1到5，列标签从证券代码到日收盘价的数据框，返回DataFrame

df.loc[1:5, '证券代码':'日收盘价']
```

> Out[12]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|
|---|---|---|---|---|---|---|---|
|1|688002|睿创微纳|2020-01-02|38.25|39.25|38.15|38.97|
|2|688003|天准科技|2020-01-02|29.42|30.20|29.42|30.13|
|3|688005|容百科技|2020-01-02|33.39|34.14|32.80|33.68|
|4|688006|杭可科技|2020-01-02|39.88|40.96|39.88|40.79|
|5|688007|光峰科技|2020-01-02|28.16|28.60|28.16|28.52|

需要注意的是，这里筛选的结果包含索引器最后一个，即包含行标签为“5”的行和列标签为“日收盘价”的列。

除了上述连续索引外，我们还可以进行离散索引。比如，我们需要筛选出行标签为1、3，列标签为证券代码、证券简称、日收盘价的数据框子集，代码如下：

> In[14]: 

```python
## 筛选行标签为1、3，列标签为证券代码、证券简称、日收盘价的数据框，返回DataFrame

df.loc[[1, 3], ['证券代码', '证券简称', '日收盘价']]
```

> Out[14]:

|序号|证券代码|证券简称|日收盘价|
|---|---|---|---|
|1|688002|睿创微纳|38.97|
|3|688005|容百科技|33.68|

需要注意的是，在进行离散索引和筛选时，需要用[ ]将离散的行标签和列标签括进来，即以列表形式传入。

#### 2.2 逻辑筛选

我们可以将布尔数组作为参数传入至.loc中进行筛选，这个功能非常强大，几乎可以筛选出任意想要的数据子集。

- 筛选日收盘价大于30的所有行。

> In[22]: 

```python
## 筛选日收盘价大于30的所有行，返回DataFrame

df.loc[df['日收盘价'] > 30, :]
```

> Out[22]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

- 筛选列标签中含“价”的所有列。

> In[21]: 

```python
## 筛选列标签含“价”的所有列，返回DataFrame

df.loc[:, ['价' in col for col in  df.columns]]
```

> Out[21]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

-   筛选证券简称中含“电子”，列标签为证券代码、证券简称、交易日期、日收盘价的数据框子集。

> In[23]: 

```python
## 筛选证券简称中含“电子”关键字、列标签包含证券代码、证券简称、交易日期、日收盘价的数据框子集，返回DataFrame

df.loc[df['证券简称'].str.contains('电子'), ['证券代码', '证券简称', '交易日期', '日收盘价']]
```

> Out[23]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

上面代码中对于行的筛选条件中，需要先将证券简称列转换为字符串，然后再应用contains方法，返回布尔数组结果。  

- 筛选日期从2020-02-01开始后的20天内，列标签为证券代码、证券简称、交易日期、日收盘价的数据框子集。

为了实现日期筛选，我们首先需要看下“交易日期”列的数据类型，并转换为日期类型，从而运用日期运算符。

> In[32]: 

```python
## 查看字段类型
df.dtypes
```

> Out[32]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|


由于交易日期为object类型，我们需要先转换日期类型，再运用日期加减法筛选符合上述条件的数据。  

> In[33]: 

```python
## 引入日期模块
import datetime as dt

## 转换交易日期字段类型
df['交易日期'] = pd.to_datetime(df['交易日期'])

## 开始日期
st_date = pd.datetime(2020, 2, 1)
## 结束日期
nd_date = st_date + dt.timedelta(days=20)

## 筛选数据
df.loc[(df['交易日期'] >= st_date) & (df['交易日期'] <= nd_date), ['证券代码', '证券简称', '交易日期', '日收盘价']]
```

> Out[33]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

上面代码中应用了多条件筛选格式，逻辑运算符为&，同时需要用括号分开各个条件表达式。如果是或运算，则为|；如果是非运算，则为~。

上面各种逻辑筛选均是给.loc传入了布尔数组，事实上，我们还可以直接传入长度等于数据框行或列的布尔数组来实现行货列的筛选。例如：如果我们想要筛选出奇数行，方式如下：

> In[39]: 

```python
## 构造布尔数组
mask = [True if i%2 == 0 else False for i in range(len(df))]

df.loc[mask, :]
```

> Out[39]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

#### 2.3 随机筛选

基本筛选和逻辑筛选构成我们筛选数据的主要方式。个别场景下，我们需要随机筛选一些数据来查看数据情况，这时可借助random模块来实现。例如：如果想要随机筛选出10只股票，方式如下：

> In[42]: 

```python
## 导入包
import random

## 随机选择十只股票
codes = []
while True:
    code = random.choice(df['证券代码'])
    if not code in codes:
        codes.append(code)
    
    if len(codes) == 10:
        break

print('十只股票代码为：{}'.format(codes))
```

> In[44]: 

```python
## 筛选出上述十只股票的数据，返回DataFrame
df.loc[df['证券代码'].isin(codes), :]
```

> Out[44]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

### 三、基于位置的筛选（Selection by Position）

基于位置的筛选方式为.iloc[row_indexer, column_indexer]，索引器接受整数，也接受布尔数组。由于逻辑筛选和随机筛选的方式与基于标签的筛选一样，这里不再赘述。下面仅就基于整数位置索引的方式讲解。

- 筛选前5行，返回数据框。

> In[46]: 

```python
## 筛选前5行，返回DataFrame
df.iloc[:6,:]
```

> Out[46]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

这里行索引器中，不包含最后一个数值的行（第6行），即含开始，不含结束。  

- 筛选第2至第6行，第1至第3列。

> In[47]: 

```python
## 筛选第2至第6行，第1至第3列，返回DataFrame
df.iloc[2:7, 1:4]
```

> Out[47]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

一般情况下，我会使用.iloc方法筛选前若干行或后若干行。比如：筛选除第一行外的剩下行：df.iloc[1:, :]；筛选第5行：df.iloc[4]；筛选第1、3、5行：df.iloc[[0, 2, 4], :]

### 四、基于可调用函数的筛选（Selection by Callable）

无论是.loc还是.iloc方法，都可以接受一个可调用函数作为索引器。该函数可接受一个Series或DataFrame作为输入参数，并且返回有效的索引。

- 筛选证券代码、证券简称、交易日期列。

> In[48]: 

```python
## 筛选证券代码、证券简称、交易日期列
df.loc[:, lambda df: ['证券代码', '证券简称', '交易日期']]
```

> Out[48]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

- 筛选日涨幅超过5%的所有行。

> In[49]: 

```python
## 筛选日涨幅超过5%的所有行，返回DataFrame
df.loc[lambda df: df['日收盘价'] >= (1+0.05)*df['日开盘价'], :]
```

> Out[49]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

### 五、其他筛选方法

#### 5.1 isin

选择某列等于多个数值或字符串时，可使用isin方法。如：筛选中微公司和奥普特公司股票数据，方式如下：

> In[51]: 

```python
## 筛选中微公司和奥普特公司股票数据，返回DataFrame
df.loc[df['证券简称'].isin(['中微公司', '奥普特']), :]
```

> Out[51]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

#### 5.2 contains

筛选某列包含某个字符串的行，该方法前面已讲述过，这里不再举例。

#### 5.3 isnull

筛选为空或为不为空的行。

> In[52]: 

```python
## 筛选证券代码不为空的行
df.loc[df['证券代码'].isnull(), :]
```

> Out[52]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

#### 5.4 where

为了使得筛选结果与原始结果拥有相同的大小，我们可以使用where进行筛选。

> In[56]: 

```python
## 筛选日收盘价大于50的行，其他记录均填为NaN
df.where(df['日收盘价'] > 50)
```

> Out[56]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

采用该方法返回的结果数据框大小与原始数据框大小相同。我们也可以传入第二个参数指定不符合条件的单元格替代的值。

#### 5.5 apply

运用apply可对列或行进行更为复杂的数学运算。如：根据收盘价对数据进行分段，类似SQL中的case when，方法如下：

> In[58]: 

```python
## 增加一列，对日收盘价进行分段
def map_func(price):
    if price < 50:
        return 1
    elif price < 100:
        return 2
    else:
        return 3
    
d = df['日收盘价'].apply(map_func)
```

> Out[58]:

|序号|证券代码|证券简称|交易日期|日开盘价|日最高价|日最低价|日收盘价|日交易股数|日交易金额|流通市值|总市值|流通股数|市净率|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

以上就是Pandas中DataFrame的数据筛选常见方法了。